<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ParaGames ‚Äî Play Free Games</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0c0b08;--surf:#161410;--surf2:#1e1c12;--surf3:#252218;
  --bord:#2a2618;--bord2:#363220;
  --txt:#ede7cc;--mut:#857d5f;--mut2:#5a5440;
  --gold:#c9a84c;--gold2:#e8c46a;--gold3:#f5d980;--gold4:#6e5820;
  --red:#e84040;--grn:#38a838;--blu:#4080e0;
  --glow:rgba(201,168,76,0.15);--R:14px;
  --font-head:'Syne',sans-serif;--font-body:'DM Sans',sans-serif;
}
html{scroll-behavior:smooth}
body{font-family:var(--font-body);background:var(--bg);color:var(--txt);min-height:100vh;overflow-x:hidden}

/* ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ */
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--bord2);border-radius:3px}

/* ‚îÄ‚îÄ VORTEX ‚îÄ‚îÄ */
#vortexCanvas{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:0;opacity:0.55}
/* DROPDOWN */
.dropdown{position:relative;z-index:600}
.dropdown-menu{display:none;position:absolute;top:calc(100% + 8px);right:0;background:rgba(18,16,10,.98);border:1px solid var(--bord2);border-radius:14px;min-width:190px;padding:6px;backdrop-filter:blur(20px);box-shadow:0 16px 48px rgba(0,0,0,.7)}
.dropdown-menu.open{display:block}
.dd-item{display:flex;align-items:center;gap:9px;padding:9px 13px;border-radius:8px;cursor:pointer;font-size:13px;color:var(--mut);transition:all .12s;white-space:nowrap}
.dd-item:hover{background:var(--surf2);color:var(--txt)}
.dd-sep{height:1px;background:var(--bord);margin:4px 6px}
.nav-btn-fs{display:flex;align-items:center;gap:5px;background:var(--surf);border:1px solid var(--bord2);border-radius:18px;padding:5px 12px;cursor:pointer;color:var(--mut);font-size:12px;font-weight:600;transition:all .15s;white-space:nowrap}
.nav-btn-fs:hover{color:var(--txt);border-color:var(--gold4)}

/* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
nav{display:flex;align-items:center;gap:12px;padding:0 28px;height:58px;border-bottom:1px solid var(--bord);position:sticky;top:0;background:rgba(12,11,8,.95);backdrop-filter:blur(24px);z-index:500}
.logo{font-family:var(--font-head);font-weight:800;font-size:19px;text-decoration:none;color:var(--gold2);display:flex;align-items:center;gap:9px;cursor:pointer;flex-shrink:0;position:relative;z-index:1}
.logo-ic{width:30px;height:30px;background:linear-gradient(135deg,var(--gold),#9a7010);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:15px;position:relative;z-index:2}
.nav-spacer{flex:1}
.nav-search{display:flex;align-items:center;background:var(--surf);border:1px solid var(--bord2);border-radius:22px;padding:7px 16px;gap:8px;max-width:280px;width:100%;transition:all .18s;position:relative;z-index:1}
.nav-search:focus-within{border-color:var(--gold4);box-shadow:0 0 0 3px var(--glow)}
.nav-search input{background:none;border:none;outline:none;color:var(--txt);font-family:inherit;font-size:13px;width:100%}
.nav-search input::placeholder{color:var(--mut)}
.nav-back{display:none;align-items:center;gap:6px;background:var(--surf);border:1px solid var(--bord2);border-radius:20px;padding:6px 14px;cursor:pointer;color:var(--mut);font-size:13px;font-weight:600;transition:all .15s}
.nav-back:hover{color:var(--txt)}
.nav-game-name{display:none;font-family:var(--font-head);font-weight:700;font-size:15px;color:var(--gold2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:200px}
.nav-pause{display:none;align-items:center;gap:6px;background:var(--surf2);border:1px solid var(--bord2);border-radius:20px;padding:6px 16px;cursor:pointer;color:var(--mut);font-size:13px;font-weight:600;transition:all .15s;margin-left:auto}
.nav-pause:hover{color:var(--txt);border-color:var(--gold4)}

/* ‚îÄ‚îÄ HOME HERO ‚îÄ‚îÄ */
.hero{text-align:center;padding:60px 24px 44px;position:relative;overflow:hidden;z-index:1}
.hero-bg{position:absolute;inset:0;background:radial-gradient(ellipse at 50% 0%,rgba(201,168,76,.09) 0%,transparent 60%);pointer-events:none}
.hero-word{font-family:var(--font-head);font-weight:800;font-size:72px;letter-spacing:-4px;line-height:1;margin-bottom:12px;background:linear-gradient(145deg,var(--gold3) 0%,var(--gold) 50%,#7a5a14 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.hero-sub{color:var(--mut);font-size:14px;margin-bottom:0}.hero-sub b{color:var(--gold);font-weight:600}
.hero-stats{display:flex;align-items:center;justify-content:center;gap:24px;margin-top:20px;flex-wrap:wrap}
.stat{text-align:center}
.stat-n{font-family:var(--font-head);font-size:22px;font-weight:800;color:var(--gold2)}
.stat-l{font-size:11px;color:var(--mut);text-transform:uppercase;letter-spacing:.8px}

/* ‚îÄ‚îÄ TRENDING CAROUSEL ‚îÄ‚îÄ */
.trending{padding:0 28px 36px;max-width:1320px;margin:0 auto;position:relative;z-index:1}
.sec-label{display:flex;align-items:center;gap:10px;margin-bottom:16px}
.sec-label h2{font-family:var(--font-head);font-size:11px;font-weight:700;color:var(--mut);letter-spacing:2px;text-transform:uppercase;white-space:nowrap}
.sec-label-line{flex:1;height:1px;background:var(--bord)}
.sec-label .cnt{font-size:11px;font-weight:600;color:var(--mut);background:var(--surf);border:1px solid var(--bord);padding:3px 10px;border-radius:20px}

.trend-card{border-radius:18px;border:1px solid var(--bord2);overflow:hidden;position:relative;cursor:pointer;height:200px;display:flex;align-items:flex-end;transition:transform .2s,box-shadow .2s}
.trend-card:hover{transform:scale(1.01);box-shadow:0 16px 48px rgba(0,0,0,.7)}
.trend-bg{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:90px;filter:blur(0px)}
.trend-overlay{position:absolute;inset:0;background:linear-gradient(to top,rgba(12,11,8,.95) 0%,rgba(12,11,8,.3) 60%,transparent 100%)}
.trend-content{position:relative;z-index:2;padding:20px 24px;width:100%}
.trend-badge{display:inline-block;background:var(--gold);color:#0c0b08;font-size:10px;font-weight:800;padding:3px 10px;border-radius:20px;text-transform:uppercase;letter-spacing:.8px;margin-bottom:8px}
.trend-title{font-family:var(--font-head);font-size:26px;font-weight:800;color:var(--txt);margin-bottom:4px}
.trend-desc{font-size:13px;color:var(--mut);margin-bottom:12px}
.trend-play{display:inline-flex;align-items:center;gap:7px;background:var(--gold);color:#0c0b08;border:none;padding:9px 20px;border-radius:24px;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit;transition:all .15s}
.trend-play:hover{background:var(--gold2);transform:scale(1.04)}
.trend-dots{display:flex;justify-content:center;gap:6px;margin-top:12px}
.trend-dot{width:6px;height:6px;border-radius:3px;background:var(--bord2);cursor:pointer;transition:all .3s}
.trend-dot.active{width:20px;background:var(--gold)}

/* ‚îÄ‚îÄ CATEGORY PILLS ‚îÄ‚îÄ */
.cats{display:flex;gap:6px;flex-wrap:wrap;padding:0 28px 32px;max-width:1320px;margin:0 auto;position:relative;z-index:1}
.pill{padding:7px 15px;border-radius:20px;font-size:11px;font-weight:700;border:1px solid var(--bord);cursor:pointer;transition:all .15s;background:transparent;color:var(--mut);text-transform:uppercase;letter-spacing:.4px;user-select:none;white-space:nowrap}
.pill:hover{border-color:var(--gold4);color:var(--gold);background:var(--glow)}
.pill.active{background:var(--gold);color:#0c0b08;border-color:var(--gold)}

/* ‚îÄ‚îÄ GAME GRID ‚îÄ‚îÄ */
.sec{max-width:1320px;margin:0 auto;padding:0 28px 80px;position:relative;z-index:1}
.ggrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(175px,1fr));gap:12px}

/* ‚îÄ‚îÄ GAME CARD ‚îÄ‚îÄ */
.gcard{border-radius:var(--R);border:1px solid var(--bord);background:var(--surf);overflow:hidden;cursor:pointer;transition:transform .2s,box-shadow .2s,border-color .2s;position:relative}
.gcard:hover{transform:translateY(-4px);box-shadow:0 14px 44px rgba(0,0,0,.65),0 0 0 1px var(--bord2);border-color:var(--bord2)}
.gthumb{width:100%;aspect-ratio:16/9;position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center}
.gthumb-img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:0.18;transition:opacity .2s}
.gcard:hover .gthumb-img{opacity:0.28}
.gthumb-bg{position:absolute;inset:0}
.gthumb-emoji{position:relative;z-index:1;font-size:46px;transition:transform .2s;filter:drop-shadow(0 4px 14px rgba(0,0,0,.6))}
.gcard:hover .gthumb-emoji{transform:scale(1.1)}
.badge-new{position:absolute;top:8px;right:8px;background:var(--red);color:#fff;font-size:9px;font-weight:800;padding:2px 8px;border-radius:10px;z-index:3;text-transform:uppercase;letter-spacing:.5px}
.badge-hot{position:absolute;top:8px;right:8px;background:var(--gold);color:#0c0b08;font-size:9px;font-weight:800;padding:2px 8px;border-radius:10px;z-index:3;text-transform:uppercase;letter-spacing:.5px}
.badge-2p{position:absolute;top:8px;left:8px;background:var(--blu);color:#fff;font-size:9px;font-weight:800;padding:2px 8px;border-radius:10px;z-index:3;text-transform:uppercase;letter-spacing:.5px}
.pring{position:absolute;inset:0;z-index:2;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .18s}
.pcirc{width:44px;height:44px;background:var(--gold);border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 0 0 8px rgba(201,168,76,.2)}
.gcard:hover .pring{opacity:1}
.ginf{padding:10px 12px 12px;border-top:1px solid var(--bord)}
.gname{font-size:13px;font-weight:600;margin-bottom:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.gbot{display:flex;align-items:center;justify-content:space-between}
.gcat{font-size:10px;color:var(--mut);text-transform:uppercase;letter-spacing:.5px;font-weight:600}
.garr{font-size:10px;color:var(--gold4);font-weight:700;transition:color .15s}
.gcard:hover .garr{color:var(--gold)}
.nores{display:none;text-align:center;padding:80px 24px;color:var(--mut)}
.nores.show{display:block}

/* ‚îÄ‚îÄ GAME SCREEN ‚îÄ‚îÄ */
#GS{display:none;position:fixed;top:58px;left:0;right:0;bottom:0;background:var(--bg);z-index:400;flex-direction:column}
#GS.open{display:flex}
.gs-body{flex:1;display:flex;align-items:center;justify-content:center;overflow:auto;position:relative}

/* ‚îÄ‚îÄ OVERLAYS ‚îÄ‚îÄ */
.g-overlay{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(8,7,4,.9);backdrop-filter:blur(8px);z-index:50;gap:8px;padding:24px}
.g-overlay h2{font-family:var(--font-head);font-size:36px;font-weight:800;color:var(--gold2);margin-bottom:4px;text-align:center}
.g-overlay .sub{color:var(--mut);font-size:14px;text-align:center;margin-bottom:10px}
.g-overlay .score-row{font-family:var(--font-head);font-size:20px;color:var(--gold);margin-bottom:4px}
.ov-btns{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:6px}
.btn-gold{background:var(--gold);color:#0c0b08;border:none;padding:12px 30px;border-radius:28px;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit;transition:all .15s}
.btn-gold:hover{background:var(--gold2);transform:scale(1.04)}
.btn-out{background:transparent;color:var(--mut);border:1px solid var(--bord2);padding:12px 22px;border-radius:28px;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;transition:all .15s}
.btn-out:hover{color:var(--txt);border-color:var(--gold4)}

/* ‚îÄ‚îÄ HUD ‚îÄ‚îÄ */
.hud-row{display:flex;gap:10px;padding:10px 20px 0;flex-shrink:0;flex-wrap:wrap;justify-content:center}
.hb{background:rgba(12,11,8,.85);border:1px solid var(--bord2);border-radius:10px;padding:5px 14px;text-align:center}
.hl{font-size:9px;color:var(--mut);text-transform:uppercase;letter-spacing:1px;font-weight:600}
.hv{font-family:var(--font-head);font-size:20px;font-weight:700;color:var(--gold2);line-height:1.2}

/* 2048 */
#b2048{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;background:#161410;padding:10px;border-radius:12px;touch-action:none}
.tile{width:88px;height:88px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-family:var(--font-head);font-weight:800;font-size:26px;background:#2a2618;color:var(--mut)}
.t2{background:#3a2e14;color:#f0d080}.t4{background:#4a3818;color:#f0d080}.t8{background:#b86c1a;color:#fff}.t16{background:#c05818;color:#fff}.t32{background:#c84010;color:#fff}.t64{background:#d82808;color:#fff}.t128{background:var(--gold);color:#0c0b08;font-size:20px}.t256{background:#d4b050;color:#0c0b08;font-size:20px}.t512{background:#dcc060;color:#0c0b08;font-size:18px}.t1024{background:#e4cc70;color:#0c0b08;font-size:16px}.t2048{background:#f0d880;color:#0c0b08;font-size:16px}

/* MINESWEEPER */
#msG{display:inline-grid;gap:3px;padding:10px;background:#161410;border-radius:12px;border:1px solid var(--bord2)}
.mc{width:36px;height:36px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;cursor:pointer;user-select:none;background:var(--surf2);border:1px solid var(--bord2);font-family:var(--font-head)}
.mc:hover:not(.mr):not(.mf){background:#2e2b1a}.mr{background:#141210;border-color:#201e10;cursor:default}.mhit{background:#6e0000!important}.mf{background:#2a2200}
.m1{color:#4a90d9}.m2{color:#48a848}.m3{color:#d94040}.m4{color:#3030a8}.m5{color:#a02020}.m6{color:#30a0a0}.m7{color:var(--gold)}.m8{color:#808080}

/* CONNECT 4 */
#c4board{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;background:#161410;padding:10px;border-radius:14px;border:1px solid var(--bord2)}
.c4cell{width:54px;height:54px;border-radius:50%;background:#0c0b08;border:2px solid var(--bord);cursor:pointer;transition:all .1s}
.c4cell:hover{border-color:var(--gold4)}.c4r{background:radial-gradient(circle at 35% 35%,#ff6060,#c82020)}.c4y{background:radial-gradient(circle at 35% 35%,var(--gold2),var(--gold4))}

/* WORDLE */
#wgrid{display:flex;flex-direction:column;gap:6px;margin:10px 0}
.wrow{display:flex;gap:6px}
.wletter{width:54px;height:54px;border:2px solid var(--bord2);border-radius:8px;display:flex;align-items:center;justify-content:center;font-family:var(--font-head);font-size:22px;font-weight:800;color:var(--txt);text-transform:uppercase;transition:all .15s;background:var(--surf)}
.wletter.correct{background:#38a838;border-color:#38a838;color:#fff}.wletter.present{background:#b8960a;border-color:#b8960a;color:#fff}.wletter.absent{background:#3a3820;border-color:#3a3820;color:var(--mut)}.wletter.cur{border-color:var(--gold)}
.wkb{display:flex;flex-direction:column;gap:5px;align-items:center}
.wkrow{display:flex;gap:4px}
.wk{min-width:34px;height:44px;padding:0 6px;background:var(--surf2);border:1px solid var(--bord2);border-radius:7px;display:flex;align-items:center;justify-content:center;font-family:var(--font-head);font-size:12px;font-weight:700;color:var(--txt);cursor:pointer;transition:background .1s;user-select:none}
.wk:hover{background:#2e2b1a}.wk.wc{background:#38a838;border-color:#38a838}.wk.wp{background:#b8960a;border-color:#b8960a}.wk.wa{background:#3a3820;border-color:#3a3820;color:var(--mut)}.wk.wide{min-width:54px;font-size:11px}

/* TRIVIA */
.trivia-q{font-family:var(--font-head);font-size:20px;font-weight:700;color:var(--txt);text-align:center;margin-bottom:20px;line-height:1.4;max-width:500px}
.trivia-opts{display:flex;flex-direction:column;gap:10px;width:100%;max-width:480px}
.trivia-opt{background:var(--surf2);border:2px solid var(--bord2);border-radius:12px;padding:14px 18px;cursor:pointer;font-size:14px;font-weight:500;color:var(--txt);transition:all .15s;text-align:left}
.trivia-opt:hover:not(.locked){border-color:var(--gold4);background:var(--surf3)}
.trivia-opt.correct{border-color:#38a838;background:rgba(56,168,56,.15);color:#38a838}
.trivia-opt.wrong{border-color:#e84040;background:rgba(232,64,64,.12);color:#e84040}
.trivia-prog{width:100%;max-width:480px;height:4px;background:var(--bord);border-radius:2px;overflow:hidden;margin-bottom:16px}
.trivia-prog-fill{height:100%;background:var(--gold);border-radius:2px;transition:width .3s}

/* TYPING */
.ty-text-wrap{background:var(--surf);border:1px solid var(--bord2);border-radius:12px;padding:20px 24px;font-family:var(--font-body);font-size:17px;line-height:1.9;color:var(--mut);letter-spacing:.3px;min-height:90px;max-width:620px;width:100%}
.ty-c{color:var(--grn)}.ty-e{color:var(--red);text-decoration:underline}.ty-cur{border-left:2px solid var(--gold2)}

/* FOOTER */
footer{border-top:1px solid var(--bord);padding:22px 24px;text-align:center;font-size:12px;color:var(--mut);position:relative;z-index:1}
footer a{color:var(--gold4);text-decoration:none}

@media(max-width:680px){
  .hero-word{font-size:46px;letter-spacing:-2px}
  nav{padding:0 14px;gap:8px}.nav-search{max-width:160px}
  .ggrid{grid-template-columns:repeat(auto-fill,minmax(145px,1fr));gap:10px}
  .tile{width:70px;height:70px;font-size:20px}
  .mc{width:28px;height:28px;font-size:11px}
  .c4cell{width:40px;height:40px}
  .wletter{width:44px;height:44px;font-size:18px}
  .trending,.cats,.sec{padding-left:14px;padding-right:14px}
}

/* ‚ïê‚ïê LOGIN SCREEN ‚ïê‚ïê */
#loginScreen{position:fixed;inset:0;z-index:9999;background:var(--bg);display:flex;align-items:center;justify-content:center;overflow-y:auto;padding:20px}
#loginScreen .login-box{background:var(--surf);border:1px solid var(--bord2);border-radius:24px;width:100%;max-width:420px;padding:36px 36px 32px;position:relative;box-shadow:0 32px 80px rgba(0,0,0,.8),0 0 0 1px rgba(201,168,76,.06)}
#loginScreen .login-logo{text-align:center;margin-bottom:24px}
#loginScreen .login-logo .logo-ic{width:52px;height:52px;border-radius:16px;background:linear-gradient(135deg,var(--gold),#9a7010);display:flex;align-items:center;justify-content:center;font-size:26px;margin:0 auto 10px}
#loginScreen .login-logo h1{font-family:var(--font-head);font-size:26px;font-weight:800;color:var(--gold2);margin-bottom:2px}
#loginScreen .login-logo p{color:var(--mut);font-size:13px}
.login-tabs{display:flex;background:var(--surf2);border-radius:12px;padding:3px;margin-bottom:22px;gap:2px}
.login-tab{flex:1;padding:8px;text-align:center;font-size:12px;font-weight:700;color:var(--mut);border-radius:9px;cursor:pointer;transition:all .15s;user-select:none}
.login-tab.active{background:var(--gold);color:#0c0b08}
.login-field{margin-bottom:14px}
.login-field label{display:block;font-size:11px;font-weight:700;color:var(--mut);text-transform:uppercase;letter-spacing:.8px;margin-bottom:5px}
.login-input{width:100%;background:var(--surf2);border:1px solid var(--bord2);border-radius:10px;padding:11px 14px;color:var(--txt);font-family:inherit;font-size:14px;outline:none;transition:border-color .15s}
.login-input:focus{border-color:var(--gold4);box-shadow:0 0 0 3px var(--glow)}
.login-input::placeholder{color:var(--mut2)}
.login-err{color:var(--red);font-size:12px;margin-top:-8px;margin-bottom:10px;min-height:16px}
.btn-login{width:100%;background:var(--gold);color:#0c0b08;border:none;padding:13px;border-radius:12px;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit;transition:all .15s;margin-top:4px}
.btn-login:hover{background:var(--gold2);transform:scale(1.01)}
.login-divider{display:flex;align-items:center;gap:10px;margin:16px 0}
.login-divider span{color:var(--mut);font-size:11px;white-space:nowrap}
.login-divider::before,.login-divider::after{content:'';flex:1;height:1px;background:var(--bord)}
.btn-guest{width:100%;background:transparent;color:var(--mut);border:1px solid var(--bord2);padding:11px;border-radius:12px;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;transition:all .15s}
.btn-guest:hover{color:var(--txt);border-color:var(--gold4)}
.login-avatar-grid{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin:10px 0 16px}
.av-opt{width:46px;height:46px;border-radius:12px;border:2px solid var(--bord2);display:flex;align-items:center;justify-content:center;font-size:24px;cursor:pointer;transition:all .15s;background:var(--surf2)}
.av-opt:hover{border-color:var(--gold4)}
.av-opt.sel{border-color:var(--gold);background:rgba(201,168,76,.12)}

/* ‚ïê‚ïê PROFILE MODAL ‚ïê‚ïê */
#profileModal{display:none;position:fixed;inset:0;z-index:8000;background:rgba(0,0,0,.7);backdrop-filter:blur(6px);align-items:center;justify-content:center;padding:20px;overflow-y:auto}
#profileModal.open{display:flex}
.profile-box{background:var(--surf);border:1px solid var(--bord2);border-radius:24px;width:100%;max-width:520px;overflow:hidden;box-shadow:0 32px 80px rgba(0,0,0,.8)}
.profile-header{background:linear-gradient(135deg,var(--surf2),var(--surf3));border-bottom:1px solid var(--bord);padding:20px 24px;display:flex;align-items:center;gap:14px}
.profile-avatar-big{width:60px;height:60px;border-radius:18px;border:2px solid var(--bord2);display:flex;align-items:center;justify-content:center;font-size:34px;background:var(--surf);flex-shrink:0}
.profile-info h2{font-family:var(--font-head);font-size:20px;font-weight:800;color:var(--gold2)}
.profile-info p{font-size:12px;color:var(--mut);margin-top:2px}
.profile-tabs{display:flex;border-bottom:1px solid var(--bord);background:var(--surf)}
.ptab{padding:12px 18px;font-size:12px;font-weight:700;color:var(--mut);cursor:pointer;border-bottom:2px solid transparent;transition:all .15s;text-transform:uppercase;letter-spacing:.6px}
.ptab.active{color:var(--gold);border-bottom-color:var(--gold)}
.ptab:hover:not(.active){color:var(--txt)}
.profile-body{padding:22px 24px;min-height:260px;max-height:420px;overflow-y:auto}
.pfield{margin-bottom:16px}
.pfield label{display:block;font-size:11px;font-weight:700;color:var(--mut);text-transform:uppercase;letter-spacing:.8px;margin-bottom:5px}
.pinput{width:100%;background:var(--surf2);border:1px solid var(--bord2);border-radius:10px;padding:10px 12px;color:var(--txt);font-family:inherit;font-size:13px;outline:none;transition:border-color .15s}
.pinput:focus{border-color:var(--gold4)}
.stat-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px}
.stat-box{background:var(--surf2);border:1px solid var(--bord);border-radius:12px;padding:12px;text-align:center}
.stat-box .sv{font-family:var(--font-head);font-size:20px;font-weight:800;color:var(--gold2)}
.stat-box .sl{font-size:10px;color:var(--mut);text-transform:uppercase;letter-spacing:.6px;margin-top:2px}
.friend-row{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--bord)}
.friend-row:last-child{border-bottom:none}
.fr-av{width:36px;height:36px;border-radius:10px;border:1px solid var(--bord2);display:flex;align-items:center;justify-content:center;font-size:20px;background:var(--surf2);flex-shrink:0}
.fr-info{flex:1;min-width:0}
.fr-name{font-size:13px;font-weight:600;color:var(--txt);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.fr-sub{font-size:11px;color:var(--mut)}
.fr-badge{font-size:10px;font-weight:700;padding:3px 8px;border-radius:8px;background:rgba(56,168,56,.15);color:var(--grn);border:1px solid rgba(56,168,56,.2)}
.btn-rm-fr{background:transparent;border:1px solid var(--bord2);color:var(--mut);border-radius:8px;padding:4px 10px;font-size:11px;font-weight:600;cursor:pointer;font-family:inherit;transition:all .12s}
.btn-rm-fr:hover{color:var(--red);border-color:var(--red)}
.add-friend-row{display:flex;gap:8px;margin-bottom:16px}
.add-friend-row .pinput{flex:1}
.btn-add-fr{background:var(--gold);color:#0c0b08;border:none;border-radius:10px;padding:10px 16px;font-size:12px;font-weight:700;cursor:pointer;font-family:inherit;white-space:nowrap;transition:all .15s}
.btn-add-fr:hover{background:var(--gold2)}
.games-played-list{display:flex;flex-direction:column;gap:8px}
.gpl-row{display:flex;align-items:center;gap:10px;background:var(--surf2);border:1px solid var(--bord);border-radius:10px;padding:10px 12px}
.gpl-em{font-size:22px;flex-shrink:0}
.gpl-name{font-size:13px;font-weight:600;color:var(--txt);flex:1}
.gpl-plays{font-size:11px;color:var(--gold);font-weight:700}
.profile-footer{padding:14px 24px;border-top:1px solid var(--bord);display:flex;gap:8px;background:var(--surf)}
.btn-save-prof{background:var(--gold);color:#0c0b08;border:none;padding:10px 22px;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit;transition:all .15s}
.btn-save-prof:hover{background:var(--gold2)}
.btn-close-prof{background:transparent;color:var(--mut);border:1px solid var(--bord2);padding:10px 18px;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;transition:all .15s}
.btn-close-prof:hover{color:var(--txt);border-color:var(--gold4)}
.btn-logout{background:transparent;color:var(--mut);border:1px solid var(--bord2);padding:10px 18px;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;transition:all .15s;margin-left:auto}
.btn-logout:hover{color:var(--red);border-color:var(--red)}
/* Nav avatar button */
.nav-avatar{width:34px;height:34px;border-radius:10px;border:1.5px solid var(--bord2);display:flex;align-items:center;justify-content:center;font-size:18px;cursor:pointer;background:var(--surf2);transition:all .15s;flex-shrink:0}
.nav-avatar:hover{border-color:var(--gold4);background:var(--surf3)}
.guest-badge{font-size:10px;font-weight:700;color:var(--mut);background:var(--surf2);border:1px solid var(--bord);padding:3px 8px;border-radius:8px;white-space:nowrap}
/* ‚ïê‚ïê ADMIN ‚ïê‚ïê */
.admin-crown{font-size:10px;font-weight:800;color:#0c0b08;background:linear-gradient(135deg,#ffd700,#ff8c00);border:none;padding:3px 9px;border-radius:8px;white-space:nowrap;letter-spacing:.4px;cursor:pointer}
.ptab.admin-tab.active{color:#0c0b08 !important;border-bottom-color:transparent}
.admin-section-title{font-size:11px;font-weight:800;color:var(--mut);text-transform:uppercase;letter-spacing:1px;margin:14px 0 8px;display:flex;align-items:center;gap:6px}
.admin-user-row{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--surf2);border:1px solid var(--bord);border-radius:12px;margin-bottom:7px}
.admin-user-row.banned{opacity:.55;border-color:rgba(232,64,64,.4);background:rgba(232,64,64,.04)}
.aur-av{width:34px;height:34px;border-radius:9px;border:1px solid var(--bord2);display:flex;align-items:center;justify-content:center;font-size:18px;background:var(--surf);flex-shrink:0}
.aur-info{flex:1;min-width:0}
.aur-name{font-size:13px;font-weight:600;color:var(--txt);display:flex;align-items:center;gap:5px;flex-wrap:wrap}
.aur-sub{font-size:11px;color:var(--mut);margin-top:1px}
.aur-actions{display:flex;gap:5px;flex-shrink:0;flex-wrap:wrap}
.btn-admin-sm{border:1px solid var(--bord2);background:var(--surf);color:var(--mut);border-radius:7px;padding:4px 9px;font-size:11px;font-weight:700;cursor:pointer;font-family:inherit;transition:all .12s;white-space:nowrap}
.btn-admin-sm:hover{color:var(--txt);border-color:var(--gold4)}
.btn-admin-sm.danger:hover{color:var(--red);border-color:var(--red)}
.btn-admin-sm.success:hover{color:var(--grn);border-color:var(--grn)}
.btn-admin-sm.warn:hover{color:#f0a040;border-color:#f0a040}
.role-badge{font-size:9px;font-weight:800;padding:2px 7px;border-radius:6px;letter-spacing:.4px;text-transform:uppercase}
.role-owner{background:linear-gradient(135deg,rgba(255,215,0,.2),rgba(255,140,0,.2));color:#ffd700;border:1px solid rgba(255,215,0,.4)}
.role-admin{background:rgba(64,128,224,.15);color:#80b0ff;border:1px solid rgba(64,128,224,.3)}
.role-banned{background:rgba(232,64,64,.15);color:var(--red);border:1px solid rgba(232,64,64,.3)}
.admin-stat-row{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap}
.admin-stat{flex:1;min-width:80px;background:var(--surf2);border:1px solid var(--bord);border-radius:10px;padding:10px 12px;text-align:center}
.admin-stat .asv{font-family:var(--font-head);font-size:22px;font-weight:800;color:var(--gold2)}
.admin-stat .asl{font-size:10px;color:var(--mut);text-transform:uppercase;letter-spacing:.6px;margin-top:2px}
.admin-toast{position:fixed;bottom:24px;right:24px;background:linear-gradient(135deg,#1a1500,#2a2000);border:1px solid var(--gold4);border-radius:12px;padding:12px 18px;font-size:13px;font-weight:600;color:var(--gold2);z-index:99999;box-shadow:0 8px 32px rgba(0,0,0,.7);display:none;align-items:center;gap:8px;max-width:300px}
.admin-toast.show{display:flex}
/* ‚ïê‚ïê LEADERBOARD ‚ïê‚ïê */
#lbModal{display:none;position:fixed;inset:0;z-index:8500;background:rgba(0,0,0,.75);backdrop-filter:blur(8px);align-items:center;justify-content:center;padding:20px;overflow-y:auto}
#lbModal.open{display:flex}
.lb-box{background:var(--surf);border:1px solid var(--bord2);border-radius:24px;width:100%;max-width:580px;overflow:hidden;box-shadow:0 32px 80px rgba(0,0,0,.85)}
.lb-header{background:linear-gradient(135deg,rgba(201,168,76,.12),rgba(232,196,106,.06));border-bottom:1px solid var(--bord);padding:20px 24px;display:flex;align-items:center;gap:12px}
.lb-header h2{font-family:var(--font-head);font-size:20px;font-weight:800;color:var(--gold2);flex:1}
.lb-close{background:none;border:1px solid var(--bord2);color:var(--mut);cursor:pointer;font-size:13px;padding:6px 12px;border-radius:8px;transition:all .12s;font-family:inherit;font-weight:600}
.lb-close:hover{color:var(--txt);border-color:var(--gold4)}
.lb-controls{display:flex;gap:6px;padding:14px 24px;border-bottom:1px solid var(--bord);background:var(--surf);flex-wrap:wrap}
.lb-pill{padding:6px 14px;border-radius:20px;font-size:11px;font-weight:700;border:1px solid var(--bord);cursor:pointer;transition:all .15s;background:transparent;color:var(--mut);text-transform:uppercase;letter-spacing:.4px;user-select:none;white-space:nowrap}
.lb-pill:hover{border-color:var(--gold4);color:var(--gold)}
.lb-pill.active{background:var(--gold);color:#0c0b08;border-color:var(--gold)}
.lb-game-sel{background:var(--surf2);border:1px solid var(--bord2);color:var(--txt);border-radius:10px;padding:6px 10px;font-size:12px;font-family:inherit;outline:none;cursor:pointer;margin-left:auto}
.lb-game-sel:focus{border-color:var(--gold4)}
.lb-body{padding:16px 24px 20px;min-height:200px;max-height:460px;overflow-y:auto}
.lb-empty{text-align:center;padding:48px 20px;color:var(--mut)}
.lb-empty div{font-size:44px;margin-bottom:12px}
.lb-row{display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:12px;margin-bottom:6px;border:1px solid transparent;transition:background .12s}
.lb-row:hover{background:var(--surf2)}
.lb-row.top1{background:linear-gradient(135deg,rgba(255,215,0,.08),rgba(255,180,0,.04));border-color:rgba(255,215,0,.2)}
.lb-row.top2{background:linear-gradient(135deg,rgba(180,180,200,.06),rgba(160,160,180,.03));border-color:rgba(180,180,200,.15)}
.lb-row.top3{background:linear-gradient(135deg,rgba(180,120,60,.07),rgba(160,100,40,.03));border-color:rgba(180,120,60,.15)}
.lb-rank{font-family:var(--font-head);font-size:16px;font-weight:800;width:28px;text-align:center;flex-shrink:0}
.lb-av{width:36px;height:36px;border-radius:10px;background:var(--surf2);border:1px solid var(--bord2);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
.lb-info{flex:1;min-width:0}
.lb-name{font-size:13px;font-weight:600;color:var(--txt);display:flex;align-items:center;gap:5px}
.lb-sub{font-size:11px;color:var(--mut);margin-top:1px}
.lb-score{font-family:var(--font-head);font-size:16px;font-weight:800;color:var(--gold2);flex-shrink:0}
.lb-score-label{font-size:9px;color:var(--mut);text-align:right;text-transform:uppercase;letter-spacing:.5px;margin-top:1px}
.lb-me{background:rgba(201,168,76,.06) !important;border-color:rgba(201,168,76,.25) !important}
.nav-lb-btn{display:flex;align-items:center;gap:5px;background:var(--surf);border:1px solid var(--bord2);border-radius:18px;padding:5px 12px;cursor:pointer;color:var(--mut);font-size:12px;font-weight:600;transition:all .15s;white-space:nowrap}
.nav-lb-btn:hover{color:var(--txt);border-color:var(--gold4)}
#gameAdminBtn{position:absolute;top:10px;right:10px;z-index:300;background:linear-gradient(135deg,#ffd700,#ff8c00);border:none;border-radius:10px;padding:6px 12px;font-size:11px;font-weight:800;color:#0c0b08;cursor:pointer;font-family:var(--font-body);letter-spacing:.4px;box-shadow:0 4px 16px rgba(255,180,0,.35);transition:all .15s;display:none}
#gameAdminBtn:hover{transform:scale(1.05);box-shadow:0 6px 20px rgba(255,180,0,.5)}
#gameAdminPanel{position:absolute;top:46px;right:10px;z-index:300;background:rgba(14,13,9,.97);border:1px solid rgba(255,215,0,.25);border-radius:16px;width:280px;backdrop-filter:blur(20px);box-shadow:0 16px 48px rgba(0,0,0,.8);display:none;flex-direction:column;overflow:hidden}
#gameAdminPanel.open{display:flex}
.gap-header{background:linear-gradient(135deg,rgba(255,215,0,.12),rgba(255,140,0,.06));border-bottom:1px solid rgba(255,215,0,.15);padding:12px 14px;display:flex;align-items:center;gap:8px}
.gap-header span{font-family:var(--font-head);font-size:13px;font-weight:800;color:#ffd700;flex:1}
.gap-close{background:none;border:none;color:var(--mut);cursor:pointer;font-size:14px;padding:2px 6px;border-radius:6px;transition:color .12s}
.gap-close:hover{color:var(--txt)}
.gap-body{padding:12px 14px;display:flex;flex-direction:column;gap:8px;max-height:380px;overflow-y:auto}
.gap-section{font-size:10px;font-weight:800;color:var(--mut);text-transform:uppercase;letter-spacing:1px;margin-top:4px}
.gap-row{display:flex;align-items:center;gap:8px}
.gap-row label{font-size:12px;color:var(--txt);flex:1}
.gap-row input[type=range]{flex:1;accent-color:var(--gold);height:4px}
.gap-row input[type=number]{width:60px;background:var(--surf2);border:1px solid var(--bord2);border-radius:6px;padding:4px 7px;color:var(--txt);font-family:inherit;font-size:12px;outline:none}
.gap-toggle{width:36px;height:20px;background:var(--surf2);border:1px solid var(--bord2);border-radius:10px;cursor:pointer;position:relative;transition:background .15s;flex-shrink:0}
.gap-toggle.on{background:var(--gold)}
.gap-toggle::after{content:'';position:absolute;top:2px;left:2px;width:14px;height:14px;border-radius:7px;background:#fff;transition:left .15s}
.gap-toggle.on::after{left:18px}
.gap-btn{background:var(--surf2);border:1px solid var(--bord2);color:var(--mut);border-radius:8px;padding:6px 10px;font-size:11px;font-weight:700;cursor:pointer;font-family:inherit;transition:all .12s;text-align:left;width:100%}
.gap-btn:hover{color:var(--txt);border-color:var(--gold4)}
.gap-btn.danger:hover{color:var(--red);border-color:var(--red)}
.gap-divider{height:1px;background:var(--bord);margin:2px 0}
/* ‚ïê‚ïê MESSAGING SYSTEM ‚ïê‚ïê */
#msgModal{display:none;position:fixed;inset:0;z-index:8600;background:rgba(0,0,0,.75);backdrop-filter:blur(8px);align-items:center;justify-content:center;padding:20px}
#msgModal.open{display:flex}
.msg-box{background:var(--surf);border:1px solid var(--bord2);border-radius:24px;width:100%;max-width:700px;height:560px;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 32px 80px rgba(0,0,0,.85)}
.msg-header{background:linear-gradient(135deg,var(--surf2),var(--surf3));border-bottom:1px solid var(--bord);padding:16px 20px;display:flex;align-items:center;gap:10px;flex-shrink:0}
.msg-header h2{font-family:var(--font-head);font-size:18px;font-weight:800;color:var(--gold2);flex:1}
.msg-unread-badge{background:var(--red);color:#fff;font-size:10px;font-weight:800;padding:2px 7px;border-radius:10px;min-width:18px;text-align:center}
.msg-layout{display:flex;flex:1;overflow:hidden}
.msg-sidebar{width:220px;border-right:1px solid var(--bord);display:flex;flex-direction:column;flex-shrink:0;background:var(--surf)}
.msg-sidebar-header{padding:10px 12px;border-bottom:1px solid var(--bord);display:flex;gap:6px}
.msg-new-btn{flex:1;background:var(--gold);color:#0c0b08;border:none;border-radius:8px;padding:7px;font-size:11px;font-weight:700;cursor:pointer;font-family:inherit;transition:all .15s}
.msg-new-btn:hover{background:var(--gold2)}
.msg-thread-list{flex:1;overflow-y:auto}
.msg-thread{padding:10px 12px;cursor:pointer;border-bottom:1px solid var(--bord);transition:background .1s;position:relative}
.msg-thread:hover{background:var(--surf2)}
.msg-thread.active{background:var(--surf3);border-left:3px solid var(--gold)}
.msg-thread.unread{background:rgba(201,168,76,.05)}
.msg-thread-name{font-size:12px;font-weight:700;color:var(--txt);display:flex;align-items:center;gap:5px;margin-bottom:2px}
.msg-thread-preview{font-size:11px;color:var(--mut);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:170px}
.msg-thread-time{font-size:10px;color:var(--mut2);position:absolute;top:10px;right:10px}
.msg-thread-dot{width:7px;height:7px;border-radius:50%;background:var(--gold);flex-shrink:0}
.msg-content{flex:1;display:flex;flex-direction:column;overflow:hidden}
.msg-chat-header{padding:12px 16px;border-bottom:1px solid var(--bord);display:flex;align-items:center;gap:10px;background:var(--surf);flex-shrink:0}
.msg-chat-av{width:32px;height:32px;border-radius:9px;background:var(--surf2);border:1px solid var(--bord2);display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.msg-chat-name{font-size:14px;font-weight:700;color:var(--txt);flex:1}
.msg-chat-sub{font-size:11px;color:var(--mut)}
.msg-messages{flex:1;overflow-y:auto;padding:14px 16px;display:flex;flex-direction:column;gap:8px}
.msg-bubble-wrap{display:flex;flex-direction:column;max-width:75%}
.msg-bubble-wrap.me{align-self:flex-end;align-items:flex-end}
.msg-bubble-wrap.them{align-self:flex-start;align-items:flex-start}
.msg-bubble{padding:9px 13px;border-radius:14px;font-size:13px;line-height:1.4}
.msg-bubble-wrap.me .msg-bubble{background:var(--gold);color:#0c0b08;border-radius:14px 14px 4px 14px}
.msg-bubble-wrap.them .msg-bubble{background:var(--surf2);color:var(--txt);border:1px solid var(--bord2);border-radius:14px 14px 14px 4px}
.msg-bubble-time{font-size:10px;color:var(--mut2);margin-top:2px;padding:0 2px}
.msg-input-row{padding:12px 16px;border-top:1px solid var(--bord);display:flex;gap:8px;background:var(--surf);flex-shrink:0}
.msg-input{flex:1;background:var(--surf2);border:1px solid var(--bord2);border-radius:20px;padding:9px 14px;color:var(--txt);font-family:inherit;font-size:13px;outline:none;transition:border-color .15s;resize:none;height:38px}
.msg-input:focus{border-color:var(--gold4)}
.msg-send-btn{background:var(--gold);color:#0c0b08;border:none;border-radius:12px;padding:9px 16px;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit;transition:all .15s;flex-shrink:0}
.msg-send-btn:hover{background:var(--gold2)}
.msg-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;color:var(--mut);gap:8px;padding:24px}
.msg-empty div{font-size:40px}
/* Appeal bubble special styling */
.msg-bubble.appeal{background:rgba(64,128,224,.12);border:1px solid rgba(64,128,224,.3);color:var(--txt);border-radius:14px}
.appeal-actions{display:flex;gap:6px;margin-top:6px;flex-wrap:wrap}
.appeal-btn{border:none;border-radius:8px;padding:5px 12px;font-size:11px;font-weight:700;cursor:pointer;font-family:inherit;transition:all .15s}
.appeal-accept{background:rgba(56,168,56,.2);color:var(--grn);border:1px solid rgba(56,168,56,.3)}
.appeal-accept:hover{background:rgba(56,168,56,.35)}
.appeal-decline{background:rgba(232,64,64,.15);color:var(--red);border:1px solid rgba(232,64,64,.3)}
.appeal-decline:hover{background:rgba(232,64,64,.3)}
/* Ban screen */
#banScreen{display:none;position:fixed;inset:0;z-index:9990;background:var(--bg);align-items:center;justify-content:center;padding:20px}
#banScreen.open{display:flex}
.ban-box{background:var(--surf);border:1px solid rgba(232,64,64,.3);border-radius:24px;max-width:440px;width:100%;padding:36px;text-align:center;box-shadow:0 32px 80px rgba(0,0,0,.8)}
/* Nav msg button */
.nav-msg-btn{position:relative;width:34px;height:34px;border-radius:10px;border:1.5px solid var(--bord2);display:flex;align-items:center;justify-content:center;font-size:18px;cursor:pointer;background:var(--surf2);transition:all .15s;flex-shrink:0}
.nav-msg-btn:hover{border-color:var(--gold4);background:var(--surf3)}
.nav-msg-dot{position:absolute;top:-3px;right:-3px;width:10px;height:10px;border-radius:50%;background:var(--red);border:2px solid var(--bg);display:none}
.nav-msg-dot.show{display:block}
/* New message compose */
.msg-compose{padding:16px;display:flex;flex-direction:column;gap:10px;flex:1}
.msg-compose label{font-size:11px;font-weight:700;color:var(--mut);text-transform:uppercase;letter-spacing:.6px}
.msg-compose select,.msg-compose textarea{background:var(--surf2);border:1px solid var(--bord2);border-radius:10px;padding:10px 12px;color:var(--txt);font-family:inherit;font-size:13px;outline:none;width:100%}
.msg-compose select:focus,.msg-compose textarea:focus{border-color:var(--gold4)}
.msg-compose textarea{resize:none;height:100px}
</style>
</head>
<body>

<!-- PARALLAX VORTEX -->
<canvas id="vortexCanvas"></canvas>

<!-- ‚ïê‚ïê‚ïê NAV ‚ïê‚ïê‚ïê -->
<nav id="mainNav">
  <div class="logo" id="navLogo" onclick="goHome()">
    <div class="logo-ic">üéÆ</div>ParaGames
  </div>
  <div class="nav-spacer" id="navSpacer"></div>
  <div class="nav-search" id="navSearchBox">
    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
    <input type="text" id="srchIn" placeholder="Search 40 games..." autocomplete="off"/>
  </div>
  <span class="nav-game-name" id="navGameName"></span>
  <button class="nav-pause" id="navPause" onclick="togglePause()">‚è∏ Pause</button>
  <button class="nav-btn-fs" id="navFS" onclick="toggleFS()" title="Fullscreen" style="display:none">‚õ∂</button>
  <button class="nav-back" id="navBack" onclick="goHome()">‚úï Exit</button>
  <!-- Avatar / Profile -->
  <button class="nav-lb-btn" id="navLbBtn" onclick="openLeaderboard()">üèÜ Leaderboard</button>
  <div class="nav-msg-btn" id="navMsgBtn" onclick="openMessages()" title="Messages" style="display:none">
    üí¨<div class="nav-msg-dot" id="navMsgDot"></div>
  </div>
  <div class="nav-avatar" id="navAvatarBtn" onclick="openProfile()" title="Profile">üë§</div>
  <span class="guest-badge" id="navGuestBadge">Guest</span>
  <span class="admin-crown" id="navAdminCrown" onclick="openProfile()" style="display:none">üëë Admin</span>
  <!-- Dropdown -->
  <div class="dropdown" id="ddWrap">
    <button class="nav-btn-fs" onclick="toggleDD()">‚ò∞</button>
    <div class="dropdown-menu" id="ddMenu">
      <div class="dd-item" onclick="goHome();closeDD()">üè† Home</div>
      <div class="dd-item" onclick="openLeaderboard();closeDD()">üèÜ Leaderboard</div>
      <div class="dd-item" onclick="openMessages();closeDD()" id="ddMsgItem" style="display:none">üí¨ Messages</div>
      <div class="dd-item" onclick="filterCat('arcade');closeDD()">üïπ Arcade Games</div>
      <div class="dd-item" onclick="filterCat('puzzle');closeDD()">üß© Puzzle Games</div>
      <div class="dd-item" onclick="filterCat('2player');closeDD()">üë• 2 Player Games</div>
      <div class="dd-item" onclick="filterCat('word');closeDD()">üìù Word & Quiz</div>
      <div class="dd-item" onclick="filterCat('strategy');closeDD()">‚ôü Strategy</div>
      <div class="dd-item" onclick="filterCat('card');closeDD()">üÉè Card & Dice</div>
      <div class="dd-item" onclick="filterCat('action');closeDD()">üöÄ Action</div>
      <div class="dd-sep"></div>
      <div class="dd-item" onclick="toggleFS();closeDD()">‚õ∂ Fullscreen</div>
      <div class="dd-item" onclick="window.scrollTo({top:0,behavior:'smooth'});closeDD()">‚¨Ü Back to Top</div>
    </div>
  </div>
</nav>

<!-- ‚ïê‚ïê‚ïê HOME ‚ïê‚ïê‚ïê -->
<div id="homePage" style="display:none">
  <div class="hero">
    <div class="hero-bg"></div>
    <div class="hero-word">ParaGames</div>
    <p class="hero-sub"><b>40 games.</b> Self-hosted. Zero ads. Zero blocks.</p>
    <div class="hero-stats">
      <div class="stat"><div class="stat-n" id="statCount">30</div><div class="stat-l">Games</div></div>
      <div class="stat"><div class="stat-n">0</div><div class="stat-l">Ads</div></div>
      <div class="stat"><div class="stat-n">‚àû</div><div class="stat-l">Fun</div></div>
      <div class="stat"><div class="stat-n">Free</div><div class="stat-l">Always</div></div>
    </div>
  </div>

  <div class="trending">
    <div class="sec-label">
      <h2>üî• Trending Now</h2>
      <div class="sec-label-line"></div>
      <div class="cnt">Changes every 5s</div>
    </div>
    <div class="trend-card" id="trendCard" onclick="onTrendClick()">
      <div class="trend-bg" id="trendBg"></div>
      <div class="trend-overlay"></div>
      <div class="trend-content">
        <div class="trend-badge">üî• Trending</div>
        <div class="trend-title" id="trendTitle">Loading...</div>
        <div class="trend-desc" id="trendDesc"></div>
        <button class="trend-play"><svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg> Play Now</button>
      </div>
    </div>
    <div class="trend-dots" id="trendDots"></div>
  </div>

  <div class="cats" id="catRow">
    <div class="pill active" data-cat="all">üéÆ All</div>
    <div class="pill" data-cat="arcade">üïπ Arcade</div>
    <div class="pill" data-cat="puzzle">üß© Puzzle</div>
    <div class="pill" data-cat="2player">üë• 2 Player</div>
    <div class="pill" data-cat="action">‚öîÔ∏è Action</div>
    <div class="pill" data-cat="word">üìù Word</div>
    <div class="pill" data-cat="strategy">‚ôü Strategy</div>
    <div class="pill" data-cat="card">üÉè Card</div>
    <div class="pill" data-cat="music">üéµ Music</div>
    <div class="pill" data-cat="fighting">ü•ä Fighting</div>
    <div class="pill" data-cat="racing">üèé Racing</div>
    <div class="pill" data-cat="reflex">‚ö° Reflex</div>
  </div>

  <div class="sec">
    <div class="sec-label">
      <h2 id="gridLabel">All Games</h2>
      <div class="sec-label-line"></div>
      <div class="cnt" id="cntEl">30 games</div>
    </div>
    <div class="ggrid" id="gGrid"></div>
    <div class="nores" id="noRes">
      <div style="font-size:52px;margin-bottom:16px">üéÆ</div>
      <h3 style="color:var(--txt);font-size:18px;margin-bottom:6px">No games found</h3>
      <p>Try a different search or category</p>
    </div>
  </div>

  <footer>¬© 2025 ParaGames ¬∑ All games self-hosted ¬∑ <a href="https://pages.github.com" target="_blank">Host free on GitHub Pages</a> ¬∑ Zero ads ever</footer>
</div>

<!-- ‚ïê‚ïê‚ïê BAN SCREEN ‚ïê‚ïê‚ïê -->
<div id="banScreen">
  <div class="ban-box">
    <div style="font-size:56px;margin-bottom:16px">üö´</div>
    <h2 style="font-family:var(--font-head);font-size:24px;font-weight:800;color:var(--red);margin-bottom:8px">You've Been Banned</h2>
    <p style="color:var(--mut);font-size:14px;margin-bottom:6px" id="banReason">Your account has been suspended from ParaGames.</p>
    <p style="color:var(--mut2);font-size:12px;margin-bottom:24px">If you believe this is a mistake, you can submit a ban appeal below.</p>
    <div id="banAppealSection">
      <textarea id="banAppealText" placeholder="Explain why you think your ban should be lifted..." style="width:100%;background:var(--surf2);border:1px solid var(--bord2);border-radius:12px;padding:12px;color:var(--txt);font-family:inherit;font-size:13px;outline:none;resize:none;height:90px;margin-bottom:10px;display:block"></textarea>
      <button onclick="submitAppeal()" style="width:100%;background:var(--gold);color:#0c0b08;border:none;padding:12px;border-radius:12px;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit;margin-bottom:8px">üì® Submit Appeal</button>
      <div id="banAppealMsg" style="font-size:12px;text-align:center;min-height:16px;color:var(--grn)"></div>
    </div>
    <button onclick="doBanLogout()" style="width:100%;background:transparent;color:var(--mut);border:1px solid var(--bord2);padding:10px;border-radius:12px;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;margin-top:10px">Sign Out</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê MESSAGES MODAL ‚ïê‚ïê‚ïê -->
<div id="msgModal">
  <div class="msg-box">
    <div class="msg-header">
      <span style="font-size:22px">üí¨</span>
      <h2>Messages</h2>
      <span class="msg-unread-badge" id="msgUnreadBadge" style="display:none">0</span>
      <button class="lb-close" onclick="closeMessages()">‚úï</button>
    </div>
    <div class="msg-layout">
      <div class="msg-sidebar">
        <div class="msg-sidebar-header">
          <button class="msg-new-btn" onclick="showNewMessage()">‚úâÔ∏è New Message</button>
        </div>
        <div class="msg-thread-list" id="msgThreadList"></div>
      </div>
      <div class="msg-content" id="msgContent">
        <div class="msg-empty">
          <div>üí¨</div>
          <p style="font-size:14px;font-weight:600;color:var(--txt)">No conversation selected</p>
          <p style="font-size:12px">Pick a thread or start a new message</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê LEADERBOARD MODAL ‚ïê‚ïê‚ïê -->
<div id="lbModal">
  <div class="lb-box">
    <div class="lb-header">
      <span style="font-size:26px">üèÜ</span>
      <h2>Leaderboard</h2>
      <button class="lb-close" onclick="closeLeaderboard()">‚úï Close</button>
    </div>
    <div class="lb-controls">
      <div class="lb-pill active" data-period="alltime" onclick="setLbPeriod('alltime')">All Time</div>
      <div class="lb-pill" data-period="monthly" onclick="setLbPeriod('monthly')">Monthly</div>
      <div class="lb-pill" data-period="weekly" onclick="setLbPeriod('weekly')">Weekly</div>
      <div class="lb-pill" data-period="daily" onclick="setLbPeriod('daily')">Today</div>
      <select class="lb-game-sel" id="lbGameSel" onchange="renderLeaderboard()">
        <option value="all">üéÆ All Games</option>
      </select>
    </div>
    <div class="lb-body" id="lbBody"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê LOGIN SCREEN ‚ïê‚ïê‚ïê -->
<div id="loginScreen">
  <canvas id="vortexCanvas2" style="position:fixed;inset:0;width:100%;height:100%;pointer-events:none;z-index:0;opacity:0.4"></canvas>
  <div class="login-box" style="position:relative;z-index:1">
    <div class="login-logo">
      <div class="logo-ic">üéÆ</div>
      <h1>ParaGames</h1>
      <p>40 games. Zero ads. Free forever.</p>
    </div>
    <div class="login-tabs">
      <div class="login-tab active" id="ltSign" onclick="switchLoginTab('login')">Sign In</div>
      <div class="login-tab" id="ltReg" onclick="switchLoginTab('register')">Create Account</div>
      <div class="login-tab" id="ltForgot" onclick="switchLoginTab('forgot')">Forgot?</div>
    </div>
    <!-- Sign In -->
    <div id="loginForm">
      <div class="login-field"><label>Username</label><input class="login-input" id="liUser" placeholder="Your username" autocomplete="username"/></div>
      <div class="login-field"><label>Password</label><input class="login-input" id="liPass" type="password" placeholder="Your password" autocomplete="current-password"/></div>
      <div class="login-err" id="liErr"></div>
      <button class="btn-login" onclick="doLogin()">Sign In ‚Üí</button>
    </div>
    <!-- Register -->
    <div id="registerForm" style="display:none">
      <div class="login-field"><label>Username</label><input class="login-input" id="riUser" placeholder="Pick a username" autocomplete="username"/></div>
      <div class="login-field"><label>Password</label><input class="login-input" id="riPass" type="password" placeholder="Create a password" autocomplete="new-password"/></div>
      <div class="login-field"><label>Secret Question</label>
        <select class="login-input" id="riSecretQ" style="cursor:pointer">
          <option value="">‚Äî Choose a secret question ‚Äî</option>
          <option>What is your pet's name?</option>
          <option>What street did you grow up on?</option>
          <option>What is your mother's maiden name?</option>
          <option>What was the name of your first school?</option>
          <option>What is your favorite sports team?</option>
          <option>What was the make of your first car?</option>
          <option>What city were you born in?</option>
          <option>What is your favorite movie?</option>
        </select>
      </div>
      <div class="login-field"><label>Secret Answer <span style="font-size:10px;color:var(--mut)">(case-sensitive)</span></label><input class="login-input" id="riSecretA" placeholder="Your answer..." autocomplete="off"/></div>
      <div class="login-field"><label>Choose your avatar</label>
        <div class="login-avatar-grid" id="avGrid"></div>
      </div>
      <div class="login-err" id="riErr"></div>
      <button class="btn-login" onclick="doRegister()">Create Account ‚Üí</button>
    </div>
    <!-- Forgot Password ‚Äî Step 1: enter username -->
    <div id="forgotForm" style="display:none">
      <div id="forgotStep1">
        <div class="login-field"><label>Username</label><input class="login-input" id="fgUser" placeholder="Your username" autocomplete="username"/></div>
        <div class="login-err" id="fgErr1"></div>
        <button class="btn-login" onclick="doForgotStep1()">Continue ‚Üí</button>
      </div>
      <!-- Step 2: answer secret question -->
      <div id="forgotStep2" style="display:none">
        <div class="login-field">
          <label id="fgQuestionLabel">Secret Question</label>
          <input class="login-input" id="fgAnswer" placeholder="Your answer (case-sensitive)" autocomplete="off"/>
        </div>
        <div class="login-err" id="fgErr2"></div>
        <button class="btn-login" onclick="doForgotStep2()">Verify ‚Üí</button>
      </div>
      <!-- Step 3: set new password -->
      <div id="forgotStep3" style="display:none">
        <p style="font-size:13px;color:var(--grn);margin-bottom:14px;text-align:center">‚úÖ Identity verified! Set your new password.</p>
        <div class="login-field"><label>New Password</label><input class="login-input" id="fgNewPass" type="password" placeholder="New password (min 4 chars)" autocomplete="new-password"/></div>
        <div class="login-field"><label>Confirm Password</label><input class="login-input" id="fgConfPass" type="password" placeholder="Confirm new password" autocomplete="new-password"/></div>
        <div class="login-err" id="fgErr3"></div>
        <button class="btn-login" onclick="doForgotStep3()">Reset Password ‚Üí</button>
      </div>
    </div>
    <div class="login-divider"><span>or</span></div>
    <button class="btn-guest" onclick="doGuest()">üë§ Continue as Guest</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê PROFILE MODAL ‚ïê‚ïê‚ïê -->
<div id="profileModal">
  <div class="profile-box">
    <div class="profile-header">
      <div class="profile-avatar-big" id="profAvBig">üéÆ</div>
      <div class="profile-info">
        <h2 id="profName">Player</h2>
        <p id="profSub">Guest Mode</p>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <button class="btn-close-prof" onclick="closeProfile()">‚úï</button>
      </div>
    </div>
    <div class="profile-tabs">
      <div class="ptab active" onclick="switchPTab('stats')" id="pt-stats">üìä Stats</div>
      <div class="ptab" onclick="switchPTab('edit')" id="pt-edit">‚úèÔ∏è Edit Profile</div>
      <div class="ptab" onclick="switchPTab('friends')" id="pt-friends">üë• Friends</div>
      <div class="ptab" onclick="switchPTab('games')" id="pt-games">üéÆ Games</div>
      <div class="ptab admin-tab" onclick="switchPTab('admin')" id="pt-admin" style="display:none">üëë Admin</div>
    </div>
    <div class="profile-body" id="profileBody"></div>
    <div class="profile-footer">
      <button class="btn-save-prof" id="profSaveBtn" onclick="saveProfile()" style="display:none">Save Changes</button>
      <button class="btn-close-prof" onclick="closeProfile()">Close</button>
      <button class="btn-logout" onclick="doLogout()">Sign Out</button>
    </div>
  </div>
</div>

<!-- Admin Toast -->
<div class="admin-toast" id="adminToast">
  <span id="adminToastIcon">‚ö°</span>
  <span id="adminToastMsg">Action complete</span>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH & PROFILE SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const AVATARS = ['üéÆ','üêç','üöÄ','üéØ','üèÜ','‚ö°','ü¶ä','üê±','üê∏','üî•','üíé','üåü','üéµ','üé≤','ü§ñ','ü¶Ñ'];
const OWNER_USERNAME = 'alijahpatton'; // Hardcoded owner ‚Äî cannot be changed or revoked

// DB helpers (localStorage)
function getDB(key, def) { try { return JSON.parse(localStorage.getItem('pg_'+key)) ?? def; } catch(e) { return def; } }
function setDB(key, val) { try { localStorage.setItem('pg_'+key, JSON.stringify(val)); } catch(e) {} }

function getUsers() { return getDB('users', {}); }
function saveUsers(u) { setDB('users', u); }
function getSession() { return getDB('session', null); }
function setSession(s) { setDB('session', s); }

let currentUser = null; // null = guest

// ‚îÄ‚îÄ ROLE HELPERS ‚îÄ‚îÄ
function isOwner(u) { return u === OWNER_USERNAME; }
function isAdmin(u) {
  if (!u) return false;
  if (isOwner(u)) return true;
  const users = getUsers();
  return users[u] && users[u].role === 'admin';
}
function isBanned(u) {
  if (!u) return false;
  if (isOwner(u)) return false; // owner can never be banned
  const users = getUsers();
  return users[u] && users[u].banned === true;
}
function getRoleLabel(u) {
  if (isOwner(u)) return `<span class="role-badge role-owner">üëë Owner</span>`;
  if (isAdmin(u)) return `<span class="role-badge role-admin">üõ° Admin</span>`;
  if (isBanned(u)) return `<span class="role-badge role-banned">üö´ Banned</span>`;
  return '';
}

// ‚îÄ‚îÄ ADMIN TOAST ‚îÄ‚îÄ
let toastTimer;
function adminToast(msg, icon='‚ö°') {
  const t = document.getElementById('adminToast');
  document.getElementById('adminToastMsg').textContent = msg;
  document.getElementById('adminToastIcon').textContent = icon;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 3000);
}

function switchLoginTab(tab) {
  document.getElementById('ltSign').classList.toggle('active', tab==='login');
  document.getElementById('ltReg').classList.toggle('active', tab==='register');
  document.getElementById('ltForgot').classList.toggle('active', tab==='forgot');
  document.getElementById('loginForm').style.display = tab==='login' ? '' : 'none';
  document.getElementById('registerForm').style.display = tab==='register' ? '' : 'none';
  document.getElementById('forgotForm').style.display = tab==='forgot' ? '' : 'none';
  document.getElementById('liErr').textContent = '';
  document.getElementById('riErr').textContent = '';
  document.getElementById('fgErr1').textContent = '';
  // Reset forgot steps
  if (tab === 'forgot') {
    document.getElementById('forgotStep1').style.display = '';
    document.getElementById('forgotStep2').style.display = 'none';
    document.getElementById('forgotStep3').style.display = 'none';
    document.getElementById('fgUser').value = '';
    document.getElementById('fgAnswer').value = '';
    if (document.getElementById('fgNewPass')) document.getElementById('fgNewPass').value = '';
    if (document.getElementById('fgConfPass')) document.getElementById('fgConfPass').value = '';
  }
}

// Build avatar grid
function buildAvGrid() {
  const g = document.getElementById('avGrid');
  g.innerHTML = '';
  AVATARS.forEach((a, i) => {
    const d = document.createElement('div');
    d.className = 'av-opt' + (i===0?' sel':'');
    d.textContent = a;
    d.onclick = () => { document.querySelectorAll('.av-opt').forEach(x=>x.classList.remove('sel')); d.classList.add('sel'); };
    g.appendChild(d);
  });
}
buildAvGrid();

function doLogin() {
  const raw = document.getElementById('liUser').value.trim();
  const pass = document.getElementById('liPass').value;
  const err = document.getElementById('liErr');
  if (!raw || !pass) { err.textContent = 'Please fill in all fields.'; return; }
  const users = getUsers();
  // Case-insensitive match ‚Äî resolves to the real stored username
  const user = Object.keys(users).find(k => k.toLowerCase() === raw.toLowerCase());
  if (!user) { err.textContent = 'No account found with that username.'; return; }
  if (users[user].pass !== btoa(pass)) { err.textContent = 'Incorrect password.'; return; }
  if (isBanned(user)) {
    // Let them in to the ban screen so they can appeal
    setSession(user);
    currentUser = user;
    document.getElementById('loginScreen').style.display = 'none';
    showBanScreen(user);
    return;
  }
  setSession(user);
  currentUser = user;
  enterApp();
}

function doRegister() {
  const user = document.getElementById('riUser').value.trim();
  const pass = document.getElementById('riPass').value;
  const err = document.getElementById('riErr');
  const selAv = document.querySelector('.av-opt.sel');
  const secretQ = document.getElementById('riSecretQ').value;
  const secretA = document.getElementById('riSecretA').value; // case-sensitive, don't trim
  if (!user || !pass) { err.textContent = 'Please fill in all fields.'; return; }
  if (user.length < 3) { err.textContent = 'Username must be at least 3 characters.'; return; }
  if (pass.length < 4) { err.textContent = 'Password must be at least 4 characters.'; return; }
  if (!/^[a-zA-Z0-9_]+$/.test(user)) { err.textContent = 'Username: letters, numbers, _ only.'; return; }
  if (!secretQ) { err.textContent = 'Please choose a secret question.'; return; }
  if (!secretA) { err.textContent = 'Please enter a secret answer.'; return; }
  const users = getUsers();
  if (users[user]) { err.textContent = 'Username already taken!'; return; }
  users[user] = {
    pass: btoa(pass),
    avatar: selAv ? selAv.textContent : 'üéÆ',
    displayName: user,
    bio: '',
    joined: new Date().toLocaleDateString(),
    friends: [],
    gamesPlayed: {},
    totalPlays: 0,
    created: Date.now(),
    role: user === OWNER_USERNAME ? 'owner' : 'user',
    secretQ,
    secretA // stored as-is (case-sensitive)
  };
  saveUsers(users);
  setSession(user);
  currentUser = user;
  enterApp();
}

function doGuest() {
  currentUser = null;
  setSession(null);
  enterApp();
}

// ‚îÄ‚îÄ FORGOT PASSWORD ‚îÄ‚îÄ
let _forgotUser = null; // holds the resolved username between steps

function doForgotStep1() {
  const raw = document.getElementById('fgUser').value.trim();
  const err = document.getElementById('fgErr1');
  err.textContent = '';
  if (!raw) { err.textContent = 'Please enter your username.'; return; }
  const users = getUsers();
  const match = Object.keys(users).find(k => k.toLowerCase() === raw.toLowerCase());
  if (!match) { err.textContent = 'No account found with that username.'; return; }
  const u = users[match];
  if (!u.secretQ || !u.secretA) {
    err.textContent = 'This account has no secret question set. You cannot recover this password.';
    return;
  }
  _forgotUser = match;
  document.getElementById('fgQuestionLabel').textContent = u.secretQ;
  document.getElementById('forgotStep1').style.display = 'none';
  document.getElementById('forgotStep2').style.display = '';
  document.getElementById('fgAnswer').focus();
}

function doForgotStep2() {
  const answer = document.getElementById('fgAnswer').value; // case-sensitive, no trim
  const err = document.getElementById('fgErr2');
  err.textContent = '';
  if (!answer) { err.textContent = 'Please enter your answer.'; return; }
  if (!_forgotUser) { err.textContent = 'Something went wrong. Start over.'; return; }
  const users = getUsers();
  const u = users[_forgotUser];
  if (!u) { err.textContent = 'Account not found.'; return; }
  if (answer !== u.secretA) {
    err.textContent = '‚ùå Incorrect answer. Remember it is case-sensitive.';
    return;
  }
  document.getElementById('forgotStep2').style.display = 'none';
  document.getElementById('forgotStep3').style.display = '';
  document.getElementById('fgNewPass').focus();
}

function doForgotStep3() {
  const newPass = document.getElementById('fgNewPass').value;
  const confPass = document.getElementById('fgConfPass').value;
  const err = document.getElementById('fgErr3');
  err.textContent = '';
  if (!newPass || !confPass) { err.textContent = 'Please fill in both fields.'; return; }
  if (newPass.length < 4) { err.textContent = 'Password must be at least 4 characters.'; return; }
  if (newPass !== confPass) { err.textContent = 'Passwords do not match.'; return; }
  if (!_forgotUser) { err.textContent = 'Something went wrong. Start over.'; return; }
  const users = getUsers();
  if (!users[_forgotUser]) { err.textContent = 'Account not found.'; return; }
  users[_forgotUser].pass = btoa(newPass);
  saveUsers(users);
  _forgotUser = null;
  // Go back to sign in with success message
  switchLoginTab('login');
  document.getElementById('liUser').value = '';
  document.getElementById('liPass').value = '';
  document.getElementById('liErr').textContent = '';
  document.getElementById('liErr').style.color = 'var(--grn)';
  document.getElementById('liErr').textContent = '‚úÖ Password reset! Sign in with your new password.';
  setTimeout(() => {
    const el = document.getElementById('liErr');
    if (el) { el.textContent = ''; el.style.color = ''; }
  }, 5000);
}

function doLogout() {
  setSession(null);
  currentUser = null;
  closeProfile();
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('homePage').style.display = 'none';
  updateNavAvatar();
}

function enterApp() {
  document.getElementById('loginScreen').style.display = 'none';
  // Check if banned
  if (currentUser && isBanned(currentUser)) {
    showBanScreen(currentUser);
    return;
  }
  document.getElementById('banScreen').classList.remove('open');
  document.getElementById('homePage').style.display = '';
  updateNavAvatar();
  updateMsgBadge();
  if (currentUser && isAdmin(currentUser)) {
    adminToast('Welcome back, ' + (isOwner(currentUser) ? 'Owner üëë' : 'Admin üõ°'), isOwner(currentUser) ? 'üëë' : 'üõ°');
  }
}

function updateNavAvatar() {
  const el = document.getElementById('navAvatarBtn');
  const crownEl = document.getElementById('navAdminCrown');
  const msgBtn = document.getElementById('navMsgBtn');
  const ddMsg = document.getElementById('ddMsgItem');
  if (!el) return;
  if (currentUser) {
    const users = getUsers();
    const u = users[currentUser];
    el.textContent = u ? u.avatar : 'üéÆ';
    el.title = currentUser + (isOwner(currentUser) ? ' (Owner)' : isAdmin(currentUser) ? ' (Admin)' : '');
    document.getElementById('navGuestBadge').style.display = 'none';
    if (crownEl) {
      crownEl.style.display = isAdmin(currentUser) ? '' : 'none';
      crownEl.textContent = isOwner(currentUser) ? 'üëë Owner' : 'üõ° Admin';
    }
    if (msgBtn) msgBtn.style.display = '';
    if (ddMsg) ddMsg.style.display = '';
  } else {
    el.textContent = 'üë§';
    el.title = 'Guest';
    document.getElementById('navGuestBadge').style.display = '';
    if (crownEl) crownEl.style.display = 'none';
    if (msgBtn) msgBtn.style.display = 'none';
    if (ddMsg) ddMsg.style.display = 'none';
  }
}

// Track game plays
function trackGamePlay(id) {
  if (!currentUser) return;
  const users = getUsers();
  const u = users[currentUser];
  if (!u) return;
  if (!u.gamesPlayed) u.gamesPlayed = {};
  u.gamesPlayed[id] = (u.gamesPlayed[id] || 0) + 1;
  u.totalPlays = (u.totalPlays || 0) + 1;
  saveUsers(users);
  if (typeof recordPlay === 'function') recordPlay(id);
}

// ‚îÄ‚îÄ PROFILE MODAL ‚îÄ‚îÄ
let curPTab = 'stats';

function openProfile() {
  document.getElementById('profileModal').classList.add('open');
  const users = getUsers();
  const u = currentUser ? users[currentUser] : null;
  const av = u ? u.avatar : 'üë§';
  const name = u ? (u.displayName || currentUser) : 'Guest';
  const sub = u ? `@${currentUser} ¬∑ Joined ${u.joined||'recently'}` : 'Playing as Guest ‚Äî sign in to save progress!';
  document.getElementById('profAvBig').textContent = av;
  document.getElementById('profName').textContent = name;
  document.getElementById('profSub').textContent = sub;
  // Show admin tab only to admins/owner
  const adminTab = document.getElementById('pt-admin');
  if (adminTab) adminTab.style.display = currentUser && isAdmin(currentUser) ? '' : 'none';
  switchPTab('stats');
}

function closeProfile() { document.getElementById('profileModal').classList.remove('open'); }

function switchPTab(tab) {
  curPTab = tab;
  document.querySelectorAll('.ptab').forEach(t => t.classList.remove('active'));
  const tabEl = document.getElementById('pt-'+tab);
  if (tabEl) tabEl.classList.add('active');
  // Admin tab styling
  if (tab === 'admin' && tabEl) {
    tabEl.style.background = 'linear-gradient(135deg,#ffd700,#ff8c00)';
    tabEl.style.color = '#0c0b08';
    tabEl.style.borderRadius = '6px 6px 0 0';
  } else {
    const at = document.getElementById('pt-admin');
    if (at) { at.style.background=''; at.style.color=''; at.style.borderRadius=''; }
  }
  document.getElementById('profSaveBtn').style.display = tab==='edit' && currentUser ? '' : 'none';
  renderPTab(tab);
}

function renderPTab(tab) {
  const body = document.getElementById('profileBody');
  const users = getUsers();
  const u = currentUser ? users[currentUser] : null;

  if (tab === 'stats') {
    if (!u) {
      body.innerHTML = `<div style="text-align:center;padding:40px 20px;color:var(--mut)">
        <div style="font-size:48px;margin-bottom:12px">üë§</div>
        <h3 style="color:var(--txt);font-family:var(--font-head);margin-bottom:8px">You're in Guest Mode</h3>
        <p style="font-size:13px;margin-bottom:16px">Sign in or create an account to save your stats, track progress, and add friends!</p>
        <button class="btn-login" style="max-width:200px" onclick="closeProfile();doLogout()">Sign In / Register</button>
      </div>`;
      return;
    }
    const plays = u.totalPlays || 0;
    const gameCount = Object.keys(u.gamesPlayed||{}).length;
    const friendCount = (u.friends||[]).length;
    const topGame = Object.entries(u.gamesPlayed||{}).sort((a,b)=>b[1]-a[1])[0];
    const topGInfo = topGame ? GAMES.find(g=>g.id===topGame[0]) : null;
    body.innerHTML = `
      ${isOwner(currentUser) ? `<div style="background:linear-gradient(135deg,rgba(255,215,0,.08),rgba(255,140,0,.06));border:1px solid rgba(255,215,0,.2);border-radius:12px;padding:12px 16px;margin-bottom:14px;display:flex;align-items:center;gap:10px"><span style="font-size:22px">üëë</span><div><div style="font-size:12px;font-weight:700;color:#ffd700">Site Owner</div><div style="font-size:11px;color:var(--mut)">You have full admin control over ParaGames</div></div><button class="admin-crown" onclick="switchPTab('admin')" style="margin-left:auto">Open Admin Panel</button></div>` : isAdmin(currentUser) ? `<div style="background:rgba(64,128,224,.08);border:1px solid rgba(64,128,224,.2);border-radius:12px;padding:12px 16px;margin-bottom:14px;display:flex;align-items:center;gap:10px"><span style="font-size:22px">üõ°</span><div><div style="font-size:12px;font-weight:700;color:#80b0ff">Administrator</div><div style="font-size:11px;color:var(--mut)">You have admin privileges on ParaGames</div></div><button class="admin-crown" onclick="switchPTab('admin')" style="margin-left:auto;background:linear-gradient(135deg,#4080e0,#2050b0);color:#fff">Admin Panel</button></div>` : ''}
      <div class="stat-grid">
        <div class="stat-box"><div class="sv">${plays}</div><div class="sl">Total Plays</div></div>
        <div class="stat-box"><div class="sv">${gameCount}</div><div class="sl">Games Tried</div></div>
        <div class="stat-box"><div class="sv">${friendCount}</div><div class="sl">Friends</div></div>
      </div>
      ${topGInfo ? `<div style="background:var(--surf2);border:1px solid var(--bord2);border-radius:12px;padding:14px 16px;margin-bottom:14px;display:flex;align-items:center;gap:12px">
        <span style="font-size:30px">${topGInfo.e}</span>
        <div><div style="font-size:11px;color:var(--mut);text-transform:uppercase;letter-spacing:.6px;margin-bottom:2px">Favorite Game</div>
        <div style="font-size:15px;font-weight:700;color:var(--txt)">${topGInfo.name}</div>
        <div style="font-size:12px;color:var(--gold)">${topGame[1]} plays</div></div>
      </div>` : `<div style="color:var(--mut);font-size:13px;text-align:center;padding:20px">Play some games to build your stats!</div>`}
      <div style="font-size:11px;color:var(--mut);text-transform:uppercase;letter-spacing:.8px;font-weight:700;margin-bottom:8px">Recently Played</div>
      <div class="games-played-list">
        ${Object.entries(u.gamesPlayed||{}).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([id,ct])=>{
          const gi = GAMES.find(g=>g.id===id);
          return gi ? `<div class="gpl-row"><span class="gpl-em">${gi.e}</span><span class="gpl-name">${gi.name}</span><span class="gpl-plays">${ct}√ó</span></div>` : '';
        }).join('')||'<div style="color:var(--mut);font-size:13px;padding:8px 0">No games played yet.</div>'}
      </div>`;
  }

  else if (tab === 'edit') {
    if (!u) { body.innerHTML = `<div style="text-align:center;padding:40px;color:var(--mut)"><p>Sign in to edit your profile.</p></div>`; return; }
    const hasSecret = u.secretQ && u.secretA;
    body.innerHTML = `
      <div class="pfield"><label>Display Name</label><input class="pinput" id="eDispName" value="${u.displayName||currentUser}" maxlength="24" placeholder="Your display name"/></div>
      <div class="pfield"><label>Bio</label><input class="pinput" id="eBio" value="${u.bio||''}" maxlength="80" placeholder="A short bio..."/></div>
      <div class="pfield"><label>Avatar</label>
        <div class="login-avatar-grid" id="editAvGrid"></div>
      </div>
      <div style="height:1px;background:var(--bord);margin:8px 0 14px"></div>
      <div style="font-size:11px;font-weight:700;color:var(--mut);text-transform:uppercase;letter-spacing:.8px;margin-bottom:10px">üîê Password Recovery</div>
      ${hasSecret
        ? `<div style="background:rgba(56,168,56,.08);border:1px solid rgba(56,168,56,.2);border-radius:10px;padding:10px 13px;font-size:12px;color:var(--grn);margin-bottom:10px">‚úÖ Secret question is set: <em style="color:var(--txt)">"${u.secretQ}"</em></div>`
        : `<div style="background:rgba(232,196,74,.08);border:1px solid rgba(232,196,74,.2);border-radius:10px;padding:10px 13px;font-size:12px;color:var(--gold);margin-bottom:10px">‚ö†Ô∏è No secret question set ‚Äî you won't be able to recover your password if forgotten!</div>`
      }
      <div class="pfield"><label>${hasSecret ? 'Change Secret Question' : 'Set Secret Question'}</label>
        <select class="pinput" id="eSecretQ" style="cursor:pointer">
          <option value="">‚Äî ${hasSecret ? 'Change question' : 'Choose a question'} ‚Äî</option>
          <option ${u.secretQ==='What is your pet\'s name?'?'selected':''}>What is your pet's name?</option>
          <option ${u.secretQ==='What street did you grow up on?'?'selected':''}>What street did you grow up on?</option>
          <option ${u.secretQ==='What is your mother\'s maiden name?'?'selected':''}>What is your mother's maiden name?</option>
          <option ${u.secretQ==='What was the name of your first school?'?'selected':''}>What was the name of your first school?</option>
          <option ${u.secretQ==='What is your favorite sports team?'?'selected':''}>What is your favorite sports team?</option>
          <option ${u.secretQ==='What was the make of your first car?'?'selected':''}>What was the make of your first car?</option>
          <option ${u.secretQ==='What city were you born in?'?'selected':''}>What city were you born in?</option>
          <option ${u.secretQ==='What is your favorite movie?'?'selected':''}>What is your favorite movie?</option>
        </select>
      </div>
      <div class="pfield"><label>Secret Answer <span style="font-size:10px;color:var(--mut2)">(case-sensitive ‚Äî leave blank to keep existing)</span></label>
        <input class="pinput" id="eSecretA" placeholder="${hasSecret ? 'Leave blank to keep current answer' : 'Your answer...'}" autocomplete="off"/>
      </div>`;
    const ag = document.getElementById('editAvGrid');
    AVATARS.forEach(a => {
      const d = document.createElement('div');
      d.className = 'av-opt' + (a===u.avatar?' sel':'');
      d.textContent = a;
      d.onclick = () => { ag.querySelectorAll('.av-opt').forEach(x=>x.classList.remove('sel')); d.classList.add('sel'); };
      ag.appendChild(d);
    });
  }

  else if (tab === 'friends') {
    if (!u) { body.innerHTML = `<div style="text-align:center;padding:40px;color:var(--mut)"><p>Sign in to add friends.</p></div>`; return; }
    const allUsers = getUsers();
    const friends = u.friends || [];
    body.innerHTML = `
      <div class="add-friend-row">
        <input class="pinput" id="friendInput" placeholder="Enter username to add..." />
        <button class="btn-add-fr" onclick="addFriend()">Add Friend</button>
      </div>
      <div class="login-err" id="frErr" style="margin-bottom:10px"></div>
      <div style="font-size:11px;color:var(--mut);text-transform:uppercase;letter-spacing:.8px;font-weight:700;margin-bottom:10px">Your Friends (${friends.length})</div>
      <div id="friendList">
        ${friends.length ? friends.map(fn => {
          const fu = allUsers[fn];
          const av = fu ? fu.avatar : 'üë§';
          const dn = fu ? (fu.displayName||fn) : fn;
          const plays = fu ? (fu.totalPlays||0) : 0;
          return `<div class="friend-row">
            <div class="fr-av">${av}</div>
            <div class="fr-info"><div class="fr-name">${dn} ${getRoleLabel(fn)}</div><div class="fr-sub">@${fn} ¬∑ ${plays} plays</div></div>
            <span class="fr-badge">Friend</span>
            <button class="btn-rm-fr" onclick="removeFriend('${fn}')">‚úï</button>
          </div>`;
        }).join('') : `<div style="color:var(--mut);font-size:13px;text-align:center;padding:20px">No friends yet ‚Äî add some!</div>`}
      </div>`;
  }

  else if (tab === 'games') {
    const gp = u ? (u.gamesPlayed||{}) : {};
    const sorted = Object.entries(gp).sort((a,b)=>b[1]-a[1]);
    body.innerHTML = `
      <div style="font-size:11px;color:var(--mut);text-transform:uppercase;letter-spacing:.8px;font-weight:700;margin-bottom:10px">All Played Games (${sorted.length})</div>
      <div class="games-played-list">
        ${sorted.length ? sorted.map(([id,ct]) => {
          const gi = GAMES.find(g=>g.id===id);
          return gi ? `<div class="gpl-row" style="cursor:pointer" onclick="closeProfile();startGame('${id}')"><span class="gpl-em">${gi.e}</span><span class="gpl-name">${gi.name}</span><span class="gpl-plays">${ct}√ó ¬∑ Play again ‚ñ∂</span></div>` : '';
        }).join('') : `<div style="color:var(--mut);font-size:13px;padding:20px;text-align:center">You haven't played any games yet!</div>`}
      </div>`;
  }

  else if (tab === 'admin') {
    if (!currentUser || !isAdmin(currentUser)) {
      body.innerHTML = `<div style="text-align:center;padding:40px;color:var(--red)">Access denied.</div>`;
      return;
    }
    renderAdminPanel(body);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADMIN PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAdminPanel(body) {
  const allUsers = getUsers();
  const userList = Object.entries(allUsers);
  const totalPlays = userList.reduce((s,[,u])=>s+(u.totalPlays||0),0);
  const bannedCount = userList.filter(([,u])=>u.banned).length;
  const adminCount = userList.filter(([un])=>isAdmin(un)).length;

  body.innerHTML = `
  <div class="admin-stat-row">
    <div class="admin-stat"><div class="asv">${userList.length}</div><div class="asl">Users</div></div>
    <div class="admin-stat"><div class="asv">${totalPlays}</div><div class="asl">Total Plays</div></div>
    <div class="admin-stat"><div class="asv">${adminCount}</div><div class="asl">Admins</div></div>
    <div class="admin-stat"><div class="asv">${bannedCount}</div><div class="asl">Banned</div></div>
  </div>

  ${isOwner(currentUser) ? `
  <div class="admin-section-title">‚öôÔ∏è Quick Actions</div>
  <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px">
    <button class="btn-admin-sm" onclick="adminPromoteByInput()" style="border-color:var(--blu);color:#80b0ff">‚ûï Promote to Admin</button>
    <button class="btn-admin-sm danger" onclick="adminDemoteByInput()">‚ûñ Demote Admin</button>
    <button class="btn-admin-sm danger" onclick="adminBanByInput()">üö´ Ban User</button>
    <button class="btn-admin-sm success" onclick="adminUnbanByInput()">‚úÖ Unban User</button>
    <button class="btn-admin-sm warn" onclick="adminResetStatsBy()">üóë Reset User Stats</button>
    <button class="btn-admin-sm danger" onclick="adminDeleteUserBy()">üí• Delete User</button>
  </div>
  <div style="background:var(--surf2);border:1px solid var(--bord);border-radius:10px;padding:10px 14px;margin-bottom:14px">
    <div style="font-size:11px;color:var(--mut);margin-bottom:6px;font-weight:600">Enter username for quick action above:</div>
    <input class="pinput" id="adminTargetInput" placeholder="username..." style="margin-bottom:0" />
  </div>` : ''}

  <div class="admin-section-title">üë§ All Users</div>
  <div id="adminUserList">
    ${userList.length === 0 ? '<div style="color:var(--mut);font-size:13px;padding:12px 0">No registered users yet.</div>' :
    userList.map(([un, u]) => {
      const isMe = un === currentUser;
      const uIsOwner = isOwner(un);
      const uIsAdmin = isAdmin(un) && !uIsOwner;
      const uIsBanned = u.banned;
      const canAct = isOwner(currentUser) && !isMe && !uIsOwner;
      return `<div class="admin-user-row${uIsBanned?' banned':''}">
        <div class="aur-av">${u.avatar||'üë§'}</div>
        <div class="aur-info">
          <div class="aur-name">${u.displayName||un} ${getRoleLabel(un)} ${isMe?'<span style="font-size:10px;color:var(--mut)">(you)</span>':''}</div>
          <div class="aur-sub">@${un} ¬∑ ${u.totalPlays||0} plays ¬∑ Joined ${u.joined||'?'}</div>
        </div>
        ${canAct ? `<div class="aur-actions">
          ${!uIsAdmin ? `<button class="btn-admin-sm success" onclick="adminPromote('${un}')">üõ° Admin</button>` : `<button class="btn-admin-sm warn" onclick="adminDemote('${un}')">Demote</button>`}
          ${!uIsBanned ? `<button class="btn-admin-sm danger" onclick="adminBan('${un}')">üö´ Ban</button>` : `<button class="btn-admin-sm success" onclick="adminUnban('${un}')">‚úÖ Unban</button>`}
          <button class="btn-admin-sm warn" onclick="adminResetStats('${un}')">üóë</button>
          <button class="btn-admin-sm danger" onclick="adminDeleteUser('${un}')">üí•</button>
        </div>` : ''}
      </div>`;
    }).join('')}
  </div>`;
}

// ‚îÄ‚îÄ ADMIN ACTIONS ‚îÄ‚îÄ
function adminPromote(un) {
  if (!isOwner(currentUser)) return;
  if (isOwner(un)) { adminToast('Cannot change Owner role!', '‚ùå'); return; }
  const users = getUsers();
  if (!users[un]) { adminToast('User not found', '‚ùå'); return; }
  users[un].role = 'admin';
  saveUsers(users);
  adminToast(`@${un} is now an Admin üõ°`, 'üõ°');
  renderPTab('admin');
}

function adminDemote(un) {
  if (!isOwner(currentUser)) return;
  if (isOwner(un)) { adminToast('Cannot demote the Owner!', '‚ùå'); return; }
  const users = getUsers();
  if (!users[un]) { adminToast('User not found', '‚ùå'); return; }
  users[un].role = 'user';
  saveUsers(users);
  adminToast(`@${un} has been demoted`, '‚¨áÔ∏è');
  renderPTab('admin');
}

function adminBan(un) {
  if (!isAdmin(currentUser)) return;
  if (isOwner(un)) { adminToast('Cannot ban the Owner!', '‚ùå'); return; }
  if (un === currentUser) { adminToast("Can't ban yourself!", '‚ùå'); return; }
  // Admins can only ban non-admins unless they are owner
  if (isAdmin(un) && !isOwner(currentUser)) { adminToast('Only Owner can ban Admins.', '‚ùå'); return; }
  const users = getUsers();
  if (!users[un]) { adminToast('User not found', '‚ùå'); return; }
  users[un].banned = true;
  saveUsers(users);
  adminToast(`@${un} has been banned üö´`, 'üö´');
  renderPTab('admin');
}

function adminUnban(un) {
  if (!isAdmin(currentUser)) return;
  const users = getUsers();
  if (!users[un]) { adminToast('User not found', '‚ùå'); return; }
  users[un].banned = false;
  saveUsers(users);
  adminToast(`@${un} has been unbanned ‚úÖ`, '‚úÖ');
  renderPTab('admin');
}

function adminResetStats(un) {
  if (!isAdmin(currentUser)) return;
  if (isOwner(un) && !isOwner(currentUser)) { adminToast('Cannot reset Owner stats!', '‚ùå'); return; }
  const users = getUsers();
  if (!users[un]) { adminToast('User not found', '‚ùå'); return; }
  users[un].gamesPlayed = {};
  users[un].totalPlays = 0;
  saveUsers(users);
  adminToast(`@${un}'s stats reset üóë`, 'üóë');
  renderPTab('admin');
}

function adminDeleteUser(un) {
  if (!isOwner(currentUser)) { adminToast('Only Owner can delete users.', '‚ùå'); return; }
  if (isOwner(un)) { adminToast('Cannot delete the Owner!', '‚ùå'); return; }
  if (!confirm(`Delete @${un} permanently? This cannot be undone.`)) return;
  const users = getUsers();
  delete users[un];
  saveUsers(users);
  adminToast(`@${un} deleted üí•`, 'üí•');
  renderPTab('admin');
}

// ‚îÄ‚îÄ INPUT-BASED QUICK ACTIONS (owner panel buttons) ‚îÄ‚îÄ
function getAdminTarget() {
  const val = (document.getElementById('adminTargetInput')||{}).value;
  if (!val) { adminToast('Enter a username first', '‚ùå'); return null; }
  return val.trim();
}
function adminPromoteByInput() { const un=getAdminTarget(); if(un) adminPromote(un); }
function adminDemoteByInput() { const un=getAdminTarget(); if(un) adminDemote(un); }
function adminBanByInput() { const un=getAdminTarget(); if(un) adminBan(un); }
function adminUnbanByInput() { const un=getAdminTarget(); if(un) adminUnban(un); }
function adminResetStatsBy() { const un=getAdminTarget(); if(un) adminResetStats(un); }
function adminDeleteUserBy() { const un=getAdminTarget(); if(un) adminDeleteUser(un); }

function saveProfile() {
  if (!currentUser) return;
  const users = getUsers();
  const u = users[currentUser];
  const dispName = document.getElementById('eDispName');
  const bio = document.getElementById('eBio');
  const selAv = document.querySelector('#editAvGrid .av-opt.sel');
  const secretQ = document.getElementById('eSecretQ');
  const secretA = document.getElementById('eSecretA');
  if (dispName) u.displayName = dispName.value.trim() || currentUser;
  if (bio) u.bio = bio.value.trim();
  if (selAv) u.avatar = selAv.textContent;
  // Secret question ‚Äî only update if a question is selected
  if (secretQ && secretQ.value) {
    u.secretQ = secretQ.value;
    // Only update answer if something was typed
    if (secretA && secretA.value) {
      u.secretA = secretA.value; // case-sensitive, no trim
    } else if (!u.secretA) {
      // Question set but no answer yet ‚Äî don't save incomplete
      const btn = document.getElementById('profSaveBtn');
      btn.textContent = '‚ö†Ô∏è Enter an answer too!';
      setTimeout(() => { btn.textContent = 'Save Changes'; }, 2000);
      return;
    }
  } else if (secretA && secretA.value && u.secretQ) {
    // Just updating the answer
    u.secretA = secretA.value;
  }
  saveUsers(users);
  document.getElementById('profAvBig').textContent = u.avatar;
  document.getElementById('profName').textContent = u.displayName || currentUser;
  updateNavAvatar();
  const btn = document.getElementById('profSaveBtn');
  btn.textContent = '‚úì Saved!';
  setTimeout(() => { btn.textContent = 'Save Changes'; }, 1500);
}

function addFriend() {
  const input = document.getElementById('friendInput');
  const fn = input.value.trim().toLowerCase();
  const err = document.getElementById('frErr');
  err.textContent = '';
  if (!fn) { err.textContent = 'Enter a username.'; return; }
  if (fn === currentUser.toLowerCase()) { err.textContent = "That's you!"; return; }
  const users = getUsers();
  const matchKey = Object.keys(users).find(k => k.toLowerCase() === fn);
  if (!matchKey) { err.textContent = 'User not found.'; return; }
  const u = users[currentUser];
  if (!u.friends) u.friends = [];
  if (u.friends.includes(matchKey)) { err.textContent = 'Already friends!'; return; }
  u.friends.push(matchKey);
  saveUsers(users);
  input.value = '';
  renderPTab('friends');
}

function removeFriend(fn) {
  const users = getUsers();
  const u = users[currentUser];
  u.friends = (u.friends||[]).filter(f=>f!==fn);
  saveUsers(users);
  renderPTab('friends');
}

// Check for existing session on load
(function() {
  const sess = getSession();
  if (sess) {
    const users = getUsers();
    if (users[sess]) {
      currentUser = sess;
      if (users[sess].banned) {
        document.getElementById('loginScreen').style.display = 'none';
        showBanScreen(sess);
        return;
      }
      enterApp();
      return;
    }
  }
  // Show login screen (already visible by default)
})();

// Vortex canvas 2 for login screen (reuse same animation style)
(function() {
  const canvas = document.getElementById('vortexCanvas2');
  if (!canvas) return;
  const ctx2 = canvas.getContext('2d');
  let W2, H2;
  function resize2() { W2 = canvas.width = window.innerWidth; H2 = canvas.height = window.innerHeight; }
  resize2();
  window.addEventListener('resize', resize2);
  const pts = [];
  for (let i=0;i<180;i++){const a=(i/180)*Math.PI*2*5;const r=20+(i/180)*250;pts.push({baseAngle:a,baseRadius:r,speed:0.0003+Math.random()*0.0004,size:0.8+Math.random()*2.5,opacity:0.3+Math.random()*0.7,phase:Math.random()*Math.PI*2});}
  let t2=0;
  function draw2(){
    ctx2.clearRect(0,0,W2,H2);
    const cx=W2*0.5,cy=H2*0.5;
    pts.forEach((p,i)=>{
      const ang=p.baseAngle+t2*p.speed*1000;
      const wb=Math.sin(t2*0.8+p.phase)*15;
      const r=p.baseRadius+wb;
      const x=cx+Math.cos(ang)*r, y=cy+Math.sin(ang)*r*0.45;
      const brt=62+(i/180)*20;
      ctx2.beginPath();ctx2.arc(x,y,p.size,0,Math.PI*2);
      ctx2.fillStyle=`hsla(${42+Math.sin(p.phase+t2*0.5)*12},85%,${brt}%,${p.opacity*(0.5+0.5*Math.sin(t2*0.3+p.phase))})`;
      ctx2.fill();
    });
    t2+=0.016;
    requestAnimationFrame(draw2);
  }
  draw2();
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LEADERBOARD SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let lbPeriod = 'alltime';
let lbGameFilter = 'all';

// Store timestamped play events for time-based filtering
function recordPlay(gameId) {
  if (!currentUser) return;
  const key = 'pg_plays';
  let plays = [];
  try { plays = JSON.parse(localStorage.getItem(key)) || []; } catch(e) {}
  plays.push({ user: currentUser, game: gameId, ts: Date.now() });
  // Keep last 10000 entries max
  if (plays.length > 10000) plays = plays.slice(-10000);
  try { localStorage.setItem(key, JSON.stringify(plays)); } catch(e) {}
}

function getPlayLog() {
  try { return JSON.parse(localStorage.getItem('pg_plays')) || []; } catch(e) { return []; }
}

function periodStart(period) {
  const now = new Date();
  if (period === 'daily') {
    return new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
  }
  if (period === 'weekly') {
    const d = new Date(now); d.setHours(0,0,0,0);
    d.setDate(d.getDate() - d.getDay()); // Sunday start
    return d.getTime();
  }
  if (period === 'monthly') {
    return new Date(now.getFullYear(), now.getMonth(), 1).getTime();
  }
  return 0; // alltime
}

function buildLbData(period, gameId) {
  const users = getUsers();
  const scores = {}; // username -> play count

  if (period === 'alltime') {
    // Use stored gamesPlayed directly (fast)
    Object.entries(users).forEach(([un, u]) => {
      if (u.banned) return;
      const gp = u.gamesPlayed || {};
      if (gameId === 'all') {
        scores[un] = u.totalPlays || 0;
      } else {
        scores[un] = gp[gameId] || 0;
      }
    });
  } else {
    // Use timestamped play log
    const cutoff = periodStart(period);
    const log = getPlayLog().filter(p => p.ts >= cutoff);
    log.forEach(p => {
      if (gameId !== 'all' && p.game !== gameId) return;
      if (users[p.user] && users[p.user].banned) return;
      scores[p.user] = (scores[p.user] || 0) + 1;
    });
  }

  return Object.entries(scores)
    .filter(([,s]) => s > 0)
    .sort((a,b) => b[1] - a[1])
    .slice(0, 50)
    .map(([un, score]) => ({
      username: un,
      score,
      user: users[un] || { avatar: 'üë§', displayName: un }
    }));
}

function openLeaderboard() {
  // Populate game selector
  const sel = document.getElementById('lbGameSel');
  sel.innerHTML = '<option value="all">üéÆ All Games</option>';
  GAMES.forEach(g => {
    const opt = document.createElement('option');
    opt.value = g.id;
    opt.textContent = g.e + ' ' + g.name;
    sel.appendChild(opt);
  });
  sel.value = lbGameFilter;
  document.getElementById('lbModal').classList.add('open');
  renderLeaderboard();
}

function closeLeaderboard() {
  document.getElementById('lbModal').classList.remove('open');
}

function setLbPeriod(p) {
  lbPeriod = p;
  document.querySelectorAll('.lb-pill').forEach(el => el.classList.toggle('active', el.dataset.period === p));
  renderLeaderboard();
}

function renderLeaderboard() {
  lbGameFilter = document.getElementById('lbGameSel').value;
  const data = buildLbData(lbPeriod, lbGameFilter);
  const body = document.getElementById('lbBody');
  const gameInfo = lbGameFilter !== 'all' ? GAMES.find(g => g.id === lbGameFilter) : null;
  const scoreLabel = lbGameFilter === 'all' ? 'Total Plays' : 'Plays';
  const periodLabels = { alltime: 'All Time', monthly: 'This Month', weekly: 'This Week', daily: 'Today' };

  if (!data.length) {
    body.innerHTML = `<div class="lb-empty">
      <div>${gameInfo ? gameInfo.e : 'üèÜ'}</div>
      <p style="font-size:14px;color:var(--txt);font-weight:600;margin-bottom:6px">No data yet</p>
      <p style="font-size:13px">Play some games to appear on the ${periodLabels[lbPeriod]} leaderboard!</p>
    </div>`;
    return;
  }

  const medals = ['ü•á','ü•à','ü•â'];
  const topClass = ['top1','top2','top3'];

  body.innerHTML = data.map((entry, i) => {
    const isMe = entry.username === currentUser;
    const u = entry.user;
    const rankDisplay = i < 3 ? `<span style="font-size:20px">${medals[i]}</span>` : `<span class="lb-rank" style="color:var(--mut)">#${i+1}</span>`;
    const roleTag = typeof getRoleLabel === 'function' ? getRoleLabel(entry.username) : '';
    return `<div class="lb-row ${topClass[i]||''} ${isMe?'lb-me':''}">
      ${rankDisplay}
      <div class="lb-av">${u.avatar || 'üë§'}</div>
      <div class="lb-info">
        <div class="lb-name">${u.displayName || entry.username} ${roleTag} ${isMe ? '<span style="font-size:10px;background:rgba(201,168,76,.2);color:var(--gold);padding:1px 6px;border-radius:5px;font-weight:700">You</span>' : ''}</div>
        <div class="lb-sub">@${entry.username}</div>
      </div>
      <div style="text-align:right;flex-shrink:0">
        <div class="lb-score">${entry.score.toLocaleString()}</div>
        <div class="lb-score-label">${scoreLabel}</div>
      </div>
    </div>`;
  }).join('');
}

// Hook into trackGamePlay to also record timestamped plays

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MESSAGING SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Messages stored as: pg_msgs = { threadId: { participants:[u1,u2], messages:[{from,text,ts,type,appealId}], unread:{u1:0,u2:0} } }
function getMsgs() { try { return JSON.parse(localStorage.getItem('pg_msgs')) || {}; } catch(e) { return {}; } }
function saveMsgs(m) { try { localStorage.setItem('pg_msgs', JSON.stringify(m)); } catch(e) {} }

function threadId(a, b) { return [a,b].sort().join('::'); }

function getOrCreateThread(a, b) {
  const msgs = getMsgs();
  const tid = threadId(a, b);
  if (!msgs[tid]) {
    msgs[tid] = { participants: [a, b], messages: [], unread: { [a]: 0, [b]: 0 } };
    saveMsgs(msgs);
  }
  return tid;
}

function sendMessage(toUser, text, type='msg', meta={}) {
  if (!currentUser || !text.trim()) return;
  const tid = getOrCreateThread(currentUser, toUser);
  // Re-fetch after getOrCreateThread to get the latest saved state
  const msgs = getMsgs();
  if (!msgs[tid]) return;
  const msg = { from: currentUser, text: text.trim(), ts: Date.now(), type, ...meta };
  msgs[tid].messages.push(msg);
  if (!msgs[tid].unread) msgs[tid].unread = {};
  msgs[tid].unread[toUser] = (msgs[tid].unread[toUser] || 0) + 1;
  saveMsgs(msgs);
  return tid;
}

function getUnreadCount() {
  if (!currentUser) return 0;
  const msgs = getMsgs();
  return Object.values(msgs).reduce((sum, t) => {
    if (!t.participants || !t.participants.includes(currentUser)) return sum;
    return sum + (t.unread && t.unread[currentUser] || 0);
  }, 0);
}

function markThreadRead(tid) {
  if (!currentUser) return;
  const msgs = getMsgs();
  if (msgs[tid] && msgs[tid].unread) {
    msgs[tid].unread[currentUser] = 0;
    saveMsgs(msgs);
  }
  updateMsgBadge();
}

function updateMsgBadge() {
  const count = getUnreadCount();
  const dot = document.getElementById('navMsgDot');
  const badge = document.getElementById('msgUnreadBadge');
  if (dot) { dot.classList.toggle('show', count > 0); }
  if (badge) { badge.style.display = count > 0 ? '' : 'none'; badge.textContent = count; }
}

// ‚îÄ‚îÄ BAN SCREEN ‚îÄ‚îÄ
function showBanScreen(username) {
  document.getElementById('homePage').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('banScreen').classList.add('open');
  // Check if already appealed
  const msgs = getMsgs();
  const admins = [OWNER_USERNAME, ...Object.keys(getUsers()).filter(u => isAdmin(u) && !isOwner(u))];
  // Check if there's a pending appeal
  let alreadyAppealed = false;
  Object.values(msgs).forEach(t => {
    if (!t.participants || !t.participants.includes(username)) return;
    t.messages.forEach(m => { if (m.type === 'appeal' && m.from === username) alreadyAppealed = true; });
  });
  if (alreadyAppealed) {
    document.getElementById('banAppealText').style.display = 'none';
    document.querySelector('#banAppealSection button').style.display = 'none';
    document.getElementById('banAppealMsg').textContent = '‚è≥ Your appeal has been submitted and is under review.';
    document.getElementById('banAppealMsg').style.color = 'var(--gold)';
  }
}

function submitAppeal() {
  const text = document.getElementById('banAppealText').value.trim();
  if (!text) { document.getElementById('banAppealMsg').textContent = 'Please write your appeal first.'; document.getElementById('banAppealMsg').style.color='var(--red)'; return; }
  // Send appeal to owner and all admins
  const allUsers = getUsers();
  const targets = Object.keys(allUsers).filter(u => isAdmin(u));
  if (targets.length === 0) targets.push(OWNER_USERNAME);
  // Use a fake currentUser temporarily to send even while banned
  const bannedUser = getSession();
  if (!bannedUser) return;
  const msgs = getMsgs();
  targets.forEach(admin => {
    const tid = threadId(bannedUser, admin);
    if (!msgs[tid]) msgs[tid] = { participants: [bannedUser, admin], messages: [], unread: {} };
    msgs[tid].messages.push({ from: bannedUser, text, ts: Date.now(), type: 'appeal' });
    msgs[tid].unread[admin] = (msgs[tid].unread[admin] || 0) + 1;
  });
  saveMsgs(msgs);
  document.getElementById('banAppealText').style.display = 'none';
  document.querySelector('#banAppealSection button').style.display = 'none';
  document.getElementById('banAppealMsg').textContent = '‚úÖ Appeal submitted! An admin will review it soon.';
  document.getElementById('banAppealMsg').style.color = 'var(--grn)';
}

function doBanLogout() {
  setSession(null);
  document.getElementById('banScreen').classList.remove('open');
  document.getElementById('loginScreen').style.display = 'flex';
}

// ‚îÄ‚îÄ MESSAGES MODAL ‚îÄ‚îÄ
let activeThread = null;

function openMessages() {
  document.getElementById('msgModal').classList.add('open');
  renderThreadList();
  if (activeThread) openThread(activeThread);
}

function closeMessages() {
  document.getElementById('msgModal').classList.remove('open');
}

function renderThreadList() {
  if (!currentUser) return;
  const msgs = getMsgs();
  const allUsers = getUsers();
  const list = document.getElementById('msgThreadList');
  const myThreads = Object.entries(msgs)
    .filter(([,t]) => t.participants && t.participants.includes(currentUser))
    .sort((a,b) => {
      const lastA = a[1].messages[a[1].messages.length-1];
      const lastB = b[1].messages[b[1].messages.length-1];
      return (lastB ? lastB.ts : 0) - (lastA ? lastA.ts : 0);
    });

  if (!myThreads.length) {
    list.innerHTML = '<div style="padding:16px;color:var(--mut);font-size:12px;text-align:center">No messages yet</div>';
    return;
  }

  list.innerHTML = myThreads.map(([tid, t]) => {
    const other = t.participants.find(p => p !== currentUser);
    const ou = allUsers[other] || { avatar: 'üë§', displayName: other };
    const last = t.messages[t.messages.length - 1];
    const unread = t.unread && t.unread[currentUser] || 0;
    const preview = last ? (last.type === 'appeal' ? 'üì® Ban appeal' : last.text) : 'No messages';
    const timeStr = last ? formatMsgTime(last.ts) : '';
    const isActive = tid === activeThread;
    return `<div class="msg-thread${isActive?' active':''}${unread?' unread':''}" onclick="openThread('${tid}')">
      <div class="msg-thread-name">
        <span>${ou.avatar||'üë§'}</span> ${ou.displayName||other} ${getRoleLabel(other)}
        ${unread ? `<span class="msg-thread-dot"></span>` : ''}
      </div>
      <div class="msg-thread-preview">${escHtml(preview)}</div>
      <div class="msg-thread-time">${timeStr}</div>
    </div>`;
  }).join('');
}

function openThread(tid) {
  activeThread = tid;
  markThreadRead(tid);
  const msgs = getMsgs();
  const t = msgs[tid];
  if (!t) return;
  const allUsers = getUsers();
  const other = t.participants.find(p => p !== currentUser);
  const ou = allUsers[other] || { avatar: 'üë§', displayName: other };
  const content = document.getElementById('msgContent');
  content.innerHTML = `
    <div class="msg-chat-header">
      <div class="msg-chat-av">${ou.avatar||'üë§'}</div>
      <div>
        <div class="msg-chat-name">${escHtml(ou.displayName||other)} ${getRoleLabel(other)}</div>
        <div class="msg-chat-sub">@${other}</div>
      </div>
    </div>
    <div class="msg-messages" id="msgMessages"></div>
    <div class="msg-input-row">
      <input class="msg-input" id="msgInputBox" placeholder="Type a message..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendAndRender();}"/>
      <button class="msg-send-btn" onclick="sendAndRender()">Send</button>
    </div>`;
  renderMessages(tid, other);
  renderThreadList();
  setTimeout(() => {
    const inp = document.getElementById('msgInputBox');
    if (inp) inp.focus();
    const mm = document.getElementById('msgMessages');
    if (mm) mm.scrollTop = mm.scrollHeight;
  }, 50);
}

function renderMessages(tid, other) {
  const msgs = getMsgs();
  const t = msgs[tid];
  if (!t) return;
  const allUsers = getUsers();
  const mm = document.getElementById('msgMessages');
  if (!mm) return;
  if (!t.messages.length) {
    mm.innerHTML = '<div style="text-align:center;color:var(--mut);font-size:12px;padding:20px">No messages yet ‚Äî say hello!</div>';
    return;
  }
  mm.innerHTML = t.messages.map((m, i) => {
    const isMe = m.from === currentUser;
    const isAppeal = m.type === 'appeal';
    const sender = allUsers[m.from] || { avatar:'üë§', displayName: m.from };
    const canActOnAppeal = isAppeal && !isMe && isAdmin(currentUser) && allUsers[m.from] && allUsers[m.from].banned;
    return `<div class="msg-bubble-wrap ${isMe?'me':'them'}">
      ${!isMe ? `<div style="font-size:10px;color:var(--mut);margin-bottom:2px;padding-left:2px">${sender.avatar} ${escHtml(sender.displayName||m.from)}</div>` : ''}
      <div class="msg-bubble${isAppeal?' appeal':''}">
        ${isAppeal ? `<div style="font-size:11px;font-weight:700;color:#80b0ff;margin-bottom:4px">üì® Ban Appeal</div>` : ''}
        ${escHtml(m.text)}
        ${canActOnAppeal ? `<div class="appeal-actions">
          <button class="appeal-btn appeal-accept" onclick="handleAppeal('${m.from}','accept','${tid}')">‚úÖ Accept & Unban</button>
          <button class="appeal-btn appeal-decline" onclick="handleAppeal('${m.from}','decline','${tid}')">‚ùå Decline</button>
        </div>` : ''}
        ${m.type==='appeal' && m.appealStatus ? `<div style="font-size:11px;margin-top:6px;font-weight:700;color:${m.appealStatus==='accepted'?'var(--grn)':'var(--red)'}">${m.appealStatus==='accepted'?'‚úÖ Appeal Accepted':'‚ùå Appeal Declined'}</div>` : ''}
      </div>
      <div class="msg-bubble-time">${formatMsgTime(m.ts)}</div>
    </div>`;
  }).join('');
  mm.scrollTop = mm.scrollHeight;
}

function sendAndRender() {
  if (!activeThread || !currentUser) return;
  const inp = document.getElementById('msgInputBox');
  if (!inp || !inp.value.trim()) return;
  const msgs = getMsgs();
  const t = msgs[activeThread];
  const other = t.participants.find(p => p !== currentUser);
  sendMessage(other, inp.value.trim());
  inp.value = '';
  renderMessages(activeThread, other);
  renderThreadList();
  updateMsgBadge();
}

function handleAppeal(fromUser, action, tid) {
  if (!isAdmin(currentUser)) return;
  const users = getUsers();
  const msgs = getMsgs();
  const t = msgs[tid];
  if (!t) return;
  // Find and update the appeal message
  t.messages.forEach(m => {
    if (m.type === 'appeal' && m.from === fromUser && !m.appealStatus) {
      m.appealStatus = action === 'accept' ? 'accepted' : 'declined';
    }
  });
  if (action === 'accept') {
    if (users[fromUser]) { users[fromUser].banned = false; saveUsers(users); }
    // Send notification to user
    const notifyTid = threadId(currentUser, fromUser);
    if (!msgs[notifyTid]) msgs[notifyTid] = { participants:[currentUser, fromUser], messages:[], unread:{} };
    msgs[notifyTid].messages.push({ from: currentUser, text: '‚úÖ Your ban appeal has been accepted! You can now log in again.', ts: Date.now(), type: 'msg' });
    msgs[notifyTid].unread[fromUser] = (msgs[notifyTid].unread[fromUser]||0)+1;
    adminToast(`@${fromUser} has been unbanned ‚úÖ`, '‚úÖ');
  } else {
    const notifyTid = threadId(currentUser, fromUser);
    if (!msgs[notifyTid]) msgs[notifyTid] = { participants:[currentUser, fromUser], messages:[], unread:{} };
    msgs[notifyTid].messages.push({ from: currentUser, text: '‚ùå Your ban appeal has been reviewed and declined. The ban remains in effect.', ts: Date.now(), type: 'msg' });
    msgs[notifyTid].unread[fromUser] = (msgs[notifyTid].unread[fromUser]||0)+1;
    adminToast(`Appeal from @${fromUser} declined`, '‚ùå');
  }
  saveMsgs(msgs);
  renderMessages(tid, t.participants.find(p=>p!==currentUser));
  renderThreadList();
}

function showNewMessage() {
  if (!currentUser) return;
  const allUsers = getUsers();
  const u = allUsers[currentUser];
  const friends = (u && u.friends) || [];
  // Admins can message anyone, friends can message friends
  let targets = isAdmin(currentUser)
    ? Object.keys(allUsers).filter(un => un !== currentUser)
    : friends;
  const content = document.getElementById('msgContent');
  content.innerHTML = `
    <div class="msg-chat-header">
      <div style="font-size:18px">‚úâÔ∏è</div>
      <div class="msg-chat-name" style="flex:1">New Message</div>
    </div>
    <div class="msg-compose">
      <label>To</label>
      <select id="composeToSel">
        <option value="">‚Äî Select recipient ‚Äî</option>
        ${targets.map(un => {
          const tu = allUsers[un];
          return `<option value="${un}">${tu?tu.avatar:''} ${tu?tu.displayName:un} (@${un})</option>`;
        }).join('')}
      </select>
      <label>Message</label>
      <textarea id="composeMsgText" placeholder="Type your message..."></textarea>
      <button class="msg-new-btn" onclick="doSendNewMessage()" style="padding:10px">Send Message ‚û§</button>
      <div id="composeMsgErr" style="font-size:12px;color:var(--red);min-height:16px"></div>
    </div>`;
}

function doSendNewMessage() {
  const to = document.getElementById('composeToSel').value;
  const text = document.getElementById('composeMsgText').value.trim();
  const err = document.getElementById('composeMsgErr');
  if (!to) { err.textContent = 'Please select a recipient.'; return; }
  if (!text) { err.textContent = 'Please write a message.'; return; }
  const tid = sendMessage(to, text);
  activeThread = tid;
  openThread(tid);
  updateMsgBadge();
}

function formatMsgTime(ts) {
  const d = new Date(ts), now = new Date();
  const diff = now - d;
  if (diff < 60000) return 'just now';
  if (diff < 3600000) return Math.floor(diff/60000) + 'm ago';
  if (diff < 86400000) return Math.floor(diff/3600000) + 'h ago';
  if (d.toDateString() === now.toDateString()) return d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  return d.toLocaleDateString([],{month:'short',day:'numeric'});
}

function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
</script>

<!-- ‚ïê‚ïê‚ïê GAME SCREEN ‚ïê‚ïê‚ïê -->
<div id="GS">
  <div class="gs-body" id="gsBody"></div>
  <!-- In-game admin panel (only shown to admins/owner) -->
  <button id="gameAdminBtn" onclick="toggleGameAdmin()">üëë Admin</button>
  <div id="gameAdminPanel">
    <div class="gap-header">
      <span id="gapTitle">üéÆ Game Admin</span>
      <button class="gap-close" onclick="toggleGameAdmin()">‚úï</button>
    </div>
    <div class="gap-body" id="gapBody"></div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PARALLAX GOLDEN VORTEX
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function() {
  const canvas = document.getElementById('vortexCanvas');
  const ctx = canvas.getContext('2d');
  let W, H, mx = 0, my = 0, scrollY = 0;
  let particles = [];
  const N = 280;

  function resize() {
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight;
  }
  resize();
  window.addEventListener('resize', resize);

  window.addEventListener('mousemove', e => { mx = e.clientX; my = e.clientY; });
  window.addEventListener('scroll', () => { scrollY = window.scrollY; });

  for (let i = 0; i < N; i++) {
    const angle = (i / N) * Math.PI * 2 * 7;
    const radius = 30 + (i / N) * 320;
    particles.push({
      baseAngle: angle,
      baseRadius: radius,
      speed: 0.0003 + Math.random() * 0.0004,
      size: 0.8 + Math.random() * 3.2,
      opacity: 0.25 + Math.random() * 0.75,
      phase: Math.random() * Math.PI * 2,
      drift: (Math.random() - 0.5) * 0.5,
    });
  }

  let t = 0;
  function draw() {
    ctx.clearRect(0, 0, W, H);

    // parallax offset from mouse and scroll
    const px = (mx / W - 0.5) * 60;
    const py = (my / H - 0.5) * 40 - scrollY * 0.08;
    const cx = W * 0.12 + px;
    const cy = H * 0.35 + py;

    // Central glow halo
    const grad = ctx.createRadialGradient(cx, cy, 0, cx, cy, 200);
    grad.addColorStop(0, 'rgba(255,210,80,0.22)');
    grad.addColorStop(0.5, 'rgba(200,150,40,0.08)');
    grad.addColorStop(1, 'rgba(0,0,0,0)');
    ctx.fillStyle = grad;
    ctx.beginPath(); ctx.arc(cx, cy, 200, 0, Math.PI*2); ctx.fill();

    particles.forEach((p, i) => {
      const angle = p.baseAngle + t * p.speed * 1000 + p.drift * t * 0.01;
      const wobble = Math.sin(t * 0.8 + p.phase) * 18;
      const r = p.baseRadius + wobble;
      const x = cx + Math.cos(angle) * r;
      const y = cy + Math.sin(angle) * r * 0.38; // flatten into ellipse

      const progress = i / N;
      const brightness = 62 + progress * 22;
      const gold = `hsla(${42 + Math.sin(p.phase + t * 0.5) * 14}, 88%, ${brightness}%, ${p.opacity * (0.55 + 0.45 * Math.sin(t * 0.3 + p.phase))})`;

      ctx.beginPath();
      ctx.arc(x, y, p.size, 0, Math.PI * 2);
      ctx.fillStyle = gold;
      ctx.fill();
    });

    // Draw spiral arms as curves
    for (let arm = 0; arm < 3; arm++) {
      ctx.beginPath();
      for (let j = 0; j < 120; j++) {
        const frac = j / 120;
        const angle = (arm / 3) * Math.PI * 2 + frac * Math.PI * 6 + t * 0.0004;
        const r = 20 + frac * 300 + Math.sin(t * 0.5 + frac * 8) * 10;
        const x = cx + Math.cos(angle) * r;
        const y = cy + Math.sin(angle) * r * 0.38;
        if (j === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
      }
      ctx.strokeStyle = `hsla(42, 80%, 68%, ${0.1 + 0.04 * arm})`;
      ctx.lineWidth = 1.5;
      ctx.stroke();
    }

    t += 0.016;
    requestAnimationFrame(draw);
  }
  draw();
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GAME REGISTRY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const GAMES = [
  // ARCADE
  {id:'snake',     name:'Snake',           cat:'arcade',   e:'üêç',  c1:'#0d3020',c2:'#1a6040', hot:true,  desc:'Classic snake ‚Äî eat & grow without crashing!'},
  {id:'flappy',    name:'Flappy Bird',     cat:'arcade',   e:'üê¶',  c1:'#0a1f35',c2:'#1a4070', isnew:false,desc:'Tap to fly through pipes! How far can you go?'},
  {id:'dino',      name:'Dino Run',        cat:'arcade',   e:'ü¶ï',  c1:'#1a1a1a',c2:'#333',    hot:true,  desc:'Google\'s famous dino ‚Äî jump cacti, survive!'},
  {id:'pacman',    name:'Pac-Man',         cat:'arcade',   e:'üëæ',  c1:'#1e1c00',c2:'#3a3800', hot:true,  desc:'Eat dots, dodge ghosts, eat power pellets!'},
  {id:'breakout',  name:'Breakout',        cat:'arcade',   e:'üß±',  c1:'#200018',c2:'#400030', isnew:false,desc:'Classic Atari Breakout ‚Äî smash all the bricks!'},
  // PUZZLE
  {id:'tetris',    name:'Tetris',          cat:'puzzle',   e:'üü¶',  c1:'#001628',c2:'#003060', hot:true,  desc:'Stack blocks, clear lines, beat your score!'},
  {id:'g2048',     name:'2048',            cat:'puzzle',   e:'üî¢',  c1:'#1c1808',c2:'#3a3010', isnew:false,desc:'Merge tiles to reach 2048!'},
  {id:'minesweep', name:'Minesweeper',     cat:'puzzle',   e:'üí£',  c1:'#0a1400',c2:'#183000', isnew:false,desc:'Classic Windows Minesweeper ‚Äî avoid all mines!'},
  {id:'sudoku',    name:'Sudoku',          cat:'puzzle',   e:'üî≤',  c1:'#0a0a20',c2:'#14145a', isnew:true, desc:'Fill the 9√ó9 grid ‚Äî every row, column & box!'},
  // WORD
  {id:'wordle',    name:'Wordle',          cat:'word',     e:'üü©',  c1:'#0a180a',c2:'#143214', isnew:false,desc:'NYT-style ‚Äî guess the 5-letter word in 6 tries!'},
  {id:'trivia',    name:'Trivia Quiz',     cat:'word',     e:'üéØ',  c1:'#140a2e',c2:'#281460', isnew:true, desc:'250+ questions across 5 categories. Beat them all!'},
  {id:'typing',    name:'Typing Speed',    cat:'word',     e:'‚å®Ô∏è',  c1:'#0a1020',c2:'#142040', isnew:true, desc:'Like TypeRacer ‚Äî how many WPM can you hit?'},
  // 2 PLAYER
  {id:'pong',      name:'Pong',            cat:'2player',  e:'üèì',  c1:'#001020',c2:'#002040', isnew:false,desc:'Classic Pong! P1: W/S ¬∑ P2: ‚Üë/‚Üì ¬∑ First to 7!'},
  {id:'connect4',  name:'Connect Four',    cat:'2player',  e:'üî¥',  c1:'#001428',c2:'#002850', isnew:false,desc:'Drop pieces, get 4 in a row to win!'},
  {id:'tictac',    name:'Tic-Tac-Toe',    cat:'2player',  e:'‚ùå',  c1:'#14082a',c2:'#281458', isnew:false,desc:'Classic X vs O ‚Äî who gets 3 in a row first?'},
  {id:'fighter',   name:'Street Fighter',  cat:'fighting', e:'ü•ä',  c1:'#200008',c2:'#400010', isnew:true, desc:'2-Player fighting! WASD+F vs Arrows+L ¬∑ First to 3!'},
  // ACTION / REFLEX
  {id:'spaceshoot',name:'Space Shooter',   cat:'action',   e:'üöÄ',  c1:'#000820',c2:'#001440', hot:true,  desc:'Galaga-style shooter ‚Äî destroy waves of aliens!'},
  {id:'reaction',  name:'Reaction Time',   cat:'reflex',   e:'‚ö°',  c1:'#1a0820',c2:'#340f40', isnew:true, desc:'Click when it turns green ‚Äî test your reflexes!'},
  {id:'aim',       name:'Aim Trainer',     cat:'reflex',   e:'üéØ',  c1:'#200010',c2:'#400020', isnew:true, desc:'Click targets as fast as you can ‚Äî beat your score!'},
  {id:'whack',     name:'Whack-a-Mole',   cat:'reflex',   e:'üî®',  c1:'#1a1000',c2:'#3a2800', isnew:true, desc:'Hit the moles before they disappear! How fast?'},
  // STRATEGY
  {id:'memory',    name:'Memory Match',    cat:'strategy', e:'üÉè',  c1:'#1a0a10',c2:'#341420', isnew:false,desc:'Flip cards and match all pairs with fewest moves!'},
  {id:'checkers',  name:'Checkers',        cat:'strategy', e:'‚ö´',  c1:'#0a0a0a',c2:'#202020', isnew:true, desc:'Classic draughts/checkers ‚Äî jump and capture pieces!'},
  {id:'simon',     name:'Simon Says',      cat:'strategy', e:'üîµ',  c1:'#001428',c2:'#002850', isnew:true, desc:'Remember the color sequence ‚Äî how far can you go?'},
  // MUSIC
  {id:'rhythm',    name:'Rhythm Tap',      cat:'music',    e:'üéµ',  c1:'#1a0030',c2:'#340060', isnew:true, desc:'Guitar Hero style ‚Äî hit the notes on the beat!'},
  // RACING
  {id:'racing3d',  name:'Road Racer',      cat:'racing',   e:'üèéÔ∏è', c1:'#0a1400',c2:'#142800', isnew:true, desc:'Pseudo-3D OutRun style racing ‚Äî dodge traffic!'},
  // ‚îÄ‚îÄ NEW GAMES ‚îÄ‚îÄ
  {id:'asteroids', name:'Asteroids',       cat:'arcade',   e:'‚òÑÔ∏è',  c1:'#050810',c2:'#0a1428', isnew:true, desc:'Classic arcade ‚Äî shoot the rocks before they hit!'},
  {id:'blackjack', name:'Blackjack',       cat:'card',     e:'üÇ°',  c1:'#0a2010',c2:'#143c20', isnew:true, desc:'Beat the dealer to 21 without busting!'},
  {id:'hangman',   name:'Hangman',         cat:'word',     e:'üé≠',  c1:'#200808',c2:'#401010', isnew:true, desc:'Guess the word letter by letter before he hangs!'},
  {id:'mathquiz',  name:'Math Blitz',      cat:'word',     e:'‚ûï',  c1:'#001818',c2:'#003030', isnew:true, desc:'Solve fast math before time runs out!'},
  {id:'slidingtiles',name:'Sliding Tiles', cat:'puzzle',   e:'üîÄ',  c1:'#0e0e1e',c2:'#1c1c3c', isnew:true, desc:'Slide tiles into order ‚Äî the classic 15-puzzle!'},
  // ‚îÄ‚îÄ NEW 5 GAMES ‚îÄ‚îÄ
  {id:'colorflood', name:'Color Flood',   cat:'puzzle',   e:'üåä',  c1:'#0a0020',c2:'#200040', isnew:true, desc:'Flood fill the board with one color in 25 moves!'},
  {id:'bubbles',    name:'Bubble Shooter',cat:'arcade',   e:'ü´ß',  c1:'#001428',c2:'#002a50', isnew:true, desc:'Shoot bubbles to pop matching color clusters!'},
  {id:'scramble',   name:'Word Scramble', cat:'word',     e:'üî§',  c1:'#1a0028',c2:'#380050', isnew:true, desc:'Unscramble the letters to form the word!'},
  {id:'towerdef',   name:'Tower Defense', cat:'strategy', e:'üè∞',  c1:'#0a1800',c2:'#183000', isnew:true, desc:'Place towers to stop enemies reaching the end!'},
  {id:'pairs',      name:'Emoji Pairs',   cat:'reflex',   e:'üòÄ',  c1:'#1a0a10',c2:'#340f20', isnew:true, desc:'Speed-match emoji pairs before time runs out!'},
  // ‚îÄ‚îÄ BATCH 3 NEW GAMES ‚îÄ‚îÄ
  {id:'frogger',    name:'Frogger',       cat:'arcade',   e:'üê∏',  c1:'#001a00',c2:'#003400', isnew:true, desc:'Hop across traffic and logs to reach home!'},
  {id:'numrush',    name:'Number Rush',   cat:'reflex',   e:'üî¢',  c1:'#001428',c2:'#002850', isnew:true, desc:'Click 1‚Üí25 in order as fast as you can!'},
  {id:'missile',    name:'Missile Command',cat:'arcade',  e:'üöÄ',  c1:'#050810',c2:'#0a1428', isnew:true, desc:'Click to intercept incoming missiles!'},
  {id:'lightcycle', name:'Light Cycles',  cat:'2player',  e:'üèçÔ∏è', c1:'#001428',c2:'#002a50', isnew:true, desc:'Tron-style! Trail your opponent into a wall!'},
  {id:'pipes',      name:'Lights Out',   cat:'puzzle',   e:'üí°',  c1:'#0a1800',c2:'#183000', isnew:true, desc:'Toggle all lights off ‚Äî click to flip neighbors!'},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TRENDING CAROUSEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const TRENDING = ['snake','pacman','dino','spaceshoot','fighter','rhythm','racing3d','tetris','trivia','whack','simon'];
let tIdx = 0, tTimer;

function buildTrendDots() {
  const d = document.getElementById('trendDots');
  d.innerHTML = '';
  TRENDING.forEach((_, i) => {
    const dot = document.createElement('div');
    dot.className = 'trend-dot' + (i === 0 ? ' active' : '');
    dot.onclick = () => { tIdx = i; showTrend(); };
    d.appendChild(dot);
  });
}

function showTrend() {
  const g = GAMES.find(x => x.id === TRENDING[tIdx]);
  if (!g) return;
  document.getElementById('trendBg').textContent = g.e;
  document.getElementById('trendBg').style.cssText = `position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:100px;background:radial-gradient(ellipse at 40% 50%,${g.c2} 0%,${g.c1} 60%,#0c0b08 100%)`;
  document.getElementById('trendTitle').textContent = g.name;
  document.getElementById('trendDesc').textContent = g.desc;
  document.querySelectorAll('.trend-dot').forEach((d, i) => d.classList.toggle('active', i === tIdx));
}

function onTrendClick() { startGame(TRENDING[tIdx]); }

function startTrendCycle() {
  buildTrendDots();
  showTrend();
  tTimer = setInterval(() => { tIdx = (tIdx + 1) % TRENDING.length; showTrend(); }, 5000);
}
startTrendCycle();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HOME GRID
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const gGrid = document.getElementById('gGrid');
const srch = document.getElementById('srchIn');
const noRes = document.getElementById('noRes');
const cntEl = document.getElementById('cntEl');
let curCat = 'all';

const CAT_ICON_COLORS = {
  arcade:['#e84040','#ff6060'], puzzle:['#4080e0','#60a0ff'],
  '2player':['#38a838','#60c860'], action:['#e87030','#ff9050'],
  word:['#a050e8','#c070ff'], strategy:['#c8a44a','#e8c46a'],
  music:['#e84080','#ff60a0'], fighting:['#e84040','#c82020'],
  racing:['#38a838','#20c020'], reflex:['#e8c44a','#ffd060']
};

function buildGameCard(g) {
  const d = document.createElement('div');
  d.className = 'gcard';
  const [ic1, ic2] = CAT_ICON_COLORS[g.cat] || ['#c8a44a','#e8c46a'];
  const badgeHTML = g.hot ? '<div class="badge-hot">üî• Hot</div>' : g.isnew ? '<div class="badge-new">New</div>' : '';
  const is2p = (g.cat === '2player' || g.cat === 'fighting') ? '<div class="badge-2p">2P</div>' : '';
  d.innerHTML = `
    <div class="gthumb" style="background:radial-gradient(ellipse at 40% 40%,${g.c2} 0%,${g.c1} 70%,#0c0b08 100%)">
      ${badgeHTML}${is2p}
      <span class="gthumb-emoji">${g.e}</span>
      <div class="pring"><div class="pcirc">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="#0c0b08"><path d="M8 5v14l11-7z"/></svg>
      </div></div>
    </div>
    <div class="ginf">
      <div class="gname">${g.name}</div>
      <div class="gbot"><span class="gcat">${g.cat}</span><span class="garr">Play ‚ñ∂</span></div>
    </div>`;
  d.onclick = () => startGame(g.id);
  return d;
}

function renderHome(list) {
  gGrid.innerHTML = '';
  cntEl.textContent = list.length + ' game' + (list.length !== 1 ? 's' : '');
  if (!list.length) { noRes.classList.add('show'); return; }
  noRes.classList.remove('show');
  list.forEach(g => gGrid.appendChild(buildGameCard(g)));
}

function filterHome() {
  const q = srch.value.toLowerCase();
  let list = GAMES;
  if (curCat !== 'all') list = list.filter(g => g.cat === curCat);
  if (q) list = list.filter(g => g.name.toLowerCase().includes(q) || g.cat.includes(q) || g.desc.toLowerCase().includes(q));
  renderHome(list);
}

document.querySelectorAll('.pill').forEach(p => {
  p.addEventListener('click', () => {
    document.querySelectorAll('.pill').forEach(x => x.classList.remove('active'));
    p.classList.add('active');
    curCat = p.dataset.cat;
    document.getElementById('gridLabel').textContent = p.textContent;
    filterHome();
  });
});
srch.addEventListener('input', filterHome);
renderHome(GAMES);
document.getElementById('statCount').textContent = GAMES.length;

// Dropdown
function toggleDD() { document.getElementById('ddMenu').classList.toggle('open'); }
function closeDD() { document.getElementById('ddMenu').classList.remove('open'); }
document.addEventListener('click', e => { if (!document.getElementById('ddWrap').contains(e.target)) closeDD(); });

function filterCat(cat) {
  goHome();
  setTimeout(() => {
    document.querySelectorAll('.pill').forEach(p => { p.classList.remove('active'); if (p.dataset.cat === cat) p.classList.add('active'); });
    curCat = cat; filterHome(); window.scrollTo({top:400,behavior:'smooth'});
  }, 50);
}

// Fullscreen
function toggleFS() {
  if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{});
  else document.exitFullscreen();
}
document.addEventListener('fullscreenchange', () => {
  const btn = document.getElementById('navFS');
  if (btn) btn.textContent = document.fullscreenElement ? '‚õ∂ Exit FS' : '‚õ∂';
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GAME ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let activeId = null, paused = false;
const CLEANERS = {}, PAUSE_CBS = {};

function startGame(id) {
  activeId = id;
  paused = false;
  const g = GAMES.find(x => x.id === id);
  document.getElementById('homePage').style.display = 'none';
  document.getElementById('GS').classList.add('open');
  document.getElementById('navBack').style.display = 'flex';
  document.getElementById('navPause').style.display = 'flex';
  document.getElementById('navFS').style.display = 'flex';
  document.getElementById('navSearchBox').style.display = 'none';
  document.getElementById('navSpacer').style.display = 'none';
  document.getElementById('navGameName').style.display = 'block';
  document.getElementById('navGameName').textContent = g ? g.e + ' ' + g.name : '';
  document.getElementById('ddWrap').style.display = 'none';
  document.getElementById('navLbBtn').style.display = 'none';
  document.getElementById('gsBody').innerHTML = '';
  // Close admin panel on new game
  document.getElementById('gameAdminPanel').classList.remove('open');
  if (typeof trackGamePlay === 'function') trackGamePlay(id);
  if (BUILDERS[id]) BUILDERS[id](document.getElementById('gsBody'));
  else { document.getElementById('gsBody').innerHTML = `<div style="text-align:center;padding:40px;color:var(--mut)"><div style="font-size:60px;margin-bottom:16px">${g?g.e:'üéÆ'}</div><h2 style="font-family:var(--font-head);color:var(--gold2);margin-bottom:8px">${g?g.name:'Coming Soon'}</h2><p>This game is coming soon!</p><button class="btn-gold" onclick="goHome()" style="margin-top:16px">‚Üê Back</button></div>`; }
  // Show admin button for admins/owner
  const adminBtn = document.getElementById('gameAdminBtn');
  if (typeof isAdmin === 'function' && typeof currentUser !== 'undefined' && currentUser && isAdmin(currentUser)) {
    adminBtn.style.display = 'block';
    adminBtn.textContent = (typeof isOwner === 'function' && isOwner(currentUser)) ? 'üëë Admin' : 'üõ° Admin';
    buildGameAdminPanel(id, g);
  } else {
    adminBtn.style.display = 'none';
  }
}

function goHome() {
  if (activeId && CLEANERS[activeId]) CLEANERS[activeId]();
  activeId = null;
  paused = false;
  document.getElementById('GS').classList.remove('open');
  document.getElementById('homePage').style.display = '';
  document.getElementById('navBack').style.display = 'none';
  document.getElementById('navPause').style.display = 'none';
  document.getElementById('navFS').style.display = 'none';
  document.getElementById('navPause').textContent = '‚è∏ Pause';
  document.getElementById('navSearchBox').style.display = 'flex';
  document.getElementById('navSpacer').style.display = '';
  document.getElementById('navGameName').style.display = 'none';
  document.getElementById('ddWrap').style.display = '';
  document.getElementById('navLbBtn').style.display = '';
  document.getElementById('gsBody').innerHTML = '';
  document.getElementById('gameAdminPanel').classList.remove('open');
  document.getElementById('gameAdminBtn').style.display = 'none';
}

function togglePause() {
  if (!activeId || !PAUSE_CBS[activeId]) return;
  paused = !paused;
  document.getElementById('navPause').textContent = paused ? '‚ñ∂ Resume' : '‚è∏ Pause';
  PAUSE_CBS[activeId](paused);
}

function toggleGameAdmin() {
  document.getElementById('gameAdminPanel').classList.toggle('open');
}

function buildGameAdminPanel(id, g) {
  const gInfo = g || GAMES.find(x => x.id === id);
  document.getElementById('gapTitle').textContent = (gInfo ? gInfo.e + ' ' : '') + (gInfo ? gInfo.name : 'Game') + ' Admin';

  const body = document.getElementById('gapBody');
  const allUsers = (typeof getUsers === 'function') ? getUsers() : {};
  const userList = Object.entries(allUsers);
  const totalPlays = userList.reduce((s,[,u])=>s+(u.gamesPlayed&&u.gamesPlayed[id]||0),0);
  const topPlayers = userList
    .filter(([,u])=>u.gamesPlayed&&u.gamesPlayed[id])
    .sort((a,b)=>(b[1].gamesPlayed[id]||0)-(a[1].gamesPlayed[id]||0))
    .slice(0,5);

  body.innerHTML = `
    <div class="gap-section">üìä Game Stats</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:2px">
      <div style="background:var(--surf2);border:1px solid var(--bord);border-radius:8px;padding:8px;text-align:center">
        <div style="font-family:var(--font-head);font-size:18px;font-weight:800;color:var(--gold2)">${totalPlays}</div>
        <div style="font-size:9px;color:var(--mut);text-transform:uppercase;letter-spacing:.6px">Total Plays</div>
      </div>
      <div style="background:var(--surf2);border:1px solid var(--bord);border-radius:8px;padding:8px;text-align:center">
        <div style="font-family:var(--font-head);font-size:18px;font-weight:800;color:var(--gold2)">${topPlayers.length}</div>
        <div style="font-size:9px;color:var(--mut);text-transform:uppercase;letter-spacing:.6px">Players</div>
      </div>
    </div>

    ${topPlayers.length ? `
    <div class="gap-section" style="margin-top:8px">üèÜ Top Players</div>
    <div style="display:flex;flex-direction:column;gap:4px">
      ${topPlayers.map(([un,u],i)=>`
        <div style="display:flex;align-items:center;gap:7px;background:var(--surf2);border:1px solid var(--bord);border-radius:8px;padding:6px 9px">
          <span style="font-size:14px">${['ü•á','ü•à','ü•â','4Ô∏è‚É£','5Ô∏è‚É£'][i]}</span>
          <span style="font-size:13px">${u.avatar||'üë§'}</span>
          <span style="font-size:12px;font-weight:600;color:var(--txt);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${u.displayName||un}</span>
          <span style="font-size:11px;color:var(--gold);font-weight:700">${u.gamesPlayed[id]}√ó</span>
        </div>`).join('')}
    </div>` : `<div style="color:var(--mut);font-size:12px;text-align:center;padding:8px 0">No plays recorded yet.</div>`}

    <div class="gap-divider"></div>
    <div class="gap-section">‚öôÔ∏è Game Controls</div>

    <button class="gap-btn" onclick="if(PAUSE_CBS[activeId]){paused=!paused;PAUSE_CBS[activeId](paused);document.getElementById('navPause').textContent=paused?'‚ñ∂ Resume':'‚è∏ Pause';this.textContent=paused?'‚ñ∂ Resume Game':'‚è∏ Pause Game';}">‚è∏ Pause Game</button>
    <button class="gap-btn" onclick="startGame(activeId)">üîÑ Restart Game</button>
    <button class="gap-btn danger" onclick="goHome();toggleGameAdmin()">üö™ Force End Game</button>

    ${typeof isOwner === 'function' && typeof currentUser !== 'undefined' && isOwner(currentUser) ? `
    <div class="gap-divider"></div>
    <div class="gap-section">üëë Owner Tools</div>
    <button class="gap-btn danger" onclick="adminWipeGameStats('${id}')">üóë Wipe All Stats for This Game</button>
    ` : ''}

    <div class="gap-divider"></div>
    <div style="font-size:10px;color:var(--mut2);text-align:center;padding:4px 0">Game ID: <code style="color:var(--mut)">${id}</code> ¬∑ Cat: <code style="color:var(--mut)">${gInfo?gInfo.cat:'?'}</code></div>
  `;
}

function adminWipeGameStats(id) {
  if (typeof isOwner === 'function' && !isOwner(currentUser)) { if(typeof adminToast==='function') adminToast('Owner only!','‚ùå'); return; }
  if (!confirm(`Wipe all play data for "${id}" from every user? Cannot be undone.`)) return;
  const users = (typeof getUsers === 'function') ? getUsers() : {};
  Object.values(users).forEach(u => {
    if (u.gamesPlayed && u.gamesPlayed[id]) {
      u.totalPlays = Math.max(0, (u.totalPlays||0) - u.gamesPlayed[id]);
      delete u.gamesPlayed[id];
    }
  });
  if (typeof saveUsers === 'function') saveUsers(users);
  if (typeof adminToast === 'function') adminToast(`Stats wiped for "${id}" üóë`, 'üóë');
  buildGameAdminPanel(id, GAMES.find(x=>x.id===id));
}

const BUILDERS = {};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SFX ‚Äî Web Audio sound engine (no external files)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SFX = (function(){
  let ac = null;
  function ctx() {
    if (!ac) ac = new (window.AudioContext || window.webkitAudioContext)();
    if (ac.state === 'suspended') ac.resume();
    return ac;
  }
  function tone(freq, type, vol, dur, delay) {
    try {
      const c = ctx(), o = c.createOscillator(), g = c.createGain();
      o.connect(g); g.connect(c.destination);
      o.type = type || 'sine'; o.frequency.setValueAtTime(freq, c.currentTime + (delay||0));
      g.gain.setValueAtTime(vol || 0.2, c.currentTime + (delay||0));
      g.gain.exponentialRampToValueAtTime(0.0001, c.currentTime + (delay||0) + (dur||0.15));
      o.start(c.currentTime + (delay||0));
      o.stop(c.currentTime + (delay||0) + (dur||0.15) + 0.01);
    } catch(e) {}
  }
  function sweep(f1, f2, type, vol, dur) {
    try {
      const c = ctx(), o = c.createOscillator(), g = c.createGain();
      o.connect(g); g.connect(c.destination);
      o.type = type || 'sine';
      o.frequency.setValueAtTime(f1, c.currentTime);
      o.frequency.exponentialRampToValueAtTime(f2, c.currentTime + (dur||0.15));
      g.gain.setValueAtTime(vol || 0.2, c.currentTime);
      g.gain.exponentialRampToValueAtTime(0.0001, c.currentTime + (dur||0.15));
      o.start(c.currentTime); o.stop(c.currentTime + (dur||0.15) + 0.01);
    } catch(e) {}
  }
  function noise(vol, dur) {
    try {
      const c = ctx(), buf = c.createBuffer(1, c.sampleRate * dur, c.sampleRate);
      const d = buf.getChannelData(0); for (let i=0;i<d.length;i++) d[i]=Math.random()*2-1;
      const src = c.createBufferSource(), g = c.createGain();
      src.buffer = buf; src.connect(g); g.connect(c.destination);
      g.gain.setValueAtTime(vol||0.15, c.currentTime);
      g.gain.exponentialRampToValueAtTime(0.0001, c.currentTime + dur);
      src.start(c.currentTime); src.stop(c.currentTime + dur + 0.01);
    } catch(e) {}
  }
  return {
    blip:    ()=>tone(520,'square',.15,.06),
    pop:     ()=>sweep(300,180,'sine',.18,.08),
    beep:    ()=>tone(880,'sine',.2,.1),
    eat:     ()=>sweep(440,880,'sine',.15,.07),
    shoot:   ()=>sweep(600,200,'sawtooth',.1,.08),
    explode: ()=>noise(.25,.22),
    hit:     ()=>{ noise(.15,.08); sweep(300,80,'sawtooth',.1,.1); },
    bounce:  ()=>tone(400,'sine',.12,.06),
    jump:    ()=>sweep(280,640,'sine',.15,.12),
    score:   ()=>{ tone(660,'sine',.15,.08); tone(880,'sine',.12,.08,0.08); },
    win:     ()=>{ tone(523,'sine',.18,.1); tone(659,'sine',.18,.1,0.1); tone(784,'sine',.18,.1,0.2); tone(1047,'sine',.2,.25,0.3); },
    lose:    ()=>{ tone(300,'sawtooth',.18,.12); tone(200,'sawtooth',.18,.2,0.15); },
    clear:   ()=>{ tone(523,'square',.14,.08); tone(659,'square',.14,.08,0.09); tone(784,'square',.14,.08,0.18); tone(1047,'square',.16,.15,0.27); },
    drop:    ()=>tone(200,'sine',.12,.08),
    denied:  ()=>tone(200,'square',.18,.15),
    card:    ()=>sweep(800,400,'sine',.1,.08),
    match:   ()=>{ tone(660,'sine',.16,.1); tone(990,'sine',.16,.1,0.1); },
    flip:    ()=>tone(600,'sine',.1,.05),
    correct2:()=>{ tone(520,'sine',.15,.08); tone(780,'sine',.15,.1,0.09); },
    wrong2:  ()=>tone(200,'sawtooth',.2,.18),
    pellet:  ()=>tone(700,'sine',.07,.04),
    powerup: ()=>{ sweep(200,800,'sine',.15,.18); tone(1000,'sine',.12,.12,0.2); },
    ghost:   ()=>sweep(800,1200,'sine',.15,.12),
    note:    (lane)=>tone([392,494,587,740][lane||0],'sine',.18,.12),
    miss:    ()=>tone(180,'sawtooth',.12,.1),
    simon0:  ()=>tone(392,'sine',.25,.35),
    simon1:  ()=>tone(494,'sine',.25,.35),
    simon2:  ()=>tone(587,'sine',.25,.35),
    simon3:  ()=>tone(740,'sine',.25,.35),
    simonErr:()=>tone(140,'sawtooth',.3,.4),
    move:    ()=>tone(440,'sine',.08,.04),
  };
})();

function mkOv(wrap, title, sub, btns) {
  let ov = wrap.querySelector('.g-overlay');
  if (!ov) { ov = document.createElement('div'); ov.className = 'g-overlay'; wrap.appendChild(ov); }
  ov.innerHTML = `<h2>${title}</h2><p class="sub">${sub}</p><div class="ov-btns">${btns}</div>`;
  ov.style.display = 'flex';
  return ov;
}

function hideOv(wrap) {
  const ov = wrap.querySelector('.g-overlay');
  if (ov) ov.style.display = 'none';
}

function cvBanner(ctx, W, H, title, sub, hint, color='#e8c46a') {
  ctx.fillStyle = 'rgba(8,7,4,.88)';
  ctx.fillRect(0, 0, W, H);
  ctx.textAlign = 'center';
  ctx.font = `800 ${Math.min(34, W/10)}px Syne,sans-serif`;
  ctx.fillStyle = color;
  ctx.fillText(title, W/2, H/2 - 44);
  if (sub) { ctx.font = `500 ${Math.min(15, W/28)}px DM Sans,sans-serif`; ctx.fillStyle = '#857d5f'; ctx.fillText(sub, W/2, H/2 - 6); }
  if (hint) { ctx.font = `700 ${Math.min(13, W/32)}px DM Sans,sans-serif`; ctx.fillStyle = '#c9a84c'; ctx.fillText(hint, W/2, H/2 + 38); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SNAKE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BUILDERS.snake = function(wrap) {
  const SZ=20, C=25, R=20, W=C*SZ, H=R*SZ;
  wrap.style.cssText = 'flex-direction:column;align-items:center';
  wrap.innerHTML = `<div class="hud-row"><div class="hb"><div class="hl">Score</div><div class="hv" id="snkS">0</div></div><div class="hb"><div class="hl">Best</div><div class="hv" id="snkB">0</div></div><div class="hb"><div class="hl">Length</div><div class="hv" id="snkL">3</div></div></div>
  <div style="flex:1;display:flex;align-items:center;justify-content:center;padding:12px;position:relative;width:100%">
  <canvas id="snkCv" width="${W}" height="${H}" style="border-radius:12px;border:1px solid #2a2618;max-width:100%;max-height:70vh"></canvas></div>
  <p style="color:var(--mut);font-size:12px;padding-bottom:10px">Arrow/WASD ¬∑ Space=start/pause</p>`;
  const cv = document.getElementById('snkCv'), ctx = cv.getContext('2d');
  let snake, dir, ndir, food, score, best=0, loop, state='idle';
  const rnd = m => Math.floor(Math.random() * m);
  function newFood() { let f; do { f = {x:rnd(C), y:rnd(R)}; } while (snake.some(s => s.x===f.x && s.y===f.y)); return f; }
  function upHUD() { document.getElementById('snkS').textContent=score; document.getElementById('snkB').textContent=best; document.getElementById('snkL').textContent=snake.length; }
  function draw() {
    ctx.fillStyle='#0c0b08'; ctx.fillRect(0,0,W,H);
    const pulse = 0.88 + Math.sin(Date.now()/280)*0.12;
    ctx.fillStyle='#e84040'; ctx.shadowColor='#e84040'; ctx.shadowBlur=14*pulse;
    ctx.beginPath(); ctx.arc(food.x*SZ+SZ/2, food.y*SZ+SZ/2, (SZ/2-2)*pulse, 0, Math.PI*2); ctx.fill(); ctx.shadowBlur=0;
    snake.forEach((s,i) => { const t=1-i/snake.length; ctx.fillStyle=`hsl(42,${55+t*20}%,${28+t*26}%)`; ctx.beginPath(); ctx.roundRect(s.x*SZ+1,s.y*SZ+1,SZ-2,SZ-2,4); ctx.fill(); });
  }
  function step() {
    if (state !== 'running') return;
    dir = {...ndir};
    const head = {x:(snake[0].x+dir.x+C)%C, y:(snake[0].y+dir.y+R)%R};
    if (snake.some(s => s.x===head.x && s.y===head.y)) {
      clearInterval(loop); state='dead'; if (score>best) best=score; draw(); SFX.lose();
      cvBanner(ctx,W,H,'GAME OVER','Score: '+score+'   Best: '+best,'SPACE / Tap to Restart'); return;
    }
    snake.unshift(head);
    if (head.x===food.x && head.y===food.y) { score++; food=newFood(); SFX.eat(); } else snake.pop();
    upHUD(); draw();
  }
  function startRun() { clearInterval(loop); snake=[{x:12,y:10},{x:11,y:10},{x:10,y:10}]; dir={x:1,y:0}; ndir={x:1,y:0}; food=newFood(); score=0; upHUD(); state='running'; loop=setInterval(step,110); }
  // Draw idle screen without needing snake/food
  ctx.fillStyle='#0c0b08'; ctx.fillRect(0,0,W,H);
  cvBanner(ctx,W,H,'SNAKE','Eat the red dot ‚Äî don\'t crash!','SPACE or Tap to Start');
  const kH = e => {
    if (e.code==='Space'||e.key==='p'||e.key==='P') {
      e.preventDefault();
      if (state==='idle'||state==='dead') startRun();
      else if (state==='running') { state='paused'; clearInterval(loop); draw(); cvBanner(ctx,W,H,'PAUSED','','SPACE to Resume'); }
      else if (state==='paused') { state='running'; loop=setInterval(step,110); }
      return;
    }
    if (state!=='running') return;
    if (e.key==='ArrowUp'&&dir.y!==1) ndir={x:0,y:-1};
    else if (e.key==='ArrowDown'&&dir.y!==-1) ndir={x:0,y:1};
    else if (e.key==='ArrowLeft'&&dir.x!==1) ndir={x:-1,y:0};
    else if (e.key==='ArrowRight'&&dir.x!==-1) ndir={x:1,y:0};
    else if (e.key==='w'&&dir.y!==1) ndir={x:0,y:-1};
    else if (e.key==='s'&&dir.y!==-1) ndir={x:0,y:1};
    else if (e.key==='a'&&dir.x!==1) ndir={x:-1,y:0};
    else if (e.key==='d'&&dir.x!==-1) ndir={x:1,y:0};
  };
  window.addEventListener('keydown', kH);
  let tx=0, ty=0;
  cv.addEventListener('touchstart', e => { tx=e.touches[0].clientX; ty=e.touches[0].clientY; }, {passive:true});
  cv.addEventListener('touchend', e => {
    const dx=e.changedTouches[0].clientX-tx, dy=e.changedTouches[0].clientY-ty;
    if (Math.abs(dx)<10&&Math.abs(dy)<10) { if (state!=='running') startRun(); return; }
    if (Math.abs(dx)>Math.abs(dy)) { if (dx>15&&dir.x!==-1) ndir={x:1,y:0}; else if (dx<-15&&dir.x!==1) ndir={x:-1,y:0}; }
    else { if (dy>15&&dir.y!==-1) ndir={x:0,y:1}; else if (dy<-15&&dir.y!==1) ndir={x:0,y:-1}; }
  });
  PAUSE_CBS.snake = p => { if(p){state='paused';clearInterval(loop);draw();cvBanner(ctx,W,H,'PAUSED','','Resume to continue');}else{state='running';loop=setInterval(step,110);} };
  CLEANERS.snake = () => { clearInterval(loop); window.removeEventListener('keydown', kH); };
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TETRIS ‚Äî fixed canMove/valid naming conflict
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BUILDERS.tetris = function(wrap) {
  const COLS=10, ROWS=20, SZ=28, W=COLS*SZ, H=ROWS*SZ;
  wrap.style.cssText = 'flex-direction:column;align-items:center';
  wrap.innerHTML = `<div class="hud-row"><div class="hb"><div class="hl">Score</div><div class="hv" id="tS">0</div></div><div class="hb"><div class="hl">Lines</div><div class="hv" id="tL">0</div></div><div class="hb"><div class="hl">Level</div><div class="hv" id="tLv">1</div></div><div class="hb" style="padding:5px 12px"><div class="hl" style="margin-bottom:4px">Next</div><canvas id="tNx" width="64" height="64"></canvas></div></div>
  <div style="flex:1;display:flex;align-items:center;justify-content:center;padding:10px;position:relative;width:100%">
  <canvas id="tCv" width="${W}" height="${H}" style="border-radius:12px;border:1px solid #2a2618;max-height:70vh"></canvas></div>
  <p style="color:var(--mut);font-size:12px;padding-bottom:8px">Arrows ¬∑ Z/‚Üë=Rotate ¬∑ Space=Drop ¬∑ P=Pause</p>`;
  const cv = document.getElementById('tCv'), ctx = cv.getContext('2d');
  const nx = document.getElementById('tNx'), nctx = nx.getContext('2d');
  const PIECES = [
    {s:[[1,1,1,1]], c:'#00d4d4'},
    {s:[[1,1],[1,1]], c:'#e8c46a'},
    {s:[[0,1,0],[1,1,1]], c:'#a050e8'},
    {s:[[1,0,0],[1,1,1]], c:'#e87030'},
    {s:[[0,0,1],[1,1,1]], c:'#4080e0'},
    {s:[[0,1,1],[1,1,0]], c:'#50c850'},
    {s:[[1,1,0],[0,1,1]], c:'#e84040'},
  ];
  let board, piece, next, score, lines, level, raf, state='idle', last=0, acc=0;
  const newBoard = () => Array.from({length:ROWS}, () => Array(COLS).fill(0));
  const rand = () => { const p=PIECES[Math.floor(Math.random()*PIECES.length)]; return {s:p.s.map(r=>[...r]), c:p.c, x:3, y:0}; };
  const rotate = s => s[0].map((_,i) => s.map(r => r[i]).reverse());
  // FIXED: single function name "canFit" used consistently
  const canFit = (s, ox, oy) => s.every((r,y) => r.every((v,x) => !v || (ox+x>=0 && ox+x<COLS && oy+y<ROWS && !board[oy+y]?.[ox+x])));

  function place() {
    piece.s.forEach((r,y) => r.forEach((v,x) => { if(v) board[piece.y+y][piece.x+x]=piece.c; }));
    let cl = 0;
    for (let y=ROWS-1; y>=0; y--) {
      if (board[y].every(v => v)) { board.splice(y,1); board.unshift(Array(COLS).fill(0)); cl++; y++; }
    }
    score += [0,100,300,500,800][cl] * level;
    if (cl > 0) SFX.clear();
    lines += cl; level = Math.floor(lines/10)+1;
    document.getElementById('tS').textContent=score;
    document.getElementById('tL').textContent=lines;
    document.getElementById('tLv').textContent=level;
    piece = next; next = rand();
    if (!canFit(piece.s, piece.x, piece.y)) { state='gameover'; cancelAnimationFrame(raf); draw(); cvBanner(ctx,W,H,'GAME OVER','Score: '+score+' ¬∑ Level: '+level,'SPACE to Restart'); SFX.lose(); }
    drawNext();
  }
  function dc(c,x,y,s,col) { c.fillStyle=col; c.fillRect(x*s+1,y*s+1,s-2,s-2); c.fillStyle='rgba(255,255,255,.16)'; c.fillRect(x*s+1,y*s+1,s-2,4); }
  function drawNext() { nctx.fillStyle='#0c0b08'; nctx.fillRect(0,0,64,64); const s=13,ox=(64-next.s[0].length*s)/2,oy=(64-next.s.length*s)/2; next.s.forEach((r,y)=>r.forEach((v,x)=>{if(v)dc(nctx,ox/s+x,oy/s+y,s,next.c)})); }
  function draw() {
    ctx.fillStyle='#0c0b08'; ctx.fillRect(0,0,W,H);
    ctx.strokeStyle='#161410'; ctx.lineWidth=1;
    for(let x=0;x<=COLS;x++){ctx.beginPath();ctx.moveTo(x*SZ,0);ctx.lineTo(x*SZ,H);ctx.stroke();}
    for(let y=0;y<=ROWS;y++){ctx.beginPath();ctx.moveTo(0,y*SZ);ctx.lineTo(W,y*SZ);ctx.stroke();}
    board.forEach((row,y) => row.forEach((v,x) => { if(v) dc(ctx,x,y,SZ,v); }));
    // ghost piece
    let gy = piece.y;
    while (canFit(piece.s, piece.x, gy+1)) gy++;
    piece.s.forEach((r,y)=>r.forEach((v,x)=>{if(v){ctx.fillStyle='rgba(201,168,76,.1)';ctx.fillRect((piece.x+x)*SZ+1,(gy+y)*SZ+1,SZ-2,SZ-2);}}));
    piece.s.forEach((r,y)=>r.forEach((v,x)=>{if(v)dc(ctx,piece.x+x,piece.y+y,SZ,piece.c);}));
  }
  function loop(ts) {
    if (state!=='running') return;
    const dt=ts-last; last=ts; acc+=dt;
    const intv=Math.max(80,600-level*50);
    if (acc>intv) { acc=0; if(canFit(piece.s,piece.x,piece.y+1)) piece.y++; else place(); }
    draw(); raf=requestAnimationFrame(loop);
  }
  function startRun() {
    cancelAnimationFrame(raf); board=newBoard(); score=0; lines=0; level=1;
    document.getElementById('tS').textContent='0'; document.getElementById('tL').textContent='0'; document.getElementById('tLv').textContent='1';
    piece=rand(); next=rand(); state='running'; acc=0; last=0; drawNext(); raf=requestAnimationFrame(loop);
  }
  // Draw idle screen without needing board/piece
  ctx.fillStyle='#0c0b08'; ctx.fillRect(0,0,W,H);
  cvBanner(ctx,W,H,'TETRIS','Classic block stacking game','SPACE to Start');
  const kH = e => {
    if (e.key==='p'||e.key==='P') {
      if(state==='running'){state='paused';cancelAnimationFrame(raf);draw();cvBanner(ctx,W,H,'PAUSED','','P to Resume');}
      else if(state==='paused'){state='running';last=performance.now();raf=requestAnimationFrame(loop);}
      return;
    }
    if (e.code==='Space') { e.preventDefault(); if(state!=='running'){startRun();return;} let d=0; while(canFit(piece.s,piece.x,piece.y+1)){piece.y++;d++;} place(); if(d) SFX.drop(); draw(); return; }
    if (state!=='running') return;
    if (e.key==='ArrowLeft'&&canFit(piece.s,piece.x-1,piece.y)){piece.x--;draw();}
    else if(e.key==='ArrowRight'&&canFit(piece.s,piece.x+1,piece.y)){piece.x++;draw();}
    else if(e.key==='ArrowDown'&&canFit(piece.s,piece.x,piece.y+1)){piece.y++;draw();}
    else if(e.key==='ArrowUp'||e.key==='z'||e.key==='Z'){const r=rotate(piece.s);if(canFit(r,piece.x,piece.y)){piece.s=r;draw();}}
  };
  window.addEventListener('keydown', kH);
  PAUSE_CBS.tetris = p => { if(p){state='paused';cancelAnimationFrame(raf);draw();cvBanner(ctx,W,H,'PAUSED','','Resume to continue');}else{state='running';last=performance.now();raf=requestAnimationFrame(loop);} };
  CLEANERS.tetris = () => { cancelAnimationFrame(raf); window.removeEventListener('keydown', kH); };
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FLAPPY BIRD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BUILDERS.flappy = function(wrap) {
  const W=360, H=500;
  wrap.style.cssText = 'flex-direction:column;align-items:center';
  wrap.innerHTML = `<div style="flex:1;display:flex;align-items:center;justify-content:center;padding:10px;position:relative;width:100%"><canvas id="flCv" width="${W}" height="${H}" style="border-radius:12px;border:1px solid #2a2618;cursor:pointer;max-height:80vh"></canvas></div><p style="color:var(--mut);font-size:12px;padding-bottom:8px">Tap / Space to flap</p>`;
  const cv = document.getElementById('flCv'), ctx = cv.getContext('2d');
  const GAP=142, PSP=2.6, GR=0.40, JP=-8, BR=14;
  let bird={x:78,y:H/2,vy:0}, pipes=[], score=0, best=0, raf, state='idle', fr=0;
  function init() { bird={x:78,y:H/2,vy:0}; pipes=[]; score=0; }
  function addPipe() { const t=55+Math.random()*(H-GAP-110); pipes.push({x:W,top:t,bot:t+GAP,passed:false}); }
  function flap() { if(state==='idle'||state==='dead'){init();state='running';return;} if(state==='paused')return; bird.vy=JP; SFX.jump(); }
  function drawBird() { ctx.save(); ctx.translate(bird.x,bird.y); ctx.rotate(Math.max(-25,Math.min(50,bird.vy*3))*Math.PI/180); ctx.fillStyle='#e8c46a'; ctx.beginPath(); ctx.ellipse(0,0,BR,BR-3,0,0,Math.PI*2); ctx.fill(); ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(6,-4,5,0,Math.PI*2); ctx.fill(); ctx.fillStyle='#222'; ctx.beginPath(); ctx.arc(7,-4,2.5,0,Math.PI*2); ctx.fill(); ctx.fillStyle='#e87030'; ctx.beginPath(); ctx.moveTo(12,-2); ctx.lineTo(20,0); ctx.lineTo(12,3); ctx.closePath(); ctx.fill(); ctx.restore(); }
  function update() {
    bird.vy+=GR; bird.y+=bird.vy;
    if(bird.y+BR>H-52){state='dead';if(score>best)best=score;SFX.lose();return;}
    if(bird.y-BR<0){bird.y=BR;bird.vy=0;}
    pipes.forEach(p=>{p.x-=PSP;if(!p.passed&&p.x+48<bird.x){p.passed=true;score++;SFX.score();}if(bird.x+BR>p.x&&bird.x-BR<p.x+48&&(bird.y-BR<p.top||bird.y+BR>p.bot)){state='dead';if(score>best)best=score;SFX.lose();}});
    pipes=pipes.filter(p=>p.x>-60);
    if(!pipes.length||pipes[pipes.length-1].x<W-200)addPipe();
  }
  function render() {
    fr++;
    const sky=ctx.createLinearGradient(0,0,0,H); sky.addColorStop(0,'#0a1828'); sky.addColorStop(1,'#162840'); ctx.fillStyle=sky; ctx.fillRect(0,0,W,H);
    pipes.forEach(p=>{ctx.fillStyle='#2a6e2a';ctx.beginPath();ctx.roundRect(p.x,0,48,p.top,3);ctx.fill();ctx.fillStyle='#348034';ctx.fillRect(p.x-4,p.top-20,56,20);ctx.beginPath();ctx.roundRect(p.x,p.bot,48,H-p.bot-52,3);ctx.fill();ctx.fillStyle='#348034';ctx.fillRect(p.x-4,p.bot,56,20);});
    ctx.fillStyle='#3a6e1a'; ctx.fillRect(0,H-52,W,52);
    ctx.textAlign='center'; ctx.font='800 32px Syne,sans-serif'; ctx.fillStyle='rgba(0,0,0,.35)'; ctx.fillText(score,W/2+2,50); ctx.fillStyle='#fff'; ctx.fillText(score,W/2,48);
    if(state==='idle'){ctx.fillStyle='rgba(8,7,4,.8)';ctx.fillRect(0,0,W,H);ctx.font='800 32px Syne,sans-serif';ctx.fillStyle='#e8c46a';ctx.fillText('FLAPPY BIRD',W/2,H/2-48);ctx.font='500 13px DM Sans,sans-serif';ctx.fillStyle='#857d5f';ctx.fillText('Tap or Space to fly',W/2,H/2+4);drawBird();}
    else if(state==='paused'){ctx.fillStyle='rgba(8,7,4,.78)';ctx.fillRect(0,0,W,H);ctx.font='800 30px Syne,sans-serif';ctx.fillStyle='#e8c46a';ctx.fillText('PAUSED',W/2,H/2);}
    else if(state==='dead'){ctx.fillStyle='rgba(8,7,4,.82)';ctx.fillRect(0,0,W,H);ctx.font='800 30px Syne,sans-serif';ctx.fillStyle='#e8c46a';ctx.fillText('GAME OVER',W/2,H/2-52);ctx.font='800 18px Syne,sans-serif';ctx.fillStyle='#c9a84c';ctx.fillText('Score: '+score,W/2,H/2-16);ctx.font='500 13px DM Sans,sans-serif';ctx.fillStyle='#857d5f';ctx.fillText('Best: '+best,W/2,H/2+10);ctx.font='700 13px DM Sans,sans-serif';ctx.fillStyle='#c9a84c';ctx.fillText('Tap or Space to retry',W/2,H/2+44);}
    else drawBird();
    raf=requestAnimationFrame(render);
    if(state==='running')update();
  }
  raf=requestAnimationFrame(render);
  const kH = e => { if(e.key==='p'||e.key==='P'){state=state==='paused'?'running':'paused';return;} if(e.code==='Space'){e.preventDefault();flap();} };
  window.addEventListener('keydown', kH);
  cv.addEventListener('click', flap);
  cv.addEventListener('touchstart', e => { e.preventDefault(); flap(); }, {passive:false});
  PAUSE_CBS.flappy = p => { state=p?'paused':'running'; };
  CLEANERS.flappy = () => { cancelAnimationFrame(raf); window.removeEventListener('keydown', kH); };
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DINO RUN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BUILDERS.dino = function(wrap) {
  const W=660, H=220;
  wrap.style.cssText = 'flex-direction:column;align-items:center';
  wrap.innerHTML = `<div class="hud-row"><div class="hb"><div class="hl">Score</div><div class="hv" id="dS">0</div></div><div class="hb"><div class="hl">Best</div><div class="hv" id="dB">0</div></div></div><div style="flex:1;display:flex;align-items:center;justify-content:center;padding:10px;position:relative;width:100%"><canvas id="dnCv" width="${W}" height="${H}" style="border-radius:12px;border:1px solid #2a2618;max-width:100%;cursor:pointer"></canvas></div><p style="color:var(--mut);font-size:12px;padding-bottom:8px">Space / Tap to jump ¬∑ Double jump!</p>`;
  const cv = document.getElementById('dnCv'), ctx = cv.getContext('2d');
  const GND=H-46, GR=0.62, JP=-13;
  let dino={x:68,y:GND,vy:0,w:36,h:46,fr:0}, obs=[], score=0, best=0, speed=5, fr=0, state='idle', raf, jumps=0, clouds=[{x:200,y:32,w:80},{x:450,y:20,w:60}];
  function init() { dino={x:68,y:GND,vy:0,w:36,h:46,fr:0}; obs=[]; score=0; speed=5; fr=0; jumps=0; clouds=[{x:200,y:32,w:80},{x:450,y:20,w:60}]; }
  function jump() { if(state==='idle'||state==='dead'){init();state='running';return;} if(state==='paused')return; if(jumps<2){dino.vy=JP;jumps++;SFX.jump();} }
  function addObs() { const h=26+Math.random()*36; obs.push({x:W,y:GND+dino.h-h,w:16+Math.random()*14,h}); }
  function drawDino() { const d=dino; ctx.fillStyle='#c9a84c'; ctx.beginPath(); ctx.roundRect(d.x,d.y,d.w,d.h,5); ctx.fill(); ctx.fillStyle='#e8c46a'; ctx.beginPath(); ctx.roundRect(d.x+d.w-15,d.y-17,25,21,4); ctx.fill(); ctx.fillStyle='#0c0b08'; ctx.beginPath(); ctx.arc(d.x+d.w+3,d.y-9,3,0,Math.PI*2); ctx.fill(); }
  function update() {
    dino.vy+=GR; dino.y+=dino.vy;
    if(dino.y>=GND){dino.y=GND;dino.vy=0;jumps=0;}
    fr++; dino.fr++; speed=5+score*0.004;
    if(fr%Math.max(36,80-score/8)===0)addObs();
    obs.forEach(o=>o.x-=speed);
    obs=obs.filter(o=>o.x>-80);
    clouds.forEach(c=>c.x-=0.7);
    clouds=clouds.filter(c=>c.x>-110);
    if(clouds.length<4)clouds.push({x:W+100,y:14+Math.random()*54,w:50+Math.random()*80});
    score++;
    document.getElementById('dS').textContent=Math.floor(score/5);
    obs.forEach(o=>{if(dino.x+dino.w-8>o.x+4&&dino.x+8<o.x+o.w-4&&dino.y+6<o.y+o.h&&dino.y+dino.h>o.y+4){state='dead';const s=Math.floor(score/5);if(s>best){best=s;document.getElementById('dB').textContent=best;}SFX.lose();}});
  }
  function render() {
    ctx.fillStyle='#121110'; ctx.fillRect(0,0,W,H);
    clouds.forEach(c=>{ctx.fillStyle='rgba(255,255,255,.04)';ctx.beginPath();ctx.roundRect(c.x,c.y,c.w,16,8);ctx.fill();});
    ctx.fillStyle='#2a2618'; ctx.fillRect(0,GND+dino.h,W,3);
    obs.forEach(o=>{ctx.fillStyle='#2a6e2a';ctx.beginPath();ctx.roundRect(o.x,o.y,o.w,o.h,2);ctx.fill();});
    if(state!=='idle')drawDino();
    if(state==='idle'){ctx.fillStyle='rgba(8,7,4,.82)';ctx.fillRect(0,0,W,H);ctx.textAlign='center';ctx.font='800 26px Syne,sans-serif';ctx.fillStyle='#e8c46a';ctx.fillText('DINO RUN',W/2,H/2-16);ctx.font='700 12px DM Sans,sans-serif';ctx.fillStyle='#c9a84c';ctx.fillText('Space / Tap to start & jump',W/2,H/2+14);drawDino();}
    else if(state==='paused'){ctx.fillStyle='rgba(8,7,4,.8)';ctx.fillRect(0,0,W,H);ctx.textAlign='center';ctx.font='800 26px Syne,sans-serif';ctx.fillStyle='#e8c46a';ctx.fillText('PAUSED',W/2,H/2-14);}
    else if(state==='dead'){ctx.fillStyle='rgba(8,7,4,.82)';ctx.fillRect(0,0,W,H);ctx.textAlign='center';ctx.font='800 26px Syne,sans-serif';ctx.fillStyle='#e8c46a';ctx.fillText('GAME OVER',W/2,H/2-20);ctx.font='700 12px DM Sans,sans-serif';ctx.fillStyle='#857d5f';ctx.fillText('Space / Tap to retry',W/2,H/2+32);}
    raf=requestAnimationFrame(render);
    if(state==='running')update();
  }
  raf=requestAnimationFrame(render);
  const kH = e => { if(e.key==='p'||e.key==='P'){state=state==='paused'?'running':'paused';return;} if(e.code==='Space'||e.code==='ArrowUp'){e.preventDefault();jump();} };
  window.addEventListener('keydown', kH);
  cv.addEventListener('click', jump);
  cv.addEventListener('touchstart', e => { e.preventDefault(); jump(); }, {passive:false});
  PAUSE_CBS.dino = p => { state=p?'paused':'running'; };
  CLEANERS.dino = () => { cancelAnimationFrame(raf); window.removeEventListener('keydown', kH); };
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SPACE SHOOTER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BUILDERS.spaceshoot = function(wrap) {
  const W=500, H=560;
  wrap.style.cssText = 'flex-direction:column;align-items:center';
  wrap.innerHTML = `<div class="hud-row"><div class="hb"><div class="hl">Score</div><div class="hv" id="ssS">0</div></div><div class="hb"><div class="hl">Lives</div><div class="hv" id="ssLv">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div></div><div class="hb"><div class="hl">Wave</div><div class="hv" id="ssW">1</div></div></div>
  <div style="flex:1;display:flex;align-items:center;justify-content:center;padding:10px;position:relative;width:100%"><canvas id="ssCv" width="${W}" height="${H}" style="border-radius:12px;border:1px solid #2a2618;max-height:72vh"></canvas></div>
  <p style="color:var(--mut);font-size:12px;padding-bottom:8px">‚Üê ‚Üí / WASD ¬∑ Space=shoot ¬∑ P=Pause</p>`;
  const cv = document.getElementById('ssCv'), ctx = cv.getContext('2d');
  let ship, bullets, enemies, eBullets, score, lives, wave, stars, raf, state='idle', shootCool, fr;
  function mkStars() { stars=Array.from({length:80},()=>({x:Math.random()*W,y:Math.random()*H,s:Math.random()*1.5+.5,sp:Math.random()+.4})); }
  function spawnEnemies(w) { enemies=[]; const rows=Math.min(3+w,5),cols=Math.min(6+w,10); for(let r=0;r<rows;r++)for(let c=0;c<cols;c++)enemies.push({x:40+c*44,y:30+r*36,w:28,h:22,hp:r<2?1:2,type:r,vx:.8+w*.2,vy:0}); }
  function init() { ship={x:W/2-18,y:H-60,w:36,h:28,vx:0}; bullets=[]; eBullets=[]; score=0; lives=3; wave=1; shootCool=0; fr=0; mkStars(); spawnEnemies(1); document.getElementById('ssS').textContent='0'; document.getElementById('ssLv').textContent='‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è'; document.getElementById('ssW').textContent='1'; }
  const keys = {};
  const kH = e => { keys[e.key]=e.type==='keydown'; };
  window.addEventListener('keydown', kH); window.addEventListener('keyup', kH);
  function drawShip(x,y) { ctx.fillStyle='#c9a84c'; ctx.beginPath(); ctx.moveTo(x+18,y); ctx.lineTo(x+36,y+28); ctx.lineTo(x+26,y+22); ctx.lineTo(x+18,y+28); ctx.lineTo(x+10,y+22); ctx.lineTo(x,y+28); ctx.closePath(); ctx.fill(); ctx.fillStyle='#e8c46a'; ctx.beginPath(); ctx.moveTo(x+18,y+4); ctx.lineTo(x+24,y+18); ctx.lineTo(x+18,y+14); ctx.lineTo(x+12,y+18); ctx.closePath(); ctx.fill(); }
  function drawEnemy(e) { const colors=['#e84040','#e87030','#50c850','#4080e0','#a050e8']; ctx.fillStyle=colors[e.type%colors.length]; ctx.beginPath(); ctx.ellipse(e.x+14,e.y+11,14,11,0,0,Math.PI*2); ctx.fill(); }
  function update() {
    fr++;
    const spd=5;
    if((keys['ArrowLeft']||keys['a']||keys['A'])&&ship.x>0)ship.x-=spd;
    if((keys['ArrowRight']||keys['d']||keys['D'])&&ship.x<W-ship.w)ship.x+=spd;
    shootCool--;
    if((keys[' ']||keys['Space'])&&shootCool<=0){bullets.push({x:ship.x+ship.w/2,y:ship.y,vy:-10});shootCool=18;SFX.shoot();}
    stars.forEach(s=>{s.y+=s.sp;if(s.y>H){s.y=0;s.x=Math.random()*W;}});
    bullets.forEach(b=>b.y+=b.vy); bullets=bullets.filter(b=>b.y>-10);
    let hitWall=false;
    enemies.forEach(e=>{e.x+=e.vx;if(e.x<0||e.x+e.w>W)hitWall=true;});
    if(hitWall){enemies.forEach(e=>{e.vx*=-1;e.y+=20;});if(enemies.some(e=>e.y+e.h>H-80)){lives=0;}}
    if(fr%60===0&&enemies.length){const sh=enemies[Math.floor(Math.random()*enemies.length)];eBullets.push({x:sh.x+14,y:sh.y+22,vy:4+wave*.5});}
    eBullets.forEach(b=>b.y+=b.vy); eBullets=eBullets.filter(b=>b.y<H+10);
    bullets.forEach(b=>{enemies.forEach(e=>{if(!e.dead&&b.x>e.x&&b.x<e.x+e.w&&b.y>e.y&&b.y<e.y+e.h){e.hp--;b.dead=true;SFX.hit();if(e.hp<=0){e.dead=true;score+=150;document.getElementById('ssS').textContent=score;SFX.explode();}}});});
    bullets=bullets.filter(b=>!b.dead); enemies=enemies.filter(e=>!e.dead);
    eBullets.forEach(b=>{if(b.x>ship.x&&b.x<ship.x+ship.w&&b.y>ship.y&&b.y<ship.y+ship.h){b.dead=true;lives--;SFX.hit();document.getElementById('ssLv').textContent='‚ù§Ô∏è'.repeat(Math.max(0,lives))||'üíÄ';if(lives<=0){state='gameover';SFX.lose();}}});
    eBullets=eBullets.filter(b=>!b.dead);
    if(!enemies.length){wave++;document.getElementById('ssW').textContent=wave;spawnEnemies(wave);}
    if(lives<=0)state='gameover';
  }
  function render() {
    ctx.fillStyle='#050810'; ctx.fillRect(0,0,W,H);
    if(stars)(stars).forEach(s=>{ctx.fillStyle=`rgba(255,255,255,${s.s*.5})`;ctx.fillRect(s.x,s.y,s.s,s.s);});
    if(enemies)enemies.forEach(drawEnemy);
    if(bullets)bullets.forEach(b=>{ctx.fillStyle='#c9a84c';ctx.shadowColor='#c9a84c';ctx.shadowBlur=8;ctx.fillRect(b.x-2,b.y-8,4,12);ctx.shadowBlur=0;});
    if(eBullets)eBullets.forEach(b=>{ctx.fillStyle='#e84040';ctx.shadowColor='#e84040';ctx.shadowBlur=6;ctx.fillRect(b.x-2,b.y,4,10);ctx.shadowBlur=0;});
    if(state!=='idle')drawShip(ship.x,ship.y);
    if(state==='idle')cvBanner(ctx,W,H,'SPACE SHOOTER','Destroy all alien waves!','SPACE to Start ¬∑ Arrows/WASD');
    else if(state==='paused')cvBanner(ctx,W,H,'PAUSED','','Resume to continue');
    else if(state==='gameover')cvBanner(ctx,W,H,'GAME OVER','Score: '+score+' ¬∑ Wave: '+wave,'SPACE to Play Again');
    raf=requestAnimationFrame(render);
    if(state==='running')update();
  }
  raf=requestAnimationFrame(render);
  const spH = e => {
    if(e.code==='Space'&&state!=='running'){e.preventDefault();if(state==='idle'||state==='gameover'){init();state='running';}}
    if((e.key==='p'||e.key==='P')&&(state==='running'||state==='paused')){state=state==='paused'?'running':'paused';}
  };
  window.addEventListener('keydown', spH);
  PAUSE_CBS.spaceshoot = p => { state=p?'paused':'running'; };
  CLEANERS.spaceshoot = () => { cancelAnimationFrame(raf); window.removeEventListener('keydown',kH); window.removeEventListener('keyup',kH); window.removeEventListener('keydown',spH); };
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REACTION TIME
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BUILDERS.reaction = function(wrap) {
  wrap.style.cssText = 'flex-direction:column;align-items:center;justify-content:center;gap:0';
  wrap.innerHTML = `<div class="hud-row" style="margin-bottom:12px"><div class="hb"><div class="hl">Best</div><div class="hv" id="rtB">‚Äî</div></div><div class="hb"><div class="hl">Last</div><div class="hv" id="rtL">‚Äî</div></div><div class="hb"><div class="hl">Round</div><div class="hv" id="rtR">0</div></div></div>
  <div id="rtBox" style="width:min(420px,90vw);height:280px;border-radius:18px;border:2px solid var(--bord2);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:background .2s;background:var(--surf);user-select:none">
    <div id="rtEmoji" style="font-size:64px;margin-bottom:12px">üëÄ</div>
    <div id="rtMsg" style="font-family:var(--font-head);font-size:22px;font-weight:700;color:var(--mut);text-align:center;padding:0 20px">Click to Start</div>
    <div id="rtSub" style="font-size:13px;color:var(--mut2);margin-top:8px;text-align:center">Wait for GREEN then click!</div>
  </div>
  <p style="color:var(--mut);font-size:12px;padding-top:14px;padding-bottom:8px">Click or Space when it turns green!</p>`;
  let state='idle', startT, timer, round=0, best=Infinity;
  const box = document.getElementById('rtBox');
  function setIdle() { box.style.background='var(--surf)'; document.getElementById('rtEmoji').textContent='üëÄ'; document.getElementById('rtMsg').textContent='Click to Start'; document.getElementById('rtMsg').style.color='var(--mut)'; document.getElementById('rtSub').textContent='Wait for green, then click!'; state='idle'; }
  function startWait() {
    state='wait'; box.style.background='var(--surf2)'; document.getElementById('rtEmoji').textContent='‚è≥'; document.getElementById('rtMsg').textContent='Wait for it...'; document.getElementById('rtMsg').style.color='var(--mut)'; document.getElementById('rtSub').textContent='';
    const delay=1200+Math.random()*3800;
    timer=setTimeout(()=>{state='go';startT=Date.now();box.style.background='#1a4a1a';document.getElementById('rtEmoji').textContent='üü¢';document.getElementById('rtMsg').textContent='CLICK NOW!';document.getElementById('rtMsg').style.color='#50c850';},delay);
  }
  function onClick() {
    if(state==='idle')startWait();
    else if(state==='wait'){clearTimeout(timer);box.style.background='#4a1010';document.getElementById('rtEmoji').textContent='‚ùå';document.getElementById('rtMsg').textContent='Too early!';document.getElementById('rtMsg').style.color='#e84040';document.getElementById('rtSub').textContent='Click to try again';state='early';SFX.denied();}
    else if(state==='go'){const rt=Date.now()-startT;if(rt<best)best=rt;round++;document.getElementById('rtB').textContent=best+'ms';document.getElementById('rtL').textContent=rt+'ms';document.getElementById('rtR').textContent=round;box.style.background='var(--surf)';document.getElementById('rtEmoji').textContent=rt<200?'üöÄ':rt<300?'‚ö°':rt<500?'üëç':'üê¢';document.getElementById('rtMsg').textContent=rt+'ms';document.getElementById('rtMsg').style.color='#e8c46a';document.getElementById('rtSub').textContent=rt<200?'Lightning fast!':rt<300?'Excellent!':rt<500?'Good!':'Keep practicing!';state='result';SFX.score();}
    else if(state==='result'||state==='early')startWait();
  }
  box.addEventListener('click', onClick);
  const kH = e => { if(e.code==='Space'){e.preventDefault();onClick();} };
  window.addEventListener('keydown', kH);
  CLEANERS.reaction = () => { clearTimeout(timer); window.removeEventListener('keydown', kH); };
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AIM TRAINER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BUILDERS.aim = function(wrap) {
  const W=600, H=440;
  wrap.style.cssText = 'flex-direction:column;align-items:center';
  wrap.innerHTML = `<div class="hud-row"><div class="hb"><div class="hl">Score</div><div class="hv" id="atS">0</div></div><div class="hb"><div class="hl">Accuracy</div><div class="hv" id="atA">‚Äî</div></div><div class="hb"><div class="hl">Time</div><div class="hv" id="atT">30</div></div><div class="hb"><div class="hl">Best</div><div class="hv" id="atB">0</div></div></div>
  <div style="flex:1;display:flex;align-items:center;justify-content:center;padding:10px;position:relative;width:100%"><canvas id="atCv" width="${W}" height="${H}" style="border-radius:12px;border:1px solid #2a2618;cursor:crosshair;max-width:100%"></canvas></div>
  <p style="color:var(--mut);font-size:12px;padding-bottom:8px">Click the targets as fast as you can!</p>`;
  const cv = document.getElementById('atCv'), ctx = cv.getContext('2d');
  let targets, score, clicks, hits, timeLeft, timer, state='idle', best=0, raf;
  function spawnTarget() { const r=20+Math.random()*20; return {x:r+Math.random()*(W-r*2),y:r+Math.random()*(H-r*2),r,life:100,maxLife:100}; }
  function init() { targets=[spawnTarget()]; score=0; clicks=0; hits=0; timeLeft=30; clearInterval(timer); timer=setInterval(()=>{timeLeft--;document.getElementById('atT').textContent=timeLeft;if(timeLeft<=0){state='done';clearInterval(timer);if(score>best)best=score;}},1000); }
  function render() {
    ctx.fillStyle='#0c0b08'; ctx.fillRect(0,0,W,H);
    targets.forEach(t=>{const a=t.life/t.maxLife;ctx.fillStyle=`rgba(232,64,64,${a})`;ctx.shadowColor='#e84040';ctx.shadowBlur=14*a;ctx.beginPath();ctx.arc(t.x,t.y,t.r,0,Math.PI*2);ctx.fill();ctx.fillStyle='rgba(255,255,255,.3)';ctx.beginPath();ctx.arc(t.x,t.y,t.r*.4,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;t.life--;});
    targets=targets.filter(t=>t.life>0);
    if(targets.length<3)targets.push(spawnTarget());
    if(state==='idle')cvBanner(ctx,W,H,'AIM TRAINER','30 seconds ¬∑ Click targets!','Click to Start');
    else if(state==='done')cvBanner(ctx,W,H,'TIME\'S UP!','Score: '+score+' ¬∑ Accuracy: '+(clicks?Math.round(hits/clicks*100):0)+'%','Click to Play Again');
    raf=requestAnimationFrame(render);
  }
  raf=requestAnimationFrame(render);
  cv.addEventListener('click', e => {
    if(state==='idle'){state='running';init();return;}
    if(state==='done'){state='idle';return;}
    clicks++; const r=cv.getBoundingClientRect(); const mx=(e.clientX-r.left)*(W/r.width),my=(e.clientY-r.top)*(H/r.height);
    let hit=false;
    targets.forEach((t,i)=>{if(Math.hypot(mx-t.x,my-t.y)<t.r){hits++;score+=Math.ceil(t.r);document.getElementById('atS').textContent=score;targets.splice(i,1);targets.push(spawnTarget());hit=true;SFX.blip();}});
    document.getElementById('atA').textContent=(clicks?Math.round(hits/clicks*100):0)+'%';
    document.getElementById('atB').textContent=Math.max(best,score);
  });
  CLEANERS.aim = () => { clearInterval(timer); cancelAnimationFrame(raf); };
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WHACK-A-MOLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BUILDERS.whack = function(wrap) {
  wrap.style.cssText = 'flex-direction:column;align-items:center;justify-content:center';
  wrap.innerHTML = `<div class="hud-row"><div class="hb"><div class="hl">Score</div><div class="hv" id="wmS">0</div></div><div class="hb"><div class="hl">Misses</div><div class="hv" id="wmM">0</div></div><div class="hb"><div class="hl">Time</div><div class="hv" id="wmT">30</div></div><div class="hb"><div class="hl">Best</div><div class="hv" id="wmB">0</div></div></div>
  <div style="flex:1;display:flex;align-items:center;justify-content:center;padding:12px">
    <div style="display:flex;flex-direction:column;align-items:center;gap:16px">
      <div id="wmGrid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:14px"></div>
      <button class="btn-gold" id="wmStart" onclick="window._wmN()">Start Game</button>
    </div>
  </div>`;
  const HOLES = 9;
  let holes, score, misses, timeLeft, gameTimer, moleTimer, state='idle', best=0;
  function buildGrid() {
    const grid = document.getElementById('wmGrid');
    grid.innerHTML = '';
    holes = [];
    for (let i=0; i<HOLES; i++) {
      const hole = document.createElement('div');
      hole.style.cssText = `width:90px;height:90px;border-radius:50%;background:var(--surf2);border:3px solid var(--bord2);display:flex;align-items:center;justify-content:center;font-size:40px;cursor:pointer;transition:all .12s;user-select:none;position:relative;overflow:hidden;`;
      hole.dataset.idx = i;
      hole.textContent = 'üï≥Ô∏è';
      hole.addEventListener('click', () => whackHole(i));
      grid.appendChild(hole);
      holes.push({el:hole, active:false, timer:null});
    }
  }
  function whackHole(i) {
    if (state!=='running') return;
    const h = holes[i];
    if (h.active) {
      h.active = false; clearTimeout(h.timer);
      h.el.textContent = 'üí•'; h.el.style.background = 'rgba(232,196,74,.2)'; h.el.style.borderColor = 'var(--gold)';
      score += 10; document.getElementById('wmS').textContent = score;
      SFX.eat();
      setTimeout(() => { h.el.textContent = 'üï≥Ô∏è'; h.el.style.background = 'var(--surf2)'; h.el.style.borderColor = 'var(--bord2)'; }, 300);
    } else {
      misses++; document.getElementById('wmM').textContent = misses;
      h.el.style.background = 'rgba(232,64,64,.2)';
      SFX.denied();
      setTimeout(() => h.el.style.background = 'var(--surf2)', 200);
    }
  }
  function showMole() {
    if (state !== 'running') return;
    const available = holes.filter(h => !h.active);
    if (!available.length) return;
    const h = available[Math.floor(Math.random() * available.length)];
    h.active = true;
    h.el.textContent = 'üêπ'; h.el.style.background = 'rgba(80,200,80,.15)'; h.el.style.borderColor = '#50c850';
    const delay = Math.max(600, 1400 - score * 8);
    h.timer = setTimeout(() => {
      if (h.active) {
        h.active = false;
        h.el.textContent = 'üï≥Ô∏è'; h.el.style.background = 'var(--surf2)'; h.el.style.borderColor = 'var(--bord2)';
      }
    }, delay);
  }
  function startGame() {
    state = 'running'; score = 0; misses = 0; timeLeft = 30;
    document.getElementById('wmS').textContent = '0';
    document.getElementById('wmM').textContent = '0';
    document.getElementById('wmT').textContent = '30';
    document.getElementById('wmStart').style.display = 'none';
    buildGrid();
    gameTimer = setInterval(() => {
      timeLeft--;
      document.getElementById('wmT').textContent = timeLeft;
      if (timeLeft <= 0) {
        state = 'done'; clearInterval(gameTimer); clearInterval(moleTimer);
        holes.forEach(h => { clearTimeout(h.timer); h.el.textContent = 'üï≥Ô∏è'; });
        if (score > best) best = score;
        document.getElementById('wmB').textContent = best;
        document.getElementById('wmStart').textContent = 'Play Again';
        document.getElementById('wmStart').style.display = '';
      }
    }, 1000);
    moleTimer = setInterval(showMole, 700);
  }
  window._wmN = () => { clearInterval(gameTimer); clearInterval(moleTimer); startGame(); };
  buildGrid();
  CLEANERS.whack = () => { clearInterval(gameTimer); clearInterval(moleTimer); delete window._wmN; };
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SIMON SAYS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BUILDERS.simon = function(wrap) {
  wrap.style.cssText = 'flex-direction:column;align-items:center;justify-content:center;gap:0';
  wrap.innerHTML = `<div class="hud-row" style="margin-bottom:16px"><div class="hb"><div class="hl">Round</div><div class="hv" id="siR">0</div></div><div class="hb"><div class="hl">Best</div><div class="hv" id="siB">0</div></div><div class="hb"><div class="hl">Status</div><div class="hv" id="siSt">Ready</div></div></div>
  <div style="position:relative;width:260px;height:260px;margin:0 auto">
    <div id="siBtn0" style="position:absolute;top:0;left:0;width:120px;height:120px;border-radius:20px 60px 20px 20px;background:#1a4a1a;border:3px solid #2a6a2a;cursor:pointer;transition:background .12s;display:flex;align-items:center;justify-content:center;font-size:28px">üü¢</div>
    <div id="siBtn1" style="position:absolute;top:0;right:0;width:120px;height:120px;border-radius:60px 20px 20px 20px;background:#4a1a1a;border:3px solid #6a2a2a;cursor:pointer;transition:background .12s;display:flex;align-items:center;justify-content:center;font-size:28px">üî¥</div>
    <div id="siBtn2" style="position:absolute;bottom:0;left:0;width:120px;height:120px;border-radius:20px 20px 20px 60px;background:#1a1a4a;border:3px solid #2a2a6a;cursor:pointer;transition:background .12s;display:flex;align-items:center;justify-content:center;font-size:28px">üîµ</div>
    <div id="siBtn3" style="position:absolute;bottom:0;right:0;width:120px;height:120px;border-radius:20px 20px 60px 20px;background:#4a3a1a;border:3px solid #6a5a2a;cursor:pointer;transition:background .12s;display:flex;align-items:center;justify-content:center;font-size:28px">üü°</div>
  </div>
  <div id="siMsg" style="font-family:var(--font-head);font-size:16px;font-weight:700;color:var(--mut);margin-top:20px;text-align:center;min-height:24px"></div>
  <button class="btn-gold" id="siStart" onclick="window._siN()" style="margin-top:16px;padding:10px 28px">Start Game</button>`;

  const COLORS = [
    {bg:'#1a4a1a', lit:'#50c850', border:'#2a6a2a'},
    {bg:'#4a1a1a', lit:'#e84040', border:'#6a2a2a'},
    {bg:'#1a1a4a', lit:'#4080e0', border:'#2a2a6a'},
    {bg:'#4a3a1a', lit:'#e8c46a', border:'#6a5a2a'},
  ];
  let sequence = [], playerIdx, round, best=0, state='idle', playing=false;

  function flash(idx, dur=350) {
    return new Promise(res => {
      const btn = document.getElementById('siBtn'+idx);
      btn.style.background = COLORS[idx].lit;
      btn.style.borderColor = COLORS[idx].lit;
      const sfxFns=[SFX.simon0,SFX.simon1,SFX.simon2,SFX.simon3];
      sfxFns[idx]();
      setTimeout(() => {
        btn.style.background = COLORS[idx].bg;
        btn.style.borderColor = COLORS[idx].border;
        setTimeout(res, 120);
      }, dur);
    });
  }

  async function playSequence() {
    playing = true;
    document.getElementById('siSt').textContent = 'Watch!';
    document.getElementById('siMsg').textContent = 'Remember the sequence...';
    await new Promise(r => setTimeout(r, 600));
    for (const c of sequence) {
      await flash(c, 400);
      await new Promise(r => setTimeout(r, 80));
    }
    playing = false;
    playerIdx = 0;
    document.getElementById('siSt').textContent = 'Your turn!';
    document.getElementById('siMsg').textContent = 'Repeat the sequence: ' + sequence.length + ' step(s)';
  }

  async function nextRound() {
    sequence.push(Math.floor(Math.random()*4));
    round = sequence.length;
    document.getElementById('siR').textContent = round;
    await playSequence();
  }

  function playerClick(idx) {
    if (state !== 'running' || playing) return;
    flash(idx, 220);
    if (sequence[playerIdx] === idx) {
      playerIdx++;
      if (playerIdx === sequence.length) {
        if (round > best) { best = round; document.getElementById('siB').textContent = best; }
        document.getElementById('siSt').textContent = '‚úÖ Correct!';
        setTimeout(() => nextRound(), 900);
      }
    } else {
      state = 'gameover';
      SFX.simonErr();
      document.getElementById('siSt').textContent = '‚ùå Wrong!';
      document.getElementById('siMsg').textContent = 'Game over! Round: ' + round + ' ¬∑ Best: ' + best;
      document.getElementById('siStart').textContent = 'Play Again';
      document.getElementById('siStart').style.display = '';
    }
  }

  function startGame() {
    state = 'running'; sequence = []; round = 0;
    document.getElementById('siStart').style.display = 'none';
    document.getElementById('siMsg').textContent = '';
    document.getElementById('siR').textContent = '0';
    nextRound();
  }

  for (let i=0; i<4; i++) {
    document.getElementById('siBtn'+i).addEventListener('click', () => playerClick(i));
  }
  window._siN = startGame;
  CLEANERS.simon = () => { delete window._siN; };
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUDOKU
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BUILDERS.sudoku = function(wrap) {
  wrap.style.cssText = 'flex-direction:column;align-items:center';
  wrap.innerHTML = `<div class="hud-row"><div class="hb"><div class="hl">Errors</div><div class="hv" id="sdE">0</div></div><div class="hb"><div class="hl">‚è±</div><div class="hv" id="sdT">0:00</div></div><div class="hb"><div class="hl">Status</div><div class="hv" id="sdSt">Playing</div></div></div>
  <div style="flex:1;display:flex;align-items:center;justify-content:center;padding:12px;position:relative">
    <div style="display:flex;flex-direction:column;align-items:center;gap:12px">
      <div id="sdGrid" style="display:grid;grid-template-columns:repeat(9,1fr);gap:2px;background:#363220;padding:2px;border-radius:8px;border:2px solid var(--gold4)"></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center">
        ${[1,2,3,4,5,6,7,8,9].map(n=>`<button onclick="window._sdN(${n})" style="width:36px;height:36px;background:var(--surf);border:1px solid var(--bord2);border-radius:8px;color:var(--gold2);font-family:var(--font-head);font-size:16px;font-weight:700;cursor:pointer">${n}</button>`).join('')}
        <button onclick="window._sdN(0)" style="width:36px;height:36px;background:var(--surf);border:1px solid var(--bord2);border-radius:8px;color:var(--mut);font-family:var(--font-head);font-size:14px;cursor:pointer">‚úï</button>
      </div>
      <button class="btn-gold" onclick="window._sdNew()" style="padding:9px 24px;font-size:13px">New Puzzle</button>
    </div>
  </div>`;

  let puzzle, solution, given, selected, errors, startTime, timer;

  const BASE_PUZZLES = [
    '530070000600195000098000060800060003400803001700020006060000280000419005000080079',
    '003020600900305001001806400008102900700000008006708200002609500800203009005010300',
    '200080300060070084030500209000105408000000000402706000301007040720040060004010003',
    '000000907000420180000705026100904000050000040000507009920108000034059000507000000',
  ];

  function parsePuzzle(s) {
    return s.split('').map(c => parseInt(c));
  }

  function solveSudoku(board) {
    const b = [...board];
    function isValid(b, pos, num) {
      const row = Math.floor(pos/9), col = pos%9;
      for (let i=0; i<9; i++) {
        if (b[row*9+i]===num) return false;
        if (b[i*9+col]===num) return false;
        const br=3*Math.floor(row/3)+Math.floor(i/3), bc=3*Math.floor(col/3)+i%3;
        if (b[br*9+bc]===num) return false;
      }
      return true;
    }
    function solve(b) {
      const empty = b.indexOf(0);
      if (empty===-1) return true;
      for (let n=1; n<=9; n++) {
        if (isValid(b,empty,n)) { b[empty]=n; if(solve(b))return true; b[empty]=0; }
      }
      return false;
    }
    solve(b); return b;
  }

  function newPuzzle() {
    clearInterval(timer);
    const src = BASE_PUZZLES[Math.floor(Math.random()*BASE_PUZZLES.length)];
    puzzle = parsePuzzle(src);
    given = puzzle.map(v => v !== 0);
    solution = solveSudoku([...puzzle]);
    selected = -1; errors = 0;
    document.getElementById('sdE').textContent = '0';
    document.getElementById('sdSt').textContent = 'Playing';
    startTime = Date.now();
    timer = setInterval(() => {
      const s = Math.floor((Date.now()-startTime)/1000);
      document.getElementById('sdT').textContent = Math.floor(s/60)+':'+(s%60<10?'0':'')+(s%60);
    }, 1000);
    render();
  }

  function render() {
    const grid = document.getElementById('sdGrid');
    grid.innerHTML = '';
    for (let i=0; i<81; i++) {
      const cell = document.createElement('div');
      const row = Math.floor(i/9), col = i%9;
      const boxR = Math.floor(row/3), boxC = Math.floor(col/3);
      const darken = (boxR+boxC)%2===0;
      const isSelected = i===selected;
      const sameBox = selected>=0 && Math.floor(Math.floor(selected/9)/3)===boxR && Math.floor((selected%9)/3)===boxC;
      const sameRow = selected>=0 && Math.floor(selected/9)===row;
      const sameCol = selected>=0 && selected%9===col;
      const isSame = puzzle[i]>0 && selected>=0 && puzzle[i]===puzzle[selected] && !isSelected;
      cell.style.cssText = `width:38px;height:38px;display:flex;align-items:center;justify-content:center;font-family:var(--font-head);font-size:${puzzle[i]?'18':'14'}px;font-weight:700;cursor:pointer;border-radius:4px;transition:background .1s;border-right:${col===2||col===5?'2px solid var(--gold4)':'1px solid #2a2618'};border-bottom:${row===2||row===5?'2px solid var(--gold4)':'1px solid #2a2618'};`;
      if (isSelected) cell.style.background = 'rgba(201,168,76,.35)';
      else if (isSame) cell.style.background = 'rgba(201,168,76,.18)';
      else if (sameRow||sameCol||sameBox) cell.style.background = darken?'#1a1810':'#161410';
      else cell.style.background = darken?'#151310':'#121008';
      if (given[i]) { cell.style.color = 'var(--txt)'; cell.textContent = puzzle[i]; }
      else if (puzzle[i]) {
        const correct = puzzle[i]===solution[i];
        cell.style.color = correct ? 'var(--gold2)' : '#e84040';
        cell.textContent = puzzle[i];
      }
      cell.addEventListener('click', () => { selected=i; render(); });
      grid.appendChild(cell);
    }
  }

  window._sdN = (n) => {
    if (selected<0 || given[selected]) return;
    if (n===0) { puzzle[selected]=0; SFX.blip(); }
    else {
      if (n!==solution[selected]) { errors++; document.getElementById('sdE').textContent=errors; SFX.wrong2(); }
      else SFX.blip();
      puzzle[selected]=n;
      if (puzzle.every((v,i)=>v===solution[i])) {
        clearInterval(timer);
        document.getElementById('sdSt').textContent='üèÜ Solved!';
        SFX.win();
      }
    }
    render();
  };

  window._sdNew = newPuzzle;
  newPuzzle();
  CLEANERS.sudoku = () => { clearInterval(timer); delete window._sdN; delete window._sdNew; };
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RHYTHM TAP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BUILDERS.rhythm = function(wrap) {
  const W=420, H=500;
  wrap.style.cssText = 'flex-direction:column;align-items:center';
  const SONGS=[
    {name:'Classic',emoji:'üéµ',bpm:120,pat:[0,2,1,3,0,1,2,3,1,0,3,2,0,2,1,3]},
    {name:'Chill',  emoji:'üåä',bpm:80, pat:[0,1,0,2,1,3,0,2,1,0,2,3]},
    {name:'Banger', emoji:'üî•',bpm:155,pat:[0,2,1,3,0,1,3,2,0,3,1,2,0,1,2,3,1,3,0,2]},
    {name:'DnB',    emoji:'‚ö°',bpm:174,pat:[0,3,1,2,3,0,2,1,0,2,3,1,2,0,1,3,0,2,3,1]},
  ];
  let songIdx=0, tempo=1, twoPlayer=false, gameState='menu';

  function buildMenu() {
    wrap.innerHTML=`<div style="flex:1;display:flex;align-items:center;justify-content:center;width:100%;padding:20px">
    <div style="display:flex;flex-direction:column;align-items:center;gap:16px;max-width:440px;width:100%">
      <div style="font-size:40px">üéµ</div>
      <div style="font-family:var(--font-head);font-size:26px;font-weight:800;color:var(--gold2)">Rhythm Tap</div>
      <p style="color:var(--mut);font-size:12px;text-align:center">Choose your song and settings</p>
      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;width:100%">
        ${SONGS.map((s,i)=>`<div id="sBtn${i}" onclick="window._rhSong(${i})" style="background:var(--surf2);border:2px solid ${i===0?'var(--gold)':'var(--bord2)'};border-radius:12px;padding:14px;cursor:pointer;text-align:center;transition:all .15s">
          <div style="font-size:26px">${s.emoji}</div>
          <div style="font-family:var(--font-head);font-size:14px;font-weight:700;color:var(--txt);margin-top:4px">${s.name}</div>
          <div style="font-size:11px;color:var(--mut)">${s.bpm} BPM</div>
        </div>`).join('')}
      </div>
      <div style="display:flex;align-items:center;gap:12px;width:100%">
        <span style="font-size:12px;color:var(--mut);font-weight:600;white-space:nowrap">Tempo:</span>
        <input type="range" id="rhTmpo" min="0.5" max="2" step="0.1" value="1" style="flex:1;accent-color:var(--gold)" oninput="window._rhTempo(this.value)">
        <span id="rhTmpoVal" style="font-family:var(--font-head);font-size:15px;color:var(--gold2);min-width:40px;text-align:right">1.0√ó</span>
      </div>
      <div style="display:flex;background:var(--surf);border:1px solid var(--bord2);border-radius:10px;overflow:hidden;width:100%">
        <div id="rhM1" onclick="window._rhMode(false)" style="flex:1;padding:10px;text-align:center;cursor:pointer;font-size:12px;font-weight:700;background:var(--gold);color:#0c0b08;transition:all .15s">1 Player</div>
        <div id="rhM2" onclick="window._rhMode(true)" style="flex:1;padding:10px;text-align:center;cursor:pointer;font-size:12px;font-weight:700;color:var(--mut);transition:all .15s">2 Player</div>
      </div>
      <button onclick="window._rhStart()" style="width:100%;padding:14px;background:var(--gold);color:#0c0b08;border:none;border-radius:26px;font-size:15px;font-weight:700;cursor:pointer;font-family:inherit">‚ñ∂ Start Game</button>
    </div></div>`;
    window._rhSong=i=>{songIdx=i;SONGS.forEach((_,j)=>{const b=document.getElementById('sBtn'+j);if(b)b.style.borderColor=j===i?'var(--gold)':'var(--bord2)';});};
    window._rhTempo=v=>{tempo=parseFloat(v);const el=document.getElementById('rhTmpoVal');if(el)el.textContent=parseFloat(v).toFixed(1)+'√ó';};
    window._rhMode=tp=>{twoPlayer=tp;const m1=document.getElementById('rhM1'),m2=document.getElementById('rhM2');if(m1){m1.style.background=!tp?'var(--gold)':'transparent';m1.style.color=!tp?'#0c0b08':'var(--mut)';m2.style.background=tp?'var(--gold)':'transparent';m2.style.color=tp?'#0c0b08':'var(--mut)';}};
    window._rhStart=()=>buildGame();
  }

  function buildGame() {
    gameState='playing';
    const song=SONGS[songIdx];
    const spawnMs=Math.round((60000/song.bpm/2)/tempo);
    const NOTE_SPD=9*tempo;

    // ‚îÄ‚îÄ MUSIC ENGINE ‚îÄ‚îÄ
    let musicAC = null;
    function getMusicCtx() {
      if (!musicAC) musicAC = new (window.AudioContext || window.webkitAudioContext)();
      if (musicAC.state==='suspended') musicAC.resume();
      return musicAC;
    }
    function playDrum(type, t) {
      try {
        const ac = getMusicCtx();
        if (type === 'kick') {
          const o = ac.createOscillator(), g = ac.createGain();
          o.connect(g); g.connect(ac.destination);
          o.frequency.setValueAtTime(150, t);
          o.frequency.exponentialRampToValueAtTime(40, t+0.08);
          g.gain.setValueAtTime(0.5, t);
          g.gain.exponentialRampToValueAtTime(0.0001, t+0.18);
          o.start(t); o.stop(t+0.2);
        } else if (type === 'snare') {
          const buf = ac.createBuffer(1, ac.sampleRate*0.12, ac.sampleRate);
          const d = buf.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1;
          const src = ac.createBufferSource(), g = ac.createGain();
          src.buffer=buf; src.connect(g); g.connect(ac.destination);
          const o2=ac.createOscillator(), g2=ac.createGain();
          o2.frequency.value=200; o2.connect(g2); g2.connect(ac.destination);
          g2.gain.setValueAtTime(0.15,t); g2.gain.exponentialRampToValueAtTime(0.0001,t+0.07);
          g.gain.setValueAtTime(0.18,t); g.gain.exponentialRampToValueAtTime(0.0001,t+0.12);
          src.start(t); src.stop(t+0.13); o2.start(t); o2.stop(t+0.08);
        } else if (type === 'hihat') {
          const buf = ac.createBuffer(1, ac.sampleRate*0.06, ac.sampleRate);
          const d = buf.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1;
          const src = ac.createBufferSource(), g = ac.createGain();
          const filt = ac.createBiquadFilter(); filt.type='highpass'; filt.frequency.value=8000;
          src.buffer=buf; src.connect(filt); filt.connect(g); g.connect(ac.destination);
          g.gain.setValueAtTime(0.1,t); g.gain.exponentialRampToValueAtTime(0.0001,t+0.06);
          src.start(t); src.stop(t+0.07);
        } else if (type === 'bass') {
          const o=ac.createOscillator(), g=ac.createGain();
          const notes=[55,73,82,55,73,98,73,82][Math.floor(Math.random()*8)];
          o.type='sawtooth'; o.connect(g); g.connect(ac.destination);
          o.frequency.setValueAtTime(notes, t);
          g.gain.setValueAtTime(0.12,t); g.gain.exponentialRampToValueAtTime(0.0001,t+0.3);
          o.start(t); o.stop(t+0.35);
        }
      } catch(e) {}
    }
    let musicTimer = null;
    function scheduleBeat(beatN) {
      try {
        const ac = getMusicCtx();
        const bpmActual = song.bpm * tempo;
        const beatDur = 60 / bpmActual;
        const t = ac.currentTime + 0.05;
        const b = beatN % 4;
        playDrum('hihat', t);
        if (b===0) { playDrum('kick',t); playDrum('bass',t+beatDur*0.5); }
        if (b===2) { playDrum('snare',t); }
        if (b===1||b===3) { playDrum('kick',t+beatDur*0.5); }
      } catch(e) {}
    }
    let beatCount=0;
    musicTimer = setInterval(()=>{ scheduleBeat(beatCount++); }, Math.round(60000/song.bpm/tempo));

    wrap.innerHTML=`<div class="hud-row">
      <div class="hb"><div class="hl">P1 Score</div><div class="hv" id="rhS1">0</div></div>
      <div class="hb"><div class="hl">Combo</div><div class="hv" id="rhC">0</div></div>
      ${twoPlayer?'<div class="hb"><div class="hl">P2 Score</div><div class="hv" id="rhS2">0</div></div>':''}
      <div class="hb"><div class="hl">${song.emoji} ${song.name}</div><div class="hv" style="font-size:12px">${Math.round(song.bpm*tempo)}BPM</div></div>
    </div>
    <div style="flex:1;display:flex;align-items:center;justify-content:center;padding:8px;position:relative;width:100%;min-height:0">
    <canvas id="rhCv" width="${W}" height="${H}" style="border-radius:12px;border:1px solid #2a2618;max-height:calc(100vh - 120px)"></canvas></div>
    <p style="color:var(--mut);font-size:11px;padding-bottom:6px">${twoPlayer?'P1: D F J K | P2: ‚Üê ‚Üì ‚Üë ‚Üí':'Tap D F J K or click lanes!'} ¬∑ Esc=Menu</p>`;
    const cv=document.getElementById('rhCv'),ctx=cv.getContext('2d');
    const LANES=4,LW=W/LANES,HIT_Y=H-70;
    const P1_KEYS=['d','f','j','k'],P2_KEYS=['ArrowLeft','ArrowDown','ArrowUp','ArrowRight'];
    const COLS=['#e84040','#e8c46a','#4080e0','#50c850'];
    let notes=[],s1=0,s2=0,combo=0,effects=[],fr=0,raf,paused=false,patIdx=0;
    let noteInterval=setInterval(()=>{if(!paused){const lane=song.pat[patIdx%song.pat.length];patIdx++;notes.push({lane,y:-22,hit:false});}},spawnMs);
    function hit(lane,player=1){
      const close=notes.filter(n=>!n.hit&&n.lane===lane&&Math.abs(n.y-HIT_Y)<52);
      if(close.length){close[0].hit=true;combo++;const pts=100+combo*8;if(player===1)s1+=pts;else s2+=pts;document.getElementById('rhS1').textContent=s1;if(twoPlayer&&document.getElementById('rhS2'))document.getElementById('rhS2').textContent=s2;document.getElementById('rhC').textContent=combo;effects.push({lane,txt:'+'+pts,life:28,y:HIT_Y-38,col:'#e8c46a'});SFX.note(lane);}
      else{combo=0;document.getElementById('rhC').textContent=0;effects.push({lane,txt:'MISS',life:22,y:HIT_Y-38,col:'#e84040',miss:true});SFX.miss();}
    }
    function rdr(){
      ctx.fillStyle='#0c0b08';ctx.fillRect(0,0,W,H);
      // Background pulse effect in sync with music
      const pulse = Math.sin(Date.now()/(60000/song.bpm/tempo/Math.PI/2))*0.03;
      for(let i=0;i<LANES;i++){
        const rgb=i===0?'232,64,64':i===1?'232,196,74':i===2?'64,128,224':'80,200,80';
        if(i>0){ctx.strokeStyle='#1e1c12';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(i*LW,0);ctx.lineTo(i*LW,H);ctx.stroke();}
        ctx.fillStyle=`rgba(${rgb},${0.07+pulse})`;ctx.fillRect(i*LW,0,LW,H);
        ctx.fillStyle=`rgba(${rgb},.3)`;ctx.beginPath();ctx.roundRect(i*LW+7,HIT_Y-18,LW-14,36,8);ctx.fill();
        ctx.font='700 12px DM Sans,sans-serif';ctx.fillStyle='rgba(255,255,255,.35)';ctx.textAlign='center';
        ctx.fillText(P1_KEYS[i].toUpperCase(),i*LW+LW/2,HIT_Y+6);
        if(twoPlayer){ctx.font='600 10px DM Sans,sans-serif';ctx.fillStyle='rgba(255,200,80,.45)';ctx.fillText(P2_KEYS[i].replace('Arrow','').charAt(0),i*LW+LW/2,HIT_Y+20);}
      }
      notes.forEach(n=>{if(n.hit)return;const rgb=COLS[n.lane];ctx.fillStyle=rgb;ctx.shadowColor=rgb;ctx.shadowBlur=14;ctx.beginPath();ctx.roundRect(n.lane*LW+5,n.y-18,LW-10,36,8);ctx.fill();ctx.shadowBlur=0;if(!paused)n.y+=NOTE_SPD;if(n.y>HIT_Y+70){n.hit=true;combo=0;document.getElementById('rhC').textContent=0;}});
      effects.forEach(ef=>{ctx.font=`700 ${ef.miss?16:13}px DM Sans,sans-serif`;ctx.fillStyle=ef.col;ctx.textAlign='center';ctx.fillText(ef.txt,ef.lane*LW+LW/2,ef.y);if(!paused){ef.y-=1.2;ef.life--;}});
      effects=effects.filter(e=>e.life>0);
      if(paused){ctx.fillStyle='rgba(8,7,4,.8)';ctx.fillRect(0,0,W,H);ctx.textAlign='center';ctx.font='800 26px Syne,sans-serif';ctx.fillStyle='#e8c46a';ctx.fillText('PAUSED',W/2,H/2);ctx.font='700 12px DM Sans,sans-serif';ctx.fillStyle='#857d5f';ctx.fillText('P to resume ¬∑ Esc for menu',W/2,H/2+30);}
      fr++;raf=requestAnimationFrame(rdr);
    }
    raf=requestAnimationFrame(rdr);
    const kH=e=>{
      if(e.key==='Escape'||e.key==='Esc'){clearInterval(noteInterval);clearInterval(musicTimer);cancelAnimationFrame(raf);window.removeEventListener('keydown',kH);if(musicAC){try{musicAC.close();}catch(e){}}gameState='menu';buildMenu();return;}
      if(e.key==='p'||e.key==='P'){paused=!paused;return;}
      if(paused)return;
      const i1=P1_KEYS.indexOf(e.key.toLowerCase());if(i1!==-1)hit(i1,1);
      if(twoPlayer){const i2=P2_KEYS.indexOf(e.key);if(i2!==-1){e.preventDefault();hit(i2,2);}}
    };
    window.addEventListener('keydown',kH);
    cv.addEventListener('click',e=>{if(paused)return;const r=cv.getBoundingClientRect();const mx=(e.clientX-r.left)*(W/r.width);hit(Math.floor(mx/LW),1);});
    PAUSE_CBS.rhythm=p=>{paused=p;};
    CLEANERS.rhythm=()=>{cancelAnimationFrame(raf);clearInterval(noteInterval);clearInterval(musicTimer);if(musicAC){try{musicAC.close();}catch(e){}}window.removeEventListener('keydown',kH);delete window._rhSong;delete window._rhTempo;delete window._rhMode;delete window._rhStart;};
  }
  buildMenu();
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ROAD RACER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BUILDERS.racing3d = function(wrap) {
  const W=500, H=440;
  wrap.style.cssText = 'flex-direction:column;align-items:center';
  wrap.innerHTML = `<div class="hud-row"><div class="hb"><div class="hl">Speed</div><div class="hv" id="rrSp">0</div></div><div class="hb"><div class="hl">Score</div><div class="hv" id="rrS">0</div></div><div class="hb"><div class="hl">Best</div><div class="hv" id="rrB">0</div></div></div>
  <div style="flex:1;display:flex;align-items:center;justify-content:center;padding:10px;position:relative;width:100%"><canvas id="rrCv" width="${W}" height="${H}" style="border-radius:12px;border:1px solid #2a2618;max-width:100%"></canvas></div>
  <p style="color:var(--mut);font-size:12px;padding-bottom:8px">‚Üê ‚Üí / A D to steer ¬∑ Space=accelerate</p>`;
  const cv = document.getElementById('rrCv'), ctx = cv.getContext('2d');
  const SEGS=150, SEG_LEN=200, CAM_H=1000;
  let road, camZ, playerX, speed, score, best=0, state='idle', raf, fr;
  const keys = {};
  const kH2 = e => { keys[e.key]=e.type==='keydown'; };
  window.addEventListener('keydown', kH2); window.addEventListener('keyup', kH2);
  function mkRoad() { road=Array.from({length:SEGS},(_,i)=>({curve:Math.sin(i/10)*(i%30<15?.5:-.5)*1.5})); }
  function init() { camZ=0; playerX=0; speed=0; score=0; fr=0; mkRoad(); }
  init(); state='idle'; // pre-init road so render loop doesn't crash
  function project(x, z) { const dz=z-camZ; if(dz<=0)return null; const scale=CAM_H/(dz*.1); const sx=W/2+(x-playerX)*scale; const sy=H/2; return {sx,sy,scale}; }
  function render() {
    ctx.fillStyle='#1a3060'; ctx.fillRect(0,0,W,H/2+20);
    ctx.fillStyle='#2a6e2a'; ctx.fillRect(0,H/2+20,W,H/2-20);
    const startSeg=Math.floor(camZ/SEG_LEN)%SEGS;
    let curveAcc=0;
    for(let i=80;i>0;i--){
      const segIdx=(startSeg+i)%SEGS;const seg=road[segIdx];
      const z=camZ+(i-1)*SEG_LEN; const z2=camZ+i*SEG_LEN;
      const p1=project(curveAcc,z); const p2=project(curveAcc+seg.curve*.5,z2);
      curveAcc+=seg.curve*.5;
      if(!p1||!p2)continue;
      const stripe=Math.floor(z/SEG_LEN)%2;
      ctx.fillStyle=stripe?'#888':'#aaa';
      ctx.beginPath();ctx.moveTo(p2.sx-40*p2.scale,p2.sy);ctx.lineTo(p2.sx+40*p2.scale,p2.sy);ctx.lineTo(p1.sx+40*p1.scale,p1.sy);ctx.lineTo(p1.sx-40*p1.scale,p1.sy);ctx.closePath();ctx.fill();
    }
    ctx.fillStyle='#c9a84c'; ctx.beginPath(); ctx.roundRect(W/2-24,H-90,48,36,5); ctx.fill();
    ctx.fillStyle='#e8c46a'; ctx.beginPath(); ctx.roundRect(W/2-18,H-108,36,22,4); ctx.fill();
    if(state==='idle')cvBanner(ctx,W,H,'ROAD RACER','Dodge traffic ‚Äî OutRun style!','SPACE to Start ¬∑ Arrows/AD to steer');
    else if(state==='paused')cvBanner(ctx,W,H,'PAUSED','','P to Resume');
    raf=requestAnimationFrame(render);
    if(state==='running'){
      fr++;
      if(keys['ArrowLeft']||keys['a']||keys['A'])playerX-=0.02*speed;
      if(keys['ArrowRight']||keys['d']||keys['D'])playerX+=0.02*speed;
      if(keys[' ']||keys['Space'])speed=Math.min(speed+.08,4);else speed=Math.max(speed-.04,0.5);
      camZ+=speed*SEG_LEN*.05; score+=Math.floor(speed);
      document.getElementById('rrSp').textContent=Math.floor(speed*20);
      document.getElementById('rrS').textContent=score;
      if(score>best){best=score;document.getElementById('rrB').textContent=best;}
      playerX=Math.max(-.9,Math.min(.9,playerX));
    }
  }
  raf=requestAnimationFrame(render);
  const spH2 = e => {
    if(e.code==='Space'&&state!=='running'){e.preventDefault();init();state='running';}
    if((e.key==='p'||e.key==='P')&&(state==='running'||state==='paused')){state=state==='paused'?'running':'paused';}
  };
  window.addEventListener('keydown', spH2);
  PAUSE_CBS.racing3d = p => { state=p?'paused':'running'; };
  CLEANERS.racing3d = () => { cancelAnimationFrame(raf); window.removeEventListener('keydown',kH2); window.removeEventListener('keyup',kH2); window.removeEventListener('keydown',spH2); };
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STREET FIGHTER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BUILDERS.fighter = function(wrap) {
  const W=600, H=360;
  wrap.style.cssText = 'flex-direction:column;align-items:center';
  wrap.innerHTML = `<div class="hud-row"><div class="hb" style="flex:1"><div class="hl">üî¥ Player 1</div><div style="width:100%;background:var(--bord);border-radius:4px;height:12px;margin:4px 0"><div id="hp1bar" style="height:12px;border-radius:4px;background:#e84040;width:100%;transition:width .1s"></div></div></div><div class="hb"><div class="hl">Round</div><div class="hv" id="ftR">1</div></div><div class="hb" style="flex:1"><div class="hl" style="text-align:right">Player 2 üîµ</div><div style="width:100%;background:var(--bord);border-radius:4px;height:12px;margin:4px 0"><div id="hp2bar" style="height:12px;border-radius:4px;background:#4080e0;width:100%;transition:width .1s"></div></div></div></div>
  <div style="flex:1;display:flex;align-items:center;justify-content:center;padding:10px;position:relative;width:100%"><canvas id="ftCv" width="${W}" height="${H}" style="border-radius:12px;border:1px solid #2a2618;max-width:100%"></canvas></div>
  <p style="color:var(--mut);font-size:12px;padding-bottom:8px">P1: WASD+F(punch)G(kick) ¬∑ P2: Arrows+L(punch)K(kick)</p>`;
  const cv = document.getElementById('ftCv'), ctx = cv.getContext('2d');
  const GND=H-60;
  let p1, p2, state='idle', raf, fr, w1=0, w2=0, round=1, effects=[];
  const keys = {};
  const kH = e => { keys[e.key]=e.type==='keydown'; };
  window.addEventListener('keydown', kH); window.addEventListener('keyup', kH);
  function mkFighter(x,col,flip) { return {x,y:GND-80,w:40,h:80,vx:0,vy:0,hp:100,maxHp:100,col,flip,atkTimer:0,hurtTimer:0}; }
  function init() { p1=mkFighter(120,['#e84040','#ff6060'],false); p2=mkFighter(W-160,['#4080e0','#6090ff'],true); effects=[]; document.getElementById('ftR').textContent=round; }
  function drawFighter(p,label) {
    const x=p.x, y=p.y;
    ctx.save();
    if(p.flip){ctx.translate(x*2+p.w,0);ctx.scale(-1,1);}
    ctx.fillStyle=p.hurtTimer>0?'#fff':p.col[0]; ctx.beginPath(); ctx.roundRect(x,y+20,p.w,p.h-20,5); ctx.fill();
    ctx.fillStyle=p.hurtTimer>0?'#fff':p.col[1]; ctx.beginPath(); ctx.ellipse(x+p.w/2,y+12,16,16,0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#fff'; ctx.beginPath(); ctx.ellipse(x+26,y+10,4,4,0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#0c0b08'; ctx.beginPath(); ctx.arc(x+25,y+10,2.5,0,Math.PI*2); ctx.fill();
    if(p.atkTimer>10){ctx.fillStyle=p.col[1];ctx.fillRect(x+p.w,y+30,30,10);}
    ctx.restore();
    ctx.fillStyle='rgba(255,255,255,.5)'; ctx.font='700 11px DM Sans,sans-serif'; ctx.textAlign='center'; ctx.fillText(label,x+p.w/2,y-6);
  }
  function attack(attacker,defender) { if(attacker.atkTimer>0)return; const dist=Math.abs(attacker.x-defender.x); if(dist<100){const dmg=12;defender.hp=Math.max(0,defender.hp-dmg);defender.hurtTimer=20;SFX.hit();effects.push({x:defender.x+defender.w/2,y:defender.y+30,txt:'-'+dmg,life:30,col:'#e84040'});} attacker.atkTimer=30; }
  function update() {
    fr++;
    p1.vx=0;
    if(keys['a']||keys['A']){p1.vx=-3;p1.flip=false;} if(keys['d']||keys['D']){p1.vx=3;p1.flip=true;}
    if((keys['w']||keys['W'])&&p1.y>=GND-p1.h)p1.vy=-13;
    if(keys['f']||keys['F'])attack(p1,p2); if(keys['g']||keys['G'])attack(p1,p2);
    p2.vx=0;
    if(keys['ArrowLeft']){p2.vx=-3;p2.flip=false;} if(keys['ArrowRight']){p2.vx=3;p2.flip=true;}
    if(keys['ArrowUp']&&p2.y>=GND-p2.h)p2.vy=-13;
    if(keys['l']||keys['L'])attack(p2,p1); if(keys['k']||keys['K'])attack(p2,p1);
    [p1,p2].forEach(p=>{p.vy+=0.7;p.x+=p.vx;p.y+=p.vy;if(p.y>GND-p.h){p.y=GND-p.h;p.vy=0;}p.x=Math.max(0,Math.min(W-p.w,p.x));if(p.atkTimer>0)p.atkTimer--;if(p.hurtTimer>0)p.hurtTimer--;});
    document.getElementById('hp1bar').style.width=(p1.hp/p1.maxHp*100)+'%';
    document.getElementById('hp2bar').style.width=(p2.hp/p2.maxHp*100)+'%';
    if(p1.hp<=0||p2.hp<=0){
      const winner=p1.hp>p2.hp?'üî¥ P1':'üîµ P2';
      if(p1.hp>p2.hp)w1++;else w2++;
      round++;document.getElementById('ftR').textContent=round;
      effects.push({x:W/2,y:H/2,txt:winner+' WINS!',life:180,col:'#e8c46a',big:true});
      if(w1>=3||w2>=3){state='gameover';}else{setTimeout(()=>{init();},2500);}
    }
  }
  function render() {
    ctx.fillStyle='#1a0a08'; ctx.fillRect(0,0,W,H);
    for(let i=0;i<30;i++){ctx.fillStyle=`hsl(${i*30},30%,20%)`;ctx.fillRect(i*22,0,20,H-80);}
    ctx.fillStyle='#2a1808'; ctx.fillRect(0,GND,W,H-GND);
    ctx.fillStyle='#3a2010'; ctx.fillRect(0,GND,W,12);
    drawFighter(p1,'P1 WASD+FG'); drawFighter(p2,'P2 ‚Üë‚Üê‚Üí+LK');
    effects.forEach(ef=>{ctx.font=`${ef.big?'800 28':'700 15'}px ${ef.big?'Syne':'DM Sans'},sans-serif`;ctx.fillStyle=ef.col;ctx.textAlign='center';ctx.fillText(ef.txt,ef.x,ef.y-(30-ef.life)*.5);ef.y-=.5;ef.life--;});
    effects=effects.filter(e=>e.life>0);
    if(state==='idle')cvBanner(ctx,W,H,'STREET FIGHTER','2 Player local battle!','SPACE to Start');
    else if(state==='paused')cvBanner(ctx,W,H,'PAUSED','','P to Resume');
    else if(state==='gameover'){const w=w1>=3?'üî¥ Player 1':'üîµ Player 2';cvBanner(ctx,W,H,w+' Wins!',w1+' ‚Äî '+w2,'SPACE to Play Again');}
    raf=requestAnimationFrame(render); if(state==='running')update();
  }
  init(); // pre-init so render() has valid p1/p2/effects on first frame
  raf=requestAnimationFrame(render);
  const spH = e => {
    if(e.code==='Space'){if(state==='idle'||state==='gameover'){init();state='running';w1=0;w2=0;round=1;}return;}
    if(e.key==='p'||e.key==='P'){state=state==='paused'?'running':'paused';}
  };
  window.addEventListener('keydown', spH);
  PAUSE_CBS.fighter = p => { state=p?'paused':'running'; };
  CLEANERS.fighter = () => { cancelAnimationFrame(raf); window.removeEventListener('keydown',kH); window.removeEventListener('keyup',kH); window.removeEventListener('keydown',spH); };
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TRIVIA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BUILDERS.trivia = function(wrap) {
  wrap.style.cssText = 'flex-direction:column;align-items:center;justify-content:center';
  wrap.innerHTML = `<div style="width:100%;max-width:560px;padding:16px;display:flex;flex-direction:column;gap:14px;align-items:center">
  <div class="hud-row" style="width:100%"><div class="hb"><div class="hl">Score</div><div class="hv" id="tvS">0</div></div><div class="hb"><div class="hl">Question</div><div class="hv" id="tvQ">1/15</div></div><div class="hb"><div class="hl">Streak</div><div class="hv" id="tvSt">0üî•</div></div></div>
  <div class="trivia-prog"><div class="trivia-prog-fill" id="tvProg" style="width:0%"></div></div>
  <div class="trivia-q" id="tvQtxt">Loading...</div>
  <div class="trivia-opts" id="tvOpts"></div>
  <div id="tvMsg" style="font-family:var(--font-head);font-size:16px;font-weight:700;color:var(--gold);min-height:22px;text-align:center"></div>
  </div>`;
  const QS=[
    {q:"What is the capital of France?",a:"Paris",opts:["Berlin","Paris","Madrid","Rome"]},
    {q:"How many sides does a hexagon have?",a:"6",opts:["5","6","7","8"]},
    {q:"What planet is known as the Red Planet?",a:"Mars",opts:["Venus","Jupiter","Mars","Saturn"]},
    {q:"Who painted the Mona Lisa?",a:"Leonardo da Vinci",opts:["Picasso","Michelangelo","Leonardo da Vinci","Raphael"]},
    {q:"What is the largest ocean on Earth?",a:"Pacific",opts:["Atlantic","Indian","Arctic","Pacific"]},
    {q:"What is 7 √ó 8?",a:"56",opts:["48","54","56","64"]},
    {q:"What gas do plants absorb from the air?",a:"Carbon dioxide",opts:["Oxygen","Nitrogen","Carbon dioxide","Hydrogen"]},
    {q:"How many continents are there?",a:"7",opts:["5","6","7","8"]},
    {q:"What is the fastest land animal?",a:"Cheetah",opts:["Lion","Cheetah","Horse","Falcon"]},
    {q:"In what year did World War 2 end?",a:"1945",opts:["1943","1944","1945","1946"]},
    {q:"What is the chemical symbol for Gold?",a:"Au",opts:["Go","Gd","Au","Ag"]},
    {q:"How many strings does a standard guitar have?",a:"6",opts:["4","5","6","7"]},
    {q:"What is the smallest planet in our solar system?",a:"Mercury",opts:["Mars","Mercury","Pluto","Venus"]},
    {q:"Who wrote 'Romeo and Juliet'?",a:"Shakespeare",opts:["Dickens","Shakespeare","Twain","Austen"]},
    {q:"What is the square root of 144?",a:"12",opts:["10","11","12","14"]},
    {q:"What country has the most natural lakes?",a:"Canada",opts:["Russia","USA","Canada","Finland"]},
    {q:"What is the main ingredient in guacamole?",a:"Avocado",opts:["Tomato","Lime","Avocado","Onion"]},
    {q:"How many bones are in the human body?",a:"206",opts:["196","206","216","226"]},
    {q:"What is the longest river in the world?",a:"Nile",opts:["Amazon","Nile","Yangtze","Mississippi"]},
    {q:"What does CPU stand for?",a:"Central Processing Unit",opts:["Central Processing Unit","Computer Power Unit","Core Program Utility","Control Processing Unit"]},
    {q:"Which element has the atomic number 1?",a:"Hydrogen",opts:["Helium","Hydrogen","Lithium","Carbon"]},
    {q:"What sport is played at Wimbledon?",a:"Tennis",opts:["Cricket","Tennis","Golf","Badminton"]},
    {q:"How many players are on a basketball team?",a:"5",opts:["4","5","6","7"]},
    {q:"What is the hardest natural substance?",a:"Diamond",opts:["Gold","Platinum","Diamond","Titanium"]},
    {q:"What language has the most native speakers?",a:"Mandarin Chinese",opts:["English","Spanish","Mandarin Chinese","Hindi"]},
    {q:"What is the powerhouse of the cell?",a:"Mitochondria",opts:["Nucleus","Ribosome","Mitochondria","Golgi Apparatus"]},
    {q:"What year was the iPhone first released?",a:"2007",opts:["2005","2006","2007","2008"]},
    {q:"What does HTML stand for?",a:"HyperText Markup Language",opts:["HyperText Markup Language","High Transfer Markup Link","HyperTransfer Markup Layer","HyperText Machine Language"]},
    {q:"Which planet has the most moons?",a:"Saturn",opts:["Jupiter","Saturn","Uranus","Neptune"]},
    {q:"What is 15% of 200?",a:"30",opts:["20","25","30","35"]},
  ];
  let qList, qIdx, score, streak, ans;
  function shuffle(a) { return [...a].sort(() => Math.random()-.5); }
  function startQuiz() { qList=shuffle(QS).slice(0,15); qIdx=0; score=0; streak=0; document.getElementById('tvS').textContent='0'; document.getElementById('tvSt').textContent='0üî•'; showQ(); }
  function showQ() {
    const q=qList[qIdx]; ans=null;
    document.getElementById('tvQtxt').textContent=q.q;
    document.getElementById('tvQ').textContent=(qIdx+1)+'/'+qList.length;
    document.getElementById('tvProg').style.width=(qIdx/qList.length*100)+'%';
    document.getElementById('tvMsg').textContent='';
    const opts=document.getElementById('tvOpts'); opts.innerHTML='';
    shuffle(q.opts).forEach(opt=>{
      const b=document.createElement('div'); b.className='trivia-opt'; b.textContent=opt;
      b.addEventListener('click',()=>{
        if(ans)return; ans=opt;
        const correct=opt===q.a;
        document.querySelectorAll('.trivia-opt').forEach(el=>{el.classList.add('locked');if(el.textContent===q.a)el.classList.add('correct');else if(el.textContent===opt&&!correct)el.classList.add('wrong');});
        if(correct){streak++;score+=100+streak*20;SFX.correct2();document.getElementById('tvMsg').textContent='‚úÖ Correct! +'+(100+streak*20);document.getElementById('tvSt').textContent=streak+'üî•';}
        else{streak=0;SFX.wrong2();document.getElementById('tvMsg').textContent='‚ùå Answer: '+q.a;document.getElementById('tvSt').textContent='0üî•';}
        document.getElementById('tvS').textContent=score;
        setTimeout(()=>{qIdx++;if(qIdx<qList.length)showQ();else finish();},1600);
      });
      opts.appendChild(b);
    });
  }
  function finish() { mkOv(wrap,'Quiz Complete! üéâ','Score: '+score+' ¬∑ '+(score>1200?'üèÜ Expert!':score>800?'‚≠ê Great!':'üëç Good effort!'),'<button class="btn-gold" onclick="window._tvNew()">Play Again</button><button class="btn-out" onclick="goHome()">Exit</button>'); }
  window._tvNew = () => { hideOv(wrap); startQuiz(); };
  startQuiz();
  CLEANERS.trivia = () => { delete window._tvNew; };
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// 2048
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BUILDERS.g2048 = function(wrap) {
  wrap.style.cssText = 'flex-direction:column;align-items:center';
  wrap.innerHTML = `<div class="hud-row"><div class="hb"><div class="hl">Score</div><div class="hv" id="g2S">0</div></div><div class="hb"><div class="hl">Best</div><div class="hv" id="g2B">0</div></div></div>
  <div style="flex:1;display:flex;align-items:center;justify-content:center;padding:12px;position:relative;touch-action:none">
  <div style="display:flex;flex-direction:column;align-items:center;gap:10px"><div id="b2048"></div><button class="btn-gold" onclick="window._2048n()" style="padding:9px 24px;font-size:13px">New Game</button></div></div>
  <p style="color:var(--mut);font-size:12px;padding-bottom:8px">Arrow Keys or Swipe to merge tiles</p>`;
  let board, score=0, best=0;
  function addTile(b) { const e=[]; b.forEach((r,y)=>r.forEach((v,x)=>{if(!v)e.push({x,y});})); if(!e.length)return; const{x,y}=e[Math.floor(Math.random()*e.length)]; b[y][x]=Math.random()<.9?2:4; }
  function slide(row) { let r=row.filter(v=>v); for(let i=0;i<r.length-1;i++){if(r[i]===r[i+1]){r[i]*=2;score+=r[i];r.splice(i+1,1);}} while(r.length<4)r.push(0); return r; }
  function move(d) {
    const prev=JSON.stringify(board);
    if(d==='left')board=board.map(r=>slide(r));
    else if(d==='right')board=board.map(r=>slide([...r].reverse()).reverse());
    else{for(let x=0;x<4;x++){let col=board.map(r=>r[x]);if(d==='down')col.reverse();col=slide(col);if(d==='down')col.reverse();board.forEach((r,y)=>r[x]=col[y]);}}
    if(JSON.stringify(board)!==prev){addTile(board);SFX.blip();}
    if(score>best)best=score;
    document.getElementById('g2S').textContent=score; document.getElementById('g2B').textContent=best; ren2048();
    let mv=false; for(let y=0;y<4;y++)for(let x=0;x<4;x++){if(!board[y][x])mv=true;if(x<3&&board[y][x]===board[y][x+1])mv=true;if(y<3&&board[y][x]===board[y+1][x])mv=true;}
    if(!mv){SFX.lose();mkOv(wrap,'GAME OVER','No moves left! Score: '+score,'<button class="btn-gold" onclick="window._2048n()">Play Again</button><button class="btn-out" onclick="goHome()">Exit</button>');}
  }
  const TC={2:'t2',4:'t4',8:'t8',16:'t16',32:'t32',64:'t64',128:'t128',256:'t256',512:'t512',1024:'t1024',2048:'t2048'};
  function ren2048() { const b=document.getElementById('b2048'); b.innerHTML=''; board.forEach(row=>row.forEach(v=>{const t=document.createElement('div');t.className='tile'+(v?' '+TC[v]:'');if(v)t.textContent=v;b.appendChild(t);})); }
  window._2048n = () => { board=Array.from({length:4},()=>Array(4).fill(0)); score=0; document.getElementById('g2S').textContent='0'; addTile(board); addTile(board); hideOv(wrap); ren2048(); };
  window._2048n();
  const kH = e => { const m={ArrowLeft:'left',ArrowRight:'right',ArrowUp:'up',ArrowDown:'down'}; if(m[e.key]){e.preventDefault();move(m[e.key]);} };
  window.addEventListener('keydown', kH);
  const bd=document.getElementById('b2048'); let tx=0,ty=0;
  bd.addEventListener('touchstart',e=>{tx=e.touches[0].clientX;ty=e.touches[0].clientY;},{passive:true});
  bd.addEventListener('touchend',e=>{const dx=e.changedTouches[0].clientX-tx,dy=e.changedTouches[0].clientY-ty;if(Math.abs(dx)>Math.abs(dy))move(dx>0?'right':'left');else move(dy>0?'down':'up');});
  CLEANERS.g2048 = () => { window.removeEventListener('keydown', kH); delete window._2048n; };
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MINESWEEPER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BUILDERS.minesweep = function(wrap) {
  const COLS=12, ROWS=10, MINES=16;
  wrap.style.cssText = 'flex-direction:column;align-items:center';
  wrap.innerHTML = `<div class="hud-row"><div class="hb"><div class="hl">üí£</div><div class="hv" id="msM">${MINES}</div></div><div class="hb"><div class="hl">‚è±</div><div class="hv" id="msT">0</div></div><div class="hb"><div class="hl">Status</div><div class="hv" id="msSt">üòä</div></div></div>
  <div style="flex:1;display:flex;align-items:center;justify-content:center;padding:10px;position:relative"><div style="display:flex;flex-direction:column;align-items:center;gap:10px"><div id="msG" style="display:grid;grid-template-columns:repeat(${COLS},1fr)"></div><button class="btn-gold" onclick="window._msN()" style="padding:9px 24px;font-size:13px">New Game</button></div></div>
  <p style="color:var(--mut);font-size:12px;padding-bottom:8px">Left click=reveal ¬∑ Right click=flag üö©</p>`;
  let board, rev, flagged, over, won, first, timer, el;
  function init() { board=Array.from({length:ROWS},()=>Array(COLS).fill(0)); rev=Array.from({length:ROWS},()=>Array(COLS).fill(false)); flagged=Array.from({length:ROWS},()=>Array(COLS).fill(false)); over=false; won=false; first=true; el=0; clearInterval(timer); document.getElementById('msT').textContent='0'; document.getElementById('msSt').textContent='üòä'; document.getElementById('msM').textContent=MINES; hideOv(wrap); ren(); }
  function place(sx,sy) { let p=0; while(p<MINES){const x=Math.floor(Math.random()*COLS),y=Math.floor(Math.random()*ROWS);if(board[y][x]!=='M'&&!(Math.abs(x-sx)<=1&&Math.abs(y-sy)<=1)){board[y][x]='M';p++;}} for(let y=0;y<ROWS;y++)for(let x=0;x<COLS;x++){if(board[y][x]==='M')continue;let c=0;for(let dy=-1;dy<=1;dy++)for(let dx=-1;dx<=1;dx++){const ny=y+dy,nx=x+dx;if(ny>=0&&ny<ROWS&&nx>=0&&nx<COLS&&board[ny][nx]==='M')c++;}board[y][x]=c;} }
  function reveal(x,y) { if(x<0||x>=COLS||y<0||y>=ROWS||rev[y][x]||flagged[y][x])return; rev[y][x]=true; if(board[y][x]===0)for(let dy=-1;dy<=1;dy++)for(let dx=-1;dx<=1;dx++)reveal(x+dx,y+dy); }
  function cntF() { let f=0; flagged.forEach(r=>r.forEach(v=>{if(v)f++;})); return f; }
  function checkWin() { for(let y=0;y<ROWS;y++)for(let x=0;x<COLS;x++){if(board[y][x]!=='M'&&!rev[y][x])return false;} return true; }
  function click(x,y) {
    if(over||flagged[y][x]||rev[y][x])return;
    if(first){first=false;place(x,y);timer=setInterval(()=>{el++;document.getElementById('msT').textContent=el;},1000);}
    if(board[y][x]==='M'){rev[y][x]=true;over=true;clearInterval(timer);SFX.explode();document.getElementById('msSt').textContent='üí•';for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++)if(board[r][c]==='M')rev[r][c]=true;mkOv(wrap,'GAME OVER üí•','You hit a mine! Time: '+el+'s','<button class="btn-gold" onclick="window._msN()">Try Again</button><button class="btn-out" onclick="goHome()">Exit</button>');}
    else{reveal(x,y);if(checkWin()){won=true;over=true;clearInterval(timer);SFX.win();document.getElementById('msSt').textContent='üèÜ';mkOv(wrap,'YOU WIN! üèÜ','Cleared in '+el+' seconds!','<button class="btn-gold" onclick="window._msN()">Play Again</button><button class="btn-out" onclick="goHome()">Exit</button>');}}
    document.getElementById('msM').textContent=MINES-cntF(); ren();
  }
  function flag(x,y) { if(over||rev[y][x])return; flagged[y][x]=!flagged[y][x]; document.getElementById('msM').textContent=MINES-cntF(); ren(); }
  function ren() {
    const g=document.getElementById('msG'); g.innerHTML='';
    for(let y=0;y<ROWS;y++)for(let x=0;x<COLS;x++){
      const c=document.createElement('div'); c.className='mc'; const rx=x,ry=y;
      if(rev[y][x]){c.classList.add('mr');if(board[y][x]==='M'){c.textContent='üí£';if(over&&!won)c.classList.add('mhit');}else if(board[y][x]>0){c.textContent=board[y][x];c.classList.add('m'+board[y][x]);}}
      else if(flagged[y][x]){c.textContent='üö©';c.classList.add('mf');}
      c.addEventListener('click',()=>click(rx,ry));
      c.addEventListener('contextmenu',e=>{e.preventDefault();flag(rx,ry);});
      let pt; c.addEventListener('touchstart',()=>{pt=setTimeout(()=>flag(rx,ry),500);},{passive:true}); c.addEventListener('touchend',()=>clearTimeout(pt));
      g.appendChild(c);
    }
  }
  window._msN = init; init();
  CLEANERS.minesweep = () => { clearInterval(timer); delete window._msN; };
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PONG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BUILDERS.pong = function(wrap) {
  const W=640, H=400;
  wrap.style.cssText = 'flex-direction:column;align-items:center';
  wrap.innerHTML = `<div style="flex:1;display:flex;align-items:center;justify-content:center;padding:10px;position:relative;width:100%"><canvas id="pgCv" width="${W}" height="${H}" style="border-radius:12px;border:1px solid #2a2618;max-width:100%"></canvas></div><p style="color:var(--mut);font-size:12px;padding-bottom:8px">P1: W/S ¬∑ P2: ‚Üë/‚Üì ¬∑ Space=Start ¬∑ First to 7!</p>`;
  const cv=document.getElementById('pgCv'), ctx=cv.getContext('2d');
  const PH=78, PW=12, BR=9;
  let p1, p2, ball, sc, state='idle', raf;
  function init() { p1={x:20,y:H/2-PH/2}; p2={x:W-20-PW,y:H/2-PH/2}; resetBall(); sc={p1:0,p2:0}; }
  function resetBall() { const a=(Math.random()*.8-.4)+(Math.random()<.5?0:Math.PI); ball={x:W/2,y:H/2,vx:Math.cos(a)*5,vy:Math.sin(a)*5}; }
  const keys = {};
  const kH = e => { keys[e.key]=e.type==='keydown'; };
  window.addEventListener('keydown', kH); window.addEventListener('keyup', kH);
  const spH = e => {
    if(e.code==='Space'){if(state==='idle'||state==='gameover'){init();state='running';}else if(state==='running')state='paused';else if(state==='paused')state='running';}
    if((e.key==='p'||e.key==='P')&&state!=='idle')state=state==='paused'?'running':'paused';
  };
  window.addEventListener('keydown', spH);
  init(); // pre-init so render() has valid p1/p2/ball/sc on first frame
  function update() {
    const sp=6;
    if(keys['w']||keys['W'])p1.y=Math.max(0,p1.y-sp); if(keys['s']||keys['S'])p1.y=Math.min(H-PH,p1.y+sp);
    if(keys['ArrowUp'])p2.y=Math.max(0,p2.y-sp); if(keys['ArrowDown'])p2.y=Math.min(H-PH,p2.y+sp);
    ball.x+=ball.vx; ball.y+=ball.vy;
    if(ball.y-BR<0){ball.y=BR;ball.vy=Math.abs(ball.vy);} if(ball.y+BR>H){ball.y=H-BR;ball.vy=-Math.abs(ball.vy);}
    if(ball.x-BR<p1.x+PW&&ball.y>p1.y&&ball.y<p1.y+PH&&ball.vx<0){ball.vx=Math.abs(ball.vx)+.3;ball.vy+=((ball.y-(p1.y+PH/2))/(PH/2))*3;SFX.bounce();}
    if(ball.x+BR>p2.x&&ball.y>p2.y&&ball.y<p2.y+PH&&ball.vx>0){ball.vx=-(Math.abs(ball.vx)+.3);ball.vy+=((ball.y-(p2.y+PH/2))/(PH/2))*3;SFX.bounce();}
    const sm=16; ball.vx=Math.max(-sm,Math.min(sm,ball.vx)); ball.vy=Math.max(-sm,Math.min(sm,ball.vy));
    if(ball.x<0){sc.p2++;SFX.score();if(sc.p2>=7){state='gameover';SFX.win();}else resetBall();}
    if(ball.x>W){sc.p1++;SFX.score();if(sc.p1>=7){state='gameover';SFX.win();}else resetBall();}
  }
  function render() {
    ctx.fillStyle='#0c0b08'; ctx.fillRect(0,0,W,H);
    ctx.setLineDash([10,10]); ctx.strokeStyle='#1e1c12'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(W/2,0); ctx.lineTo(W/2,H); ctx.stroke(); ctx.setLineDash([]);
    ctx.textAlign='center'; ctx.font='800 48px Syne,sans-serif'; ctx.fillStyle='#222010';
    ctx.fillText(sc.p1,W/4,68); ctx.fillText(sc.p2,3*W/4,68);
    ctx.fillStyle='#c9a84c'; ctx.beginPath(); ctx.roundRect(p1.x,p1.y,PW,PH,4); ctx.fill(); ctx.beginPath(); ctx.roundRect(p2.x,p2.y,PW,PH,4); ctx.fill();
    ctx.fillStyle='#e8c46a'; ctx.shadowColor='#c9a84c'; ctx.shadowBlur=12; ctx.beginPath(); ctx.arc(ball.x,ball.y,BR,0,Math.PI*2); ctx.fill(); ctx.shadowBlur=0;
    if(state==='idle')cvBanner(ctx,W,H,'PONG','P1: W/S  ¬∑  P2: ‚Üë/‚Üì','SPACE to Start');
    else if(state==='paused')cvBanner(ctx,W,H,'PAUSED','','SPACE or P to Resume');
    else if(state==='gameover'){const w=sc.p1>=7?'Player 1 üèÜ':'Player 2 üèÜ';cvBanner(ctx,W,H,w+' Wins!',sc.p1+' ‚Äî '+sc.p2,'SPACE to Play Again');}
    raf=requestAnimationFrame(render); if(state==='running')update();
  }
  raf=requestAnimationFrame(render);
  PAUSE_CBS.pong = p => { state=p?'paused':'running'; };
  CLEANERS.pong = () => { cancelAnimationFrame(raf); window.removeEventListener('keydown',kH); window.removeEventListener('keyup',kH); window.removeEventListener('keydown',spH); };
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONNECT 4
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BUILDERS.connect4 = function(wrap) {
  wrap.style.cssText = 'flex-direction:column;align-items:center';
  wrap.innerHTML = `<div class="hud-row"><div class="hb"><div class="hl">Turn</div><div class="hv" id="c4T">üî¥ P1</div></div><div class="hb"><div class="hl">P1 Wins</div><div class="hv" id="c4W1">0</div></div><div class="hb"><div class="hl">P2 Wins</div><div class="hv" id="c4W2">0</div></div></div>
  <div style="flex:1;display:flex;align-items:center;justify-content:center;padding:12px;position:relative"><div style="display:flex;flex-direction:column;align-items:center;gap:10px"><div id="c4board"></div><button class="btn-gold" onclick="window._c4n()" style="padding:9px 24px;font-size:13px">New Game</button></div></div>
  <p style="color:var(--mut);font-size:12px;padding-bottom:8px">üî¥ P1 vs üü° P2 ¬∑ Click a column</p>`;
  const R=6, C=7;
  let board, turn, w1=0, w2=0;
  function init() { board=Array.from({length:R},()=>Array(C).fill(0)); turn=1; document.getElementById('c4T').textContent='üî¥ P1'; hideOv(wrap); ren(); }
  function drop(col) {
    for(let r=R-1;r>=0;r--){if(!board[r][col]){board[r][col]=turn;SFX.pop();break;}}
    if(checkWin()){if(turn===1){w1++;document.getElementById('c4W1').textContent=w1;}else{w2++;document.getElementById('c4W2').textContent=w2;}ren();SFX.win();mkOv(wrap,(turn===1?'üî¥ Player 1':'üü° Player 2')+' Wins!','','<button class="btn-gold" onclick="window._c4n()">Play Again</button><button class="btn-out" onclick="goHome()">Exit</button>');return;}
    if(board[0].every(v=>v)){ren();mkOv(wrap,"It's a Draw!",'','<button class="btn-gold" onclick="window._c4n()">Play Again</button>');return;}
    turn=turn===1?2:1; document.getElementById('c4T').textContent=turn===1?'üî¥ P1':'üü° P2'; ren();
  }
  function checkWin() {
    const t=turn;
    for(let r=0;r<R;r++)for(let c=0;c<C-3;c++)if(board[r][c]===t&&board[r][c+1]===t&&board[r][c+2]===t&&board[r][c+3]===t)return true;
    for(let r=0;r<R-3;r++)for(let c=0;c<C;c++)if(board[r][c]===t&&board[r+1][c]===t&&board[r+2][c]===t&&board[r+3][c]===t)return true;
    for(let r=0;r<R-3;r++)for(let c=0;c<C-3;c++)if(board[r][c]===t&&board[r+1][c+1]===t&&board[r+2][c+2]===t&&board[r+3][c+3]===t)return true;
    for(let r=3;r<R;r++)for(let c=0;c<C-3;c++)if(board[r][c]===t&&board[r-1][c+1]===t&&board[r-2][c+2]===t&&board[r-3][c+3]===t)return true;
    return false;
  }
  function ren() { const bd=document.getElementById('c4board'); bd.innerHTML=''; for(let r=0;r<R;r++)for(let c=0;c<C;c++){const cell=document.createElement('div');cell.className='c4cell';const rc=c;if(board[r][c]===1)cell.classList.add('c4r');else if(board[r][c]===2)cell.classList.add('c4y');cell.addEventListener('click',()=>{if(board[0][rc])return;drop(rc);});bd.appendChild(cell);} }
  window._c4n = init; init();
  CLEANERS.connect4 = () => { delete window._c4n; };
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TIC-TAC-TOE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BUILDERS.tictac = function(wrap) {
  wrap.style.cssText = 'flex-direction:column;align-items:center';
  wrap.innerHTML = `<div class="hud-row"><div class="hb"><div class="hl">Turn</div><div class="hv" id="ttT">‚ùå X</div></div><div class="hb"><div class="hl">X Wins</div><div class="hv" id="ttX">0</div></div><div class="hb"><div class="hl">O Wins</div><div class="hv" id="ttO">0</div></div><div class="hb"><div class="hl">Draws</div><div class="hv" id="ttD">0</div></div></div>
  <div style="flex:1;display:flex;align-items:center;justify-content:center;padding:12px;position:relative"><div style="display:flex;flex-direction:column;align-items:center;gap:12px"><canvas id="ttCv" width="300" height="300" style="border-radius:16px;border:1px solid #2a2618;cursor:pointer"></canvas><button class="btn-gold" onclick="window._ttn()" style="padding:9px 24px;font-size:13px">New Game</button></div></div>`;
  const cv=document.getElementById('ttCv'), ctx=cv.getContext('2d');
  let board, turn, wx=0, wo=0, wd=0, over;
  function init() { board=Array(9).fill(null); turn='X'; over=false; document.getElementById('ttT').textContent='‚ùå X'; hideOv(wrap); draw(); }
  const LINES=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
  function checkWin(b,p) { return LINES.some(l=>l.every(i=>b[i]===p)); }
  function draw() {
    ctx.fillStyle='#0c0b08'; ctx.fillRect(0,0,300,300);
    ctx.strokeStyle='#2a2618'; ctx.lineWidth=3; ctx.lineCap='round';
    [100,200].forEach(p=>{ctx.beginPath();ctx.moveTo(p,10);ctx.lineTo(p,290);ctx.stroke();ctx.beginPath();ctx.moveTo(10,p);ctx.lineTo(290,p);ctx.stroke();});
    board.forEach((v,i)=>{const cx=50+(i%3)*100,cy=50+Math.floor(i/3)*100;if(v==='X'){ctx.strokeStyle='#e84040';ctx.lineWidth=5;ctx.beginPath();ctx.moveTo(cx-28,cy-28);ctx.lineTo(cx+28,cy+28);ctx.stroke();ctx.beginPath();ctx.moveTo(cx+28,cy-28);ctx.lineTo(cx-28,cy+28);ctx.stroke();}else if(v==='O'){ctx.strokeStyle='#e8c46a';ctx.lineWidth=5;ctx.beginPath();ctx.arc(cx,cy,30,0,Math.PI*2);ctx.stroke();}});
  }
  cv.addEventListener('click', e => {
    if(over)return;
    const r=cv.getBoundingClientRect(); const x=Math.floor((e.clientX-r.left)/100); const y=Math.floor((e.clientY-r.top)/100); const i=y*3+x;
    if(board[i])return; board[i]=turn; SFX.blip(); draw();
    if(checkWin(board,turn)){over=true;SFX.win();if(turn==='X'){wx++;document.getElementById('ttX').textContent=wx;}else{wo++;document.getElementById('ttO').textContent=wo;}mkOv(wrap,(turn==='X'?'‚ùå X':'‚≠ï O')+' Wins!','','<button class="btn-gold" onclick="window._ttn()">Play Again</button><button class="btn-out" onclick="goHome()">Exit</button>');}
    else if(board.every(v=>v)){over=true;SFX.score();wd++;document.getElementById('ttD').textContent=wd;mkOv(wrap,"It's a Draw!",'','<button class="btn-gold" onclick="window._ttn()">Play Again</button>');}
    else{turn=turn==='X'?'O':'X';document.getElementById('ttT').textContent=turn==='X'?'‚ùå X':'‚≠ï O';}
  });
  window._ttn = init; init();
  CLEANERS.tictac = () => { delete window._ttn; };
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BREAKOUT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BUILDERS.breakout = function(wrap) {
  const W=560, H=420;
  wrap.style.cssText = 'flex-direction:column;align-items:center';
  wrap.innerHTML = `<div class="hud-row"><div class="hb"><div class="hl">Score</div><div class="hv" id="bkS">0</div></div><div class="hb"><div class="hl">Lives</div><div class="hv" id="bkLv">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div></div><div class="hb"><div class="hl">Level</div><div class="hv" id="bkLl">1</div></div></div>
  <div style="flex:1;display:flex;align-items:center;justify-content:center;padding:10px;position:relative;width:100%"><canvas id="bkCv" width="${W}" height="${H}" style="border-radius:12px;border:1px solid #2a2618;cursor:none;max-width:100%"></canvas></div>
  <p style="color:var(--mut);font-size:12px;padding-bottom:8px">Mouse/Touch moves paddle ¬∑ Space/Click to launch</p>`;
  const cv=document.getElementById('bkCv'), ctx=cv.getContext('2d');
  const PW=88, PH=11, BR=8, BC=10, BROWS=6;
  const BCOLS=['#e84040','#e87030','#c9a84c','#50c850','#4080e0','#a050e8'];
  let pad, ball, bricks, score, lives, level, raf, state='idle', launched;
  function mkBricks(lv) { bricks=[]; const bw=(W-36)/BC-5,bh=18; for(let r=0;r<BROWS;r++)for(let c=0;c<BC;c++){const ex=lv>1&&Math.random()<.2?1:0;bricks.push({x:18+c*(bw+5),y:42+r*(bh+5),w:bw,h:bh,hp:1+ex,c:BCOLS[r%BCOLS.length]});} }
  function init() { pad={x:W/2-PW/2,y:H-28}; ball={x:W/2,y:H-48,vx:3,vy:-4}; score=0; lives=3; level=1; launched=false; mkBricks(1); document.getElementById('bkS').textContent='0'; document.getElementById('bkLv').textContent='‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è'; document.getElementById('bkLl').textContent='1'; hideOv(wrap); }
  function update() {
    if(!launched){ball.x=pad.x+PW/2;return;}
    ball.x+=ball.vx; ball.y+=ball.vy;
    if(ball.x-BR<0){ball.x=BR;ball.vx=Math.abs(ball.vx);} if(ball.x+BR>W){ball.x=W-BR;ball.vx=-Math.abs(ball.vx);}
    if(ball.y-BR<0){ball.y=BR;ball.vy=Math.abs(ball.vy);}
    if(ball.y+BR>pad.y&&ball.y+BR<pad.y+PH+ball.vy&&ball.x>pad.x-BR&&ball.x<pad.x+PW+BR){ball.vy=-Math.abs(ball.vy);ball.vx=((ball.x-(pad.x+PW/2))/(PW/2))*5;SFX.bounce();}
    if(ball.y+BR>H){lives--;SFX.hit();document.getElementById('bkLv').textContent='‚ù§Ô∏è'.repeat(lives)||'üíÄ';if(lives<=0){state='gameover';SFX.lose();mkOv(wrap,'GAME OVER','Score: '+score,'<button class="btn-gold" onclick="window._bkN()">Play Again</button><button class="btn-out" onclick="goHome()">Exit</button>');return;}ball={x:W/2,y:H-48,vx:3,vy:-4};launched=false;}
    bricks.forEach(b=>{if(b.dead)return;if(ball.x+BR>b.x&&ball.x-BR<b.x+b.w&&ball.y+BR>b.y&&ball.y-BR<b.y+b.h){b.hp--;if(b.hp<=0){b.dead=true;SFX.explode();}else{SFX.hit();}const fT=Math.abs((ball.y+BR)-b.y),fB=Math.abs((ball.y-BR)-(b.y+b.h)),fL=Math.abs((ball.x+BR)-b.x),fR=Math.abs((ball.x-BR)-(b.x+b.w));if(Math.min(fT,fB)<Math.min(fL,fR))ball.vy*=-1;else ball.vx*=-1;score+=10*level;document.getElementById('bkS').textContent=score;}});
    bricks=bricks.filter(b=>!b.dead);
    if(!bricks.length){level++;document.getElementById('bkLl').textContent=level;mkBricks(level);ball={x:W/2,y:H-48,vx:3+level*.4,vy:-(4+level*.4)};launched=false;}
  }
  function render() {
    ctx.fillStyle='#0c0b08'; ctx.fillRect(0,0,W,H);
    bricks.forEach(b=>{ctx.fillStyle=b.hp>1?'#fff8e0':b.c;ctx.beginPath();ctx.roundRect(b.x,b.y,b.w,b.h,3);ctx.fill();ctx.fillStyle='rgba(255,255,255,.18)';ctx.fillRect(b.x+2,b.y+2,b.w-4,3);});
    ctx.fillStyle='#c9a84c'; ctx.beginPath(); ctx.roundRect(pad.x,pad.y,PW,PH,6); ctx.fill();
    ctx.fillStyle='#e8c46a'; ctx.shadowColor='#c9a84c'; ctx.shadowBlur=10; ctx.beginPath(); ctx.arc(ball.x,ball.y,BR,0,Math.PI*2); ctx.fill(); ctx.shadowBlur=0;
    if(!launched&&state==='running'){ctx.textAlign='center';ctx.font='700 12px DM Sans,sans-serif';ctx.fillStyle='#857d5f';ctx.fillText('Click / Space to launch',W/2,H-46);}
    if(state==='idle')cvBanner(ctx,W,H,'BREAKOUT','Smash all the bricks!','Click or Space to Start');
    else if(state==='paused')cvBanner(ctx,W,H,'PAUSED','','P to Resume');
    raf=requestAnimationFrame(render); if(state==='running')update();
  }
  init(); // pre-init so render() has valid bricks/pad/ball on first frame
  raf=requestAnimationFrame(render);
  cv.addEventListener('mousemove',e=>{const r=cv.getBoundingClientRect();pad.x=Math.max(0,Math.min(W-PW,(e.clientX-r.left)-PW/2));});
  cv.addEventListener('touchmove',e=>{e.preventDefault();const r=cv.getBoundingClientRect();pad.x=Math.max(0,Math.min(W-PW,(e.touches[0].clientX-r.left)-PW/2));},{passive:false});
  cv.addEventListener('click',()=>{if(state==='idle'){init();state='running';return;}if(state==='running'&&!launched)launched=true;});
  const kH = e => { if(e.key==='p'||e.key==='P'){state=state==='paused'?'running':'paused';return;} if(e.code==='Space'){e.preventDefault();if(state==='idle'){init();state='running';}else if(state==='running'&&!launched)launched=true;} if(state!=='running')return; if(e.key==='ArrowLeft')pad.x=Math.max(0,pad.x-20); if(e.key==='ArrowRight')pad.x=Math.min(W-PW,pad.x+20); };
  window.addEventListener('keydown', kH);
  window._bkN = () => { init(); state='running'; };
  PAUSE_CBS.breakout = p => { state=p?'paused':'running'; };
  CLEANERS.breakout = () => { cancelAnimationFrame(raf); window.removeEventListener('keydown', kH); delete window._bkN; };
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MEMORY MATCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BUILDERS.memory = function(wrap) {
  wrap.style.cssText = 'flex-direction:column;align-items:center';
  wrap.innerHTML = `<div class="hud-row"><div class="hb"><div class="hl">Moves</div><div class="hv" id="mmMv">0</div></div><div class="hb"><div class="hl">Pairs</div><div class="hv" id="mmPr">0/8</div></div><div class="hb"><div class="hl">‚è±</div><div class="hv" id="mmTm">0</div></div></div>
  <div style="flex:1;display:flex;align-items:center;justify-content:center;padding:12px;position:relative"><div style="display:flex;flex-direction:column;align-items:center;gap:12px"><div id="mmGrid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px"></div><button class="btn-gold" onclick="window._mmN()" style="padding:9px 24px;font-size:13px">New Game</button></div></div>`;
  const EM=['üêç','üß±','üî¢','üê¶','ü¶ï','üí£','üèì','üëæ'];
  let cards, flipped, pairs, moves, timer, el, lock;
  function init() { const all=[...EM,...EM].sort(()=>Math.random()-.5); cards=all.map((e,i)=>({id:i,e,flipped:false,matched:false})); flipped=[]; pairs=0; moves=0; el=0; lock=false; clearInterval(timer); document.getElementById('mmMv').textContent='0'; document.getElementById('mmPr').textContent='0/8'; document.getElementById('mmTm').textContent='0'; hideOv(wrap); ren(); timer=setInterval(()=>{el++;document.getElementById('mmTm').textContent=el;},1000); }
  function flip(i) {
    if(lock||cards[i].flipped||cards[i].matched)return;
    cards[i].flipped=true; flipped.push(i); SFX.card(); ren();
    if(flipped.length===2){moves++;document.getElementById('mmMv').textContent=moves;lock=true;setTimeout(()=>{if(cards[flipped[0]].e===cards[flipped[1]].e){cards[flipped[0]].matched=cards[flipped[1]].matched=true;pairs++;SFX.match();document.getElementById('mmPr').textContent=pairs+'/8';if(pairs===8){clearInterval(timer);SFX.win();mkOv(wrap,'You Won! üéâ','Moves: '+moves+' ¬∑ Time: '+el+'s','<button class="btn-gold" onclick="window._mmN()">Play Again</button><button class="btn-out" onclick="goHome()">Exit</button>');}}else{cards[flipped[0]].flipped=cards[flipped[1]].flipped=false;SFX.denied();}flipped=[];lock=false;ren();},900);}
  }
  function ren() {
    const g=document.getElementById('mmGrid'); g.innerHTML='';
    cards.forEach((c,i)=>{const d=document.createElement('div');d.style.cssText=`width:72px;height:72px;border-radius:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;border:2px solid;transition:all .2s;user-select:none;`;if(c.matched){d.style.background='rgba(80,200,80,.12)';d.style.borderColor='#50c850';d.style.fontSize='30px';d.textContent=c.e;}else if(c.flipped){d.style.background='var(--surf2)';d.style.borderColor='var(--gold)';d.style.fontSize='30px';d.textContent=c.e;}else{d.style.background='var(--surf)';d.style.borderColor='var(--bord2)';d.style.color='var(--mut2)';d.style.fontFamily='Syne,sans-serif';d.style.fontWeight='700';d.style.fontSize='22px';d.textContent='?';}d.addEventListener('click',()=>flip(i));g.appendChild(d);});
  }
  window._mmN = () => { clearInterval(timer); init(); };
  init();
  CLEANERS.memory = () => { clearInterval(timer); delete window._mmN; };
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WORDLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BUILDERS.wordle = function(wrap) {
  wrap.style.cssText = 'flex-direction:column;align-items:center';
  wrap.innerHTML = `<div style="flex:1;display:flex;align-items:center;justify-content:center;padding:12px;position:relative"><div style="display:flex;flex-direction:column;align-items:center;gap:12px;max-width:320px;width:100%"><div style="font-family:var(--font-head);font-size:11px;font-weight:700;letter-spacing:2px;color:var(--mut);text-transform:uppercase">Guess the 5-Letter Word</div><div id="wgrid"></div><div id="wmsg" style="font-family:var(--font-head);font-size:14px;font-weight:700;color:var(--gold);min-height:20px;text-align:center"></div><div class="wkb" id="wkb"></div><button class="btn-gold" onclick="window._wN()" style="padding:8px 22px;font-size:12px">New Word</button></div></div>`;
  const WS=['CRANE','BLAZE','GHOST','FLAME','STORM','GRIND','CHEST','BRINE','FLINT','PLUMB','CRISP','DRAFT','GLOOM','STARK','BRAND','CLEFT','DWELT','FROZE','GRIPE','SLANT','TROVE','EXPEL','FLUNG','BLOAT','CLAMP','DROWN','FETCH','GLARE','KNACK','BRAVE','CLING','DWARF','EPOCH','FRAIL','GROAN','SHRUG','CREST','BLUNT','DRAPE','GLEAM','STOCK','PHONE','BRAVE','CROWN','PLANT','STORK','GRAZE'];
  const EXTRA=['CRANE','SPATE','STARE','AUDIO','RAISE','ARISE','IRATE','STALE','SLATE','FLEAS','LEAST'];
  let word, guesses, cur, over;
  function init() { word=WS[Math.floor(Math.random()*WS.length)]; guesses=[]; cur=''; over=false; document.getElementById('wmsg').textContent=''; renGrid(); renKB(); }
  function score2(w,g) { const res=Array(5).fill('absent'); const wa=[...w]; const used=Array(5).fill(false); for(let i=0;i<5;i++){if(g[i]===w[i]){res[i]='correct';used[i]=true;}} for(let i=0;i<5;i++){if(res[i]==='correct')continue;const idx=wa.findIndex((c,j)=>!used[j]&&c===g[i]);if(idx!==-1){res[i]='present';used[idx]=true;}} return res; }
  function getKB() { const st={}; guesses.forEach(g=>{const res=score2(word,g);g.split('').forEach((c,i)=>{if(res[i]==='correct')st[c]='wc';else if(res[i]==='present'&&st[c]!=='wc')st[c]='wp';else if(!st[c])st[c]='wa';});}); return st; }
  function renGrid() { const g=document.getElementById('wgrid'); g.innerHTML=''; for(let r=0;r<6;r++){const row=document.createElement('div');row.className='wrow';const gs=guesses[r]||'';for(let c=0;c<5;c++){const l=document.createElement('div');l.className='wletter';if(r===guesses.length&&!over)l.classList.add('cur');const ch=r<guesses.length?gs[c]:(r===guesses.length?cur[c]||'':'');if(ch)l.textContent=ch;if(r<guesses.length){const res=score2(word,gs);l.classList.add(res[c]);}row.appendChild(l);}g.appendChild(row);} }
  function renKB() { const kb=document.getElementById('wkb'); kb.innerHTML=''; const rows=[['Q','W','E','R','T','Y','U','I','O','P'],['A','S','D','F','G','H','J','K','L'],['ENTER','Z','X','C','V','B','N','M','‚å´']]; const st=getKB(); rows.forEach(row=>{const d=document.createElement('div');d.className='wkrow';row.forEach(k=>{const b=document.createElement('div');b.className='wk';if(k==='ENTER'||k==='‚å´')b.classList.add('wide');b.textContent=k;if(st[k])b.classList.add(st[k]);b.addEventListener('click',()=>kbP(k));d.appendChild(b);});kb.appendChild(d);}); }
  function kbP(k) {
    if(over)return;
    if(k==='‚å´')cur=cur.slice(0,-1);
    else if(k==='ENTER'){if(cur.length<5){document.getElementById('wmsg').textContent='Need 5 letters!';setTimeout(()=>document.getElementById('wmsg').textContent='',1200);return;}if(!WS.includes(cur)&&!EXTRA.includes(cur)){SFX.denied();document.getElementById('wmsg').textContent='Not in word list';setTimeout(()=>document.getElementById('wmsg').textContent='',1200);return;}guesses.push(cur);cur='';if(guesses[guesses.length-1]===word){over=true;SFX.win();document.getElementById('wmsg').textContent='üéâ '+word+' ‚Äî Brilliant!';}else if(guesses.length===6){over=true;SFX.lose();document.getElementById('wmsg').textContent='The word was: '+word;}}
    else if(cur.length<5){cur+=k;SFX.flip();}
    renGrid(); renKB();
  }
  const kH = e => { if(over)return; if(e.key==='Backspace')kbP('‚å´'); else if(e.key==='Enter')kbP('ENTER'); else if(/^[a-zA-Z]$/.test(e.key))kbP(e.key.toUpperCase()); };
  window.addEventListener('keydown', kH);
  window._wN = init; init();
  CLEANERS.wordle = () => { window.removeEventListener('keydown', kH); delete window._wN; };
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TYPING SPEED
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BUILDERS.typing = function(wrap) {
  wrap.style.cssText = 'flex-direction:column;align-items:center';
  wrap.innerHTML = `<div class="hud-row"><div class="hb"><div class="hl">WPM</div><div class="hv" id="tyW">0</div></div><div class="hb"><div class="hl">Accuracy</div><div class="hv" id="tyA">100%</div></div><div class="hb"><div class="hl">Time</div><div class="hv" id="tyT">60</div></div><div class="hb"><div class="hl">Words</div><div class="hv" id="tyWd">0</div></div></div>
  <div style="flex:1;display:flex;align-items:center;justify-content:center;padding:12px;position:relative;width:100%"><div style="max-width:600px;width:100%;display:flex;flex-direction:column;gap:12px">
  <div class="ty-text-wrap" id="tyTxt"></div>
  <input id="tyInp" placeholder="Click here and start typing..." autocomplete="off" autocorrect="off" spellcheck="false" style="width:100%;padding:13px 20px;background:var(--surf);border:1px solid var(--bord2);border-radius:12px;font-size:15px;font-family:inherit;outline:none;color:var(--txt);" onfocus="this.style.borderColor='var(--gold4)'" onblur="this.style.borderColor='var(--bord2)'"/>
  <div style="display:flex;gap:10px;justify-content:center"><button class="btn-gold" onclick="window._tyN(30)" style="padding:8px 18px;font-size:12px">30s</button><button class="btn-gold" onclick="window._tyN(60)" style="padding:8px 18px;font-size:12px">60s</button><button class="btn-gold" onclick="window._tyN(120)" style="padding:8px 18px;font-size:12px">120s</button></div></div></div>`;
  const WDS=['the','be','to','of','and','a','in','that','have','it','for','not','on','with','he','as','you','do','at','this','but','his','by','from','they','we','say','her','she','or','an','will','my','one','all','would','there','their','what','so','up','out','if','about','who','get','which','go','me','when','make','can','like','time','no','just','him','know','take','people','into','year','your','good','some','could','them','see','other','than','then','now','look','only','come','its','over','think','also','back','after','use','two','how','our','work','first','well','way','even','new','want','because','any','these','give','day','most','us'];
  let text, cur, correct, errors, start, timer, el, total, done;
  function newGame(t=60) { total=t; el=0; done=false; cur=0; correct=0; errors=0; start=null; clearInterval(timer); text=[...WDS].sort(()=>Math.random()-.5).slice(0,60); document.getElementById('tyW').textContent='0'; document.getElementById('tyA').textContent='100%'; document.getElementById('tyT').textContent=t; document.getElementById('tyWd').textContent='0'; document.getElementById('tyInp').value=''; document.getElementById('tyInp').disabled=false; document.getElementById('tyInp').focus(); hideOv(wrap); renTy(); }
  function renTy() { const d=document.getElementById('tyTxt'); d.innerHTML=''; text.forEach((w,i)=>{const sp=document.createElement('span');sp.textContent=w+' ';if(i<cur)sp.style.color='#50c850';else if(i===cur)sp.style.color='#e8c46a';d.appendChild(sp);}); }
  document.getElementById('tyInp').addEventListener('input', e => {
    if(done)return;
    if(!start){start=Date.now();timer=setInterval(()=>{el++;const rem=total-el;document.getElementById('tyT').textContent=rem;if(rem<=0)finish();},1000);}
    const val=e.target.value;
    if(val.endsWith(' ')){const typed=val.trim();if(typed===text[cur])correct++;else errors++;cur++;e.target.value='';if(cur>=text.length){finish();return;}renTy();document.getElementById('tyWd').textContent=cur;document.getElementById('tyW').textContent=Math.round((correct/Math.max(el,1))*60)||0;document.getElementById('tyA').textContent=(cur>0?Math.round(correct/cur*100):100)+'%';}
  });
  function finish() { clearInterval(timer); done=true; document.getElementById('tyInp').disabled=true; const wpm=Math.round(correct/total*60); const acc=cur>0?Math.round(correct/cur*100):0; mkOv(wrap,'‚å®Ô∏è Time\'s Up!','WPM: '+wpm+' ¬∑ Accuracy: '+acc+'% ¬∑ Words: '+correct,'<button class="btn-gold" onclick="window._tyN(60)">Play Again</button><button class="btn-out" onclick="goHome()">Exit</button>'); }
  window._tyN = newGame; newGame(60);
  CLEANERS.typing = () => { clearInterval(timer); delete window._tyN; };
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHECKERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BUILDERS.checkers = function(wrap) {
  wrap.style.cssText = 'flex-direction:column;align-items:center';
  wrap.innerHTML = `<div class="hud-row"><div class="hb"><div class="hl">Turn</div><div class="hv" id="ckT">üî¥ P1</div></div><div class="hb"><div class="hl">üî¥ Pieces</div><div class="hv" id="ck1">12</div></div><div class="hb"><div class="hl">‚ö´ Pieces</div><div class="hv" id="ck2">12</div></div></div>
  <div style="flex:1;display:flex;align-items:center;justify-content:center;padding:12px;position:relative"><div style="display:flex;flex-direction:column;align-items:center;gap:10px"><canvas id="ckCv" width="360" height="360" style="border-radius:12px;border:1px solid #2a2618;cursor:pointer"></canvas><button class="btn-gold" onclick="window._ckN()" style="padding:9px 24px;font-size:13px">New Game</button></div></div>
  <p style="color:var(--mut);font-size:12px;padding-bottom:8px">üî¥ P1 vs ‚ö´ P2 ¬∑ Click to select & move</p>`;
  const cv=document.getElementById('ckCv'), ctx=cv.getContext('2d');
  const SZ=45, N=8;
  let board, turn, sel, over;
  function init() { board=Array.from({length:N},()=>Array(N).fill(0)); for(let r=0;r<3;r++)for(let c=0;c<N;c++){if((r+c)%2===1)board[r][c]=2;} for(let r=5;r<8;r++)for(let c=0;c<N;c++){if((r+c)%2===1)board[r][c]=1;} turn=1; sel=null; over=false; hideOv(wrap); draw(); }
  function draw() {
    ctx.clearRect(0,0,360,360);
    for(let r=0;r<N;r++)for(let c=0;c<N;c++){ctx.fillStyle=(r+c)%2===0?'#1a1810':'#2e2a18';ctx.fillRect(c*SZ,r*SZ,SZ,SZ);}
    if(sel){const moves=getMoves(sel.r,sel.c);moves.forEach(m=>{ctx.fillStyle='rgba(201,168,76,.3)';ctx.beginPath();ctx.arc(m.c*SZ+SZ/2,m.r*SZ+SZ/2,SZ/2-4,0,Math.PI*2);ctx.fill();});}
    for(let r=0;r<N;r++)for(let c=0;c<N;c++){const v=board[r][c];if(!v)continue;const x=c*SZ+SZ/2,y=r*SZ+SZ/2;const isSel=sel&&sel.r===r&&sel.c===c;ctx.fillStyle=isSel?'#e8c46a':v===1||v===3?'#c83030':v===2||v===4?'#606060':'#000';ctx.shadowColor=isSel?'#e8c46a':v===1?'#e84040':'#888';ctx.shadowBlur=isSel?16:4;ctx.beginPath();ctx.arc(x,y,SZ/2-5,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;if(v===3||v===4){ctx.fillStyle='rgba(255,255,255,.4)';ctx.font='700 16px Syne,sans-serif';ctx.textAlign='center';ctx.fillText('‚ôî',x,y+6);}}
  }
  function getMoves(r,c) { const v=board[r][c];if(!v)return[];const dirs=[];if(v===1||v===3)dirs.push([-1,-1],[-1,1]);if(v===2||v===4)dirs.push([1,-1],[1,1]);if(v===3||v===4){dirs.length=0;dirs.push([-1,-1],[-1,1],[1,-1],[1,1]);}const moves=[];dirs.forEach(([dr,dc])=>{const nr=r+dr,nc=c+dc;if(nr>=0&&nr<N&&nc>=0&&nc<N&&!board[nr][nc])moves.push({r:nr,c:nc,jump:false});else if(nr>=0&&nr<N&&nc>=0&&nc<N&&board[nr][nc]&&Math.floor((board[nr][nc]-1)/2)!==Math.floor((v-1)/2)){const jr=r+dr*2,jc=c+dc*2;if(jr>=0&&jr<N&&jc>=0&&jc<N&&!board[jr][jc])moves.push({r:jr,c:jc,jump:true,cr:nr,cc:nc});}});return moves; }
  function click(r,c) {
    if(over)return;
    if(board[r][c]&&((board[r][c]===1||board[r][c]===3)&&turn===1||(board[r][c]===2||board[r][c]===4)&&turn===2)){sel={r,c};draw();return;}
    if(sel){const moves=getMoves(sel.r,sel.c);const mv=moves.find(m=>m.r===r&&m.c===c);if(mv){board[r][c]=board[sel.r][sel.c];board[sel.r][sel.c]=0;SFX.blip();if(mv.jump){board[mv.cr][mv.cc]=0;SFX.explode();}if(turn===1&&r===0)board[r][c]=3;if(turn===2&&r===7)board[r][c]=4;const r1=board.flat().filter(v=>v===1||v===3).length;const r2=board.flat().filter(v=>v===2||v===4).length;document.getElementById('ck1').textContent=r1;document.getElementById('ck2').textContent=r2;if(!r1||!r2){over=true;SFX.win();mkOv(wrap,(r2===0?'üî¥ Player 1':'‚ö´ Player 2')+' Wins!','','<button class="btn-gold" onclick="window._ckN()">Play Again</button><button class="btn-out" onclick="goHome()">Exit</button>');}turn=turn===1?2:1;document.getElementById('ckT').textContent=turn===1?'üî¥ P1':'‚ö´ P2';}sel=null;}draw();
  }
  cv.addEventListener('click', e => { const r=cv.getBoundingClientRect();const c=Math.floor((e.clientX-r.left)/SZ),row=Math.floor((e.clientY-r.top)/SZ);click(row,c); });
  window._ckN = init; init();
  CLEANERS.checkers = () => { delete window._ckN; };
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PAC-MAN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BUILDERS.pacman = function(wrap) {
  const CELL=24, MC=19, MR=17, W=MC*CELL, H=MR*CELL;
  wrap.style.cssText = 'flex-direction:column;align-items:center';
  wrap.innerHTML = `<div class="hud-row"><div class="hb"><div class="hl">Score</div><div class="hv" id="pmS">0</div></div><div class="hb"><div class="hl">Lives</div><div class="hv" id="pmLv">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div></div><div class="hb"><div class="hl">Level</div><div class="hv" id="pmLl">1</div></div></div>
  <div style="flex:1;display:flex;align-items:center;justify-content:center;padding:10px;position:relative;width:100%"><canvas id="pmCv" width="${W}" height="${H}" style="border-radius:12px;border:1px solid #2a2618;max-width:100%"></canvas></div>
  <p style="color:var(--mut);font-size:12px;padding-bottom:8px">Arrow Keys / WASD ¬∑ Space=Start ¬∑ P=Pause</p>`;
  const cv=document.getElementById('pmCv'), ctx=cv.getContext('2d');
  const MT=[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,2,2,2,2,2,2,2,2,1,2,2,2,2,2,2,2,2,1],[1,3,1,1,2,1,1,1,2,1,2,1,1,1,2,1,1,3,1],[1,2,1,1,2,1,1,1,2,1,2,1,1,1,2,1,1,2,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,2,1,1,2,1,2,1,1,1,1,1,2,1,2,1,1,2,1],[1,2,2,2,2,1,2,2,2,1,2,2,2,1,2,2,2,2,1],[1,1,1,1,2,1,1,0,0,0,0,0,1,1,2,1,1,1,1],[1,1,1,1,2,1,0,0,0,0,0,0,0,1,2,1,1,1,1],[0,0,0,0,2,0,0,0,0,0,0,0,0,0,2,0,0,0,0],[1,1,1,1,2,1,0,0,0,0,0,0,0,1,2,1,1,1,1],[1,1,1,1,2,1,0,1,1,1,1,1,0,1,2,1,1,1,1],[1,2,2,2,2,2,2,2,2,1,2,2,2,2,2,2,2,2,1],[1,2,1,1,2,1,1,1,2,1,2,1,1,1,2,1,1,2,1],[1,3,2,1,2,2,2,2,2,0,2,2,2,2,2,1,2,3,1],[1,1,2,1,2,1,2,1,1,1,1,1,2,1,2,1,2,1,1],[1,2,2,2,2,1,2,2,2,1,2,2,2,1,2,2,2,2,1]];
  let map, pac, ghosts, score, lives, level, dir, ndir, powered, pTimer, raf, state='idle', dots, fr=0;
  const GC=['#ff4040','#ffb8ff','#00d4d4','#ffb852'];
  function initMap() { map=MT.map(r=>[...r]); dots=0; map.forEach(r=>r.forEach(v=>{if(v===2||v===3)dots++;})); }
  function canGo(x,y) { const rx=Math.round(x), ry=Math.round(y); if(ry<0||ry>=MR||rx<0||rx>=MC)return true; return map[ry][rx]!==1; }
  function init() { initMap(); pac={x:9,y:14,mo:0,md:1}; dir={x:1,y:0}; ndir={x:1,y:0}; score=0; lives=3; level=1; powered=false; pTimer=0; upHUD(); ghosts=[{x:8,y:9,vx:1,vy:0,c:GC[0],sc:false},{x:10,y:9,vx:-1,vy:0,c:GC[1],sc:false},{x:9,y:8,vx:0,vy:1,c:GC[2],sc:false},{x:9,y:10,vx:0,vy:-1,c:GC[3],sc:false}]; }
  function upHUD() { document.getElementById('pmS').textContent=score; document.getElementById('pmLv').textContent='‚ù§Ô∏è'.repeat(lives)||'üíÄ'; document.getElementById('pmLl').textContent=level; }
  function update() {
    fr++;
    pac.mo+=pac.md*.13; if(pac.mo>.37||pac.mo<0)pac.md*=-1;
    const nx=Math.round(pac.x)+ndir.x, ny=Math.round(pac.y)+ndir.y;
    if(canGo(nx,ny))dir={...ndir};
    const mx=pac.x+dir.x*.13, my=pac.y+dir.y*.13;
    if(canGo(Math.round(mx),Math.round(my))){pac.x=((mx+MC)%MC);pac.y=((my+MR)%MR);}
    const gx=Math.round(pac.x), gy=Math.round(pac.y);
    if(gy>=0&&gy<MR&&gx>=0&&gx<MC){if(map[gy][gx]===2){map[gy][gx]=0;score+=10;dots--;SFX.pellet();upHUD();}if(map[gy][gx]===3){map[gy][gx]=0;score+=50;dots--;powered=true;pTimer=300;ghosts.forEach(g=>g.sc=true);SFX.powerup();upHUD();}}
    if(dots<=0){level++;initMap();upHUD();return;}
    if(powered){pTimer--;if(pTimer<=0){powered=false;ghosts.forEach(g=>g.sc=false);}}
    if(fr%5===0){ghosts.forEach(g=>{const opts=[];[[1,0],[-1,0],[0,1],[0,-1]].forEach(([dx,dy])=>{if(canGo(Math.round(g.x)+dx,Math.round(g.y)+dy)&&!(dx===-g.vx&&dy===-g.vy))opts.push({dx,dy});});if(opts.length){if(!g.sc){opts.sort((a,b)=>Math.hypot(g.x+a.dx-pac.x,g.y+a.dy-pac.y)-Math.hypot(g.x+b.dx-pac.x,g.y+b.dy-pac.y));const pk=Math.random()<.7?opts[0]:opts[Math.floor(Math.random()*opts.length)];g.vx=pk.dx;g.vy=pk.dy;}else{const pk=opts[Math.floor(Math.random()*opts.length)];g.vx=pk.dx;g.vy=pk.dy;}}g.x=((g.x+g.vx*.11)+MC)%MC;g.y=((g.y+g.vy*.11)+MR)%MR;if(Math.hypot(g.x-pac.x,g.y-pac.y)<.85){if(g.sc){g.sc=false;score+=200;SFX.ghost();upHUD();g.x=9;g.y=9;}else{lives--;SFX.hit();upHUD();if(lives<=0){state='gameover';SFX.lose();return;}pac={x:9,y:14,mo:0,md:1};dir={x:1,y:0};ndir={x:1,y:0};ghosts=[{x:8,y:9,vx:1,vy:0,c:GC[0],sc:false},{x:10,y:9,vx:-1,vy:0,c:GC[1],sc:false},{x:9,y:8,vx:0,vy:1,c:GC[2],sc:false},{x:9,y:10,vx:0,vy:-1,c:GC[3],sc:false}];}}})}
  }
  function drawPac() { const px=pac.x*CELL+CELL/2,py=pac.y*CELL+CELL/2,r=CELL/2-2;const a=dir.x===1?0:dir.x===-1?Math.PI:dir.y===1?Math.PI/2:Math.PI*1.5;ctx.fillStyle='#e8c46a';ctx.beginPath();ctx.moveTo(px,py);ctx.arc(px,py,r,a+pac.mo,a+Math.PI*2-pac.mo);ctx.closePath();ctx.fill(); }
  function drawGhost(g) { const px=g.x*CELL+CELL/2,py=g.y*CELL+CELL/2,r=CELL/2-2;const sc=g.sc&&pTimer>30;ctx.fillStyle=sc?(pTimer<80&&fr%10<5?'#8080e0':'#2040d0'):g.c;ctx.beginPath();ctx.arc(px,py-r*.1,r,Math.PI,0,false);ctx.lineTo(px+r,py+r);for(let i=0;i<3;i++)ctx.quadraticCurveTo(px+r-(i+.5)*(2*r/3),py+r+4,px+r-(i+1)*(2*r/3),py+r);ctx.lineTo(px-r,py+r);ctx.closePath();ctx.fill();if(!sc){ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(px-3,py-2,3.5,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(px+3,py-2,3.5,0,Math.PI*2);ctx.fill();ctx.fillStyle='#00f';ctx.beginPath();ctx.arc(px-2,py-2,1.8,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(px+4,py-2,1.8,0,Math.PI*2);ctx.fill();} }
  function render() {
    ctx.fillStyle='#0c0b08'; ctx.fillRect(0,0,W,H);
    for(let y=0;y<MR;y++)for(let x=0;x<MC;x++){const v=map[y][x];if(v===1){ctx.fillStyle='#1a3a8a';ctx.beginPath();ctx.roundRect(x*CELL+1,y*CELL+1,CELL-2,CELL-2,3);ctx.fill();ctx.strokeStyle='#2050c0';ctx.lineWidth=1;ctx.beginPath();ctx.roundRect(x*CELL+2,y*CELL+2,CELL-4,CELL-4,2);ctx.stroke();}else if(v===2){ctx.fillStyle='#c9a84c';ctx.beginPath();ctx.arc(x*CELL+CELL/2,y*CELL+CELL/2,2.5,0,Math.PI*2);ctx.fill();}else if(v===3){const p=.8+Math.sin(fr*.1)*.2;ctx.fillStyle='#e8c46a';ctx.beginPath();ctx.arc(x*CELL+CELL/2,y*CELL+CELL/2,6*p,0,Math.PI*2);ctx.fill();}}
    if(state!=='idle')drawPac();
    ghosts.forEach(drawGhost);
    if(state==='idle')cvBanner(ctx,W,H,'PAC-MAN','Eat dots ‚Äî dodge ghosts!','SPACE to Start');
    else if(state==='paused')cvBanner(ctx,W,H,'PAUSED','','SPACE / P to Resume');
    else if(state==='gameover')cvBanner(ctx,W,H,'GAME OVER','Score: '+score,'SPACE to Retry');
    raf=requestAnimationFrame(render); if(state==='running')update();
  }
  init(); state='idle'; // pre-initialize so render() has valid map/ghosts on first frame
  raf=requestAnimationFrame(render);
  const kH = e => {
    if(e.key==='p'||e.key==='P'){state=state==='paused'?'running':'paused';return;}
    if(e.code==='Space'){if(state==='idle'||state==='gameover'){init();state='running';}else if(state==='running')state='paused';else if(state==='paused')state='running';return;}
    if(state!=='running')return;
    const dm={ArrowLeft:{x:-1,y:0},ArrowRight:{x:1,y:0},ArrowUp:{x:0,y:-1},ArrowDown:{x:0,y:1},a:{x:-1,y:0},d:{x:1,y:0},w:{x:0,y:-1},s:{x:0,y:1}};
    if(dm[e.key]){e.preventDefault();ndir=dm[e.key];}
  };
  window.addEventListener('keydown', kH);
  let tx2=0, ty2=0;
  cv.addEventListener('touchstart',e=>{tx2=e.touches[0].clientX;ty2=e.touches[0].clientY;},{passive:true});
  cv.addEventListener('touchend',e=>{if(state==='idle'||state==='gameover'){init();state='running';return;}const dx=e.changedTouches[0].clientX-tx2,dy=e.changedTouches[0].clientY-ty2;if(Math.abs(dx)>Math.abs(dy))ndir=dx>0?{x:1,y:0}:{x:-1,y:0};else ndir=dy>0?{x:0,y:1}:{x:0,y:-1};});
  PAUSE_CBS.pacman = p => { state=p?'paused':'running'; };
  CLEANERS.pacman = () => { cancelAnimationFrame(raf); window.removeEventListener('keydown', kH); };
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BLACKJACK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BUILDERS.blackjack = function(wrap) {
  wrap.style.cssText = 'flex-direction:column;align-items:center;justify-content:center';
  wrap.innerHTML = `<div class="hud-row"><div class="hb"><div class="hl">üí∞ Chips</div><div class="hv" id="bjChips">200</div></div><div class="hb"><div class="hl">Bet</div><div class="hv" id="bjBet">25</div></div><div class="hb"><div class="hl">Round</div><div class="hv" id="bjRound">1</div></div></div>
  <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;gap:16px;width:100%;max-width:520px">
    <div style="width:100%">
      <div style="font-size:11px;color:var(--mut);font-weight:700;text-transform:uppercase;letter-spacing:.8px;margin-bottom:8px">Dealer <span id="bjDVal" style="color:var(--gold)"></span></div>
      <div id="bjDHand" style="display:flex;gap:8px;flex-wrap:wrap;min-height:80px;align-items:center"></div>
    </div>
    <div id="bjMsg" style="font-family:var(--font-head);font-size:20px;font-weight:800;color:var(--gold2);min-height:28px;text-align:center"></div>
    <div style="width:100%">
      <div style="font-size:11px;color:var(--mut);font-weight:700;text-transform:uppercase;letter-spacing:.8px;margin-bottom:8px">Your Hand <span id="bjPVal" style="color:var(--gold)"></span></div>
      <div id="bjPHand" style="display:flex;gap:8px;flex-wrap:wrap;min-height:80px;align-items:center"></div>
    </div>
    <div id="bjActions" style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center"></div>
  </div>`;

  const SUITS = ['‚ô†','‚ô•','‚ô¶','‚ô£'], VALS = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
  let deck, pHand, dHand, chips, bet, round, phase;
  chips = 200; bet = 25; round = 0;

  function freshDeck() {
    const d = [];
    SUITS.forEach(s => VALS.forEach(v => d.push({s, v})));
    for (let i = d.length-1; i > 0; i--) { const j = Math.floor(Math.random()*(i+1)); [d[i],d[j]]=[d[j],d[i]]; }
    return d;
  }
  function val(c) { if (c.v==='A') return 11; if (['K','Q','J'].includes(c.v)) return 10; return parseInt(c.v); }
  function handVal(h) {
    let v = h.reduce((s,c)=>s+val(c),0), aces = h.filter(c=>c.v==='A').length;
    while (v > 21 && aces--) v -= 10;
    return v;
  }
  function cardHTML(c, hidden=false) {
    const red = c.s==='‚ô•'||c.s==='‚ô¶';
    if (hidden) return `<div style="width:52px;height:76px;border-radius:8px;background:var(--surf2);border:2px solid var(--bord2);display:flex;align-items:center;justify-content:center;font-size:24px">üÇ†</div>`;
    return `<div style="width:52px;height:76px;border-radius:8px;background:#fff;border:2px solid #ccc;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;font-size:13px;font-weight:800;color:${red?'#c00':'#111'}"><span>${c.v}</span><span style="font-size:16px">${c.s}</span></div>`;
  }
  function renderHands(hideDealer=true) {
    document.getElementById('bjPHand').innerHTML = pHand.map(c=>cardHTML(c)).join('');
    document.getElementById('bjDHand').innerHTML = dHand.map((c,i)=>cardHTML(c, hideDealer&&i===1)).join('');
    document.getElementById('bjPVal').textContent = handVal(pHand);
    document.getElementById('bjDVal').textContent = hideDealer ? '?' : handVal(dHand);
    document.getElementById('bjChips').textContent = chips;
    document.getElementById('bjBet').textContent = bet;
    document.getElementById('bjRound').textContent = round;
  }
  function setActions(btns) {
    document.getElementById('bjActions').innerHTML = btns.map(([lbl,fn,style])=>
      `<button onclick="${fn}" style="padding:12px 24px;background:${style||'var(--gold)'};color:${style?'#fff':'#0c0b08'};border:none;border-radius:24px;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit">${lbl}</button>`
    ).join('');
  }
  function deal() {
    if (chips <= 0) { document.getElementById('bjMsg').textContent = 'üí∏ Out of chips!'; setActions([['New Game','window._bjReset()']]); return; }
    round++; deck = freshDeck(); pHand = [deck.pop(), deck.pop()]; dHand = [deck.pop(), deck.pop()]; phase = 'playing';
    chips -= bet; document.getElementById('bjMsg').textContent = '';
    renderHands(true);
    if (handVal(pHand) === 21) { reveal(); return; }
    setActions([['Hit','window._bjHit()'],['Stand','window._bjStand()'],['Double','window._bjDouble()',bet<=chips?'var(--surf2)':'#666']]);
  }
  function reveal() {
    renderHands(false);
    while (handVal(dHand) < 17) dHand.push(deck.pop());
    renderHands(false);
    const pv = handVal(pHand), dv = handVal(dHand);
    let msg, win = 0;
    if (pv > 21) { msg = 'üí• Bust! You lose.'; }
    else if (dv > 21 || pv > dv) { msg = pv===21&&pHand.length===2?'üÉè BLACKJACK! +'+Math.round(bet*1.5):'üèÜ You win! +'+bet; win = pv===21&&pHand.length===2?bet+Math.round(bet*1.5):bet*2; SFX.win(); }
    else if (pv === dv) { msg = 'ü§ù Push ‚Äî bet returned.'; win = bet; SFX.blip(); }
    else { msg = 'üòû Dealer wins.'; SFX.lose(); }
    chips += win;
    document.getElementById('bjMsg').textContent = msg;
    setActions([['Deal Again','window._bjDeal()'],['Bet +5','window._bjBetUp()',  'var(--surf2)'],['Bet -5','window._bjBetDn()','var(--surf2)']]);
    renderHands(false);
  }
  window._bjHit = () => { pHand.push(deck.pop()); renderHands(true); if (handVal(pHand)>21){reveal();} };
  window._bjStand = () => reveal();
  window._bjDouble = () => { if (bet<=chips){chips-=bet;bet*=2;pHand.push(deck.pop());reveal();} };
  window._bjDeal = deal;
  window._bjBetUp = () => { if(bet+5<=chips+bet){bet=Math.min(bet+5,200);renderHands(true);} };
  window._bjBetDn = () => { bet=Math.max(5,bet-5);renderHands(true); };
  window._bjReset = () => { chips=200;bet=25;round=0;deal(); };
  deal();
  CLEANERS.blackjack = () => { ['_bjHit','_bjStand','_bjDouble','_bjDeal','_bjBetUp','_bjBetDn','_bjReset'].forEach(k=>delete window[k]); };
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HANGMAN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BUILDERS.hangman = function(wrap) {
  wrap.style.cssText = 'flex-direction:column;align-items:center;justify-content:center';
  wrap.innerHTML = `<div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;gap:14px;width:100%;max-width:500px">
    <canvas id="hmCv" width="220" height="200" style="border-radius:10px;border:1px solid var(--bord)"></canvas>
    <div id="hmWord" style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center"></div>
    <div id="hmHint" style="font-size:12px;color:var(--mut);text-align:center"></div>
    <div id="hmMsg" style="font-family:var(--font-head);font-size:18px;font-weight:800;color:var(--gold2);min-height:26px;text-align:center"></div>
    <div id="hmKeys" style="display:flex;flex-wrap:wrap;gap:6px;justify-content:center;max-width:400px"></div>
    <button class="btn-gold" onclick="window._hmN()">New Word</button>
  </div>`;
  const cv = document.getElementById('hmCv'), ctx = cv.getContext('2d');
  const WORDS = [
    ['JAVASCRIPT','programming language'],['PYTHON','programming language'],['CANVAS','HTML element'],
    ['KEYBOARD','input device'],['ALGORITHM','problem-solving steps'],['DATABASE','stores data'],
    ['NETWORK','connected computers'],['BROWSER','surf the web with this'],['COMPILER','turns code to machine code'],
    ['FUNCTION','reusable block of code'],['VARIABLE','stores a value'],['INTERFACE','user interaction layer'],
    ['PROTOCOL','network communication rules'],['FRAMEWORK','development structure'],['DEBUGGING','fixing code errors'],
  ];
  let word, hint, guesses, wrong;

  function init() {
    const [w, h] = WORDS[Math.floor(Math.random()*WORDS.length)];
    word = w; hint = h; guesses = new Set(); wrong = 0;
    document.getElementById('hmMsg').textContent = '';
    document.getElementById('hmHint').textContent = 'Hint: ' + hint;
    renderAll();
  }

  function drawGallows(w) {
    ctx.clearRect(0,0,220,200);
    ctx.strokeStyle = '#8080a0'; ctx.lineWidth = 3; ctx.lineCap = 'round';
    // Base, pole, beam, rope
    ctx.beginPath(); ctx.moveTo(20,188); ctx.lineTo(190,188); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(60,188); ctx.lineTo(60,20); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(60,20); ctx.lineTo(140,20); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(140,20); ctx.lineTo(140,48); ctx.stroke();
    if (w > 0) { ctx.beginPath(); ctx.arc(140,62,14,0,Math.PI*2); ctx.stroke(); }
    if (w > 1) { ctx.beginPath(); ctx.moveTo(140,76); ctx.lineTo(140,130); ctx.stroke(); }
    if (w > 2) { ctx.beginPath(); ctx.moveTo(140,85); ctx.lineTo(112,112); ctx.stroke(); }
    if (w > 3) { ctx.beginPath(); ctx.moveTo(140,85); ctx.lineTo(168,112); ctx.stroke(); }
    if (w > 4) { ctx.beginPath(); ctx.moveTo(140,130); ctx.lineTo(112,158); ctx.stroke(); }
    if (w > 5) { ctx.beginPath(); ctx.moveTo(140,130); ctx.lineTo(168,158); ctx.stroke(); }
    if (w >= 6) {
      ctx.strokeStyle = '#e84040'; ctx.lineWidth = 2.5;
      ctx.beginPath(); ctx.moveTo(132,54); ctx.lineTo(148,70); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(148,54); ctx.lineTo(132,70); ctx.stroke();
    }
  }

  function guess(l) {
    if (guesses.has(l) || wrong >= 6) return;
    guesses.add(l);
    if (!word.includes(l)) { wrong++; SFX.wrong2(); } else { SFX.correct2(); }
    const won = word.split('').every(c => guesses.has(c));
    const lost = wrong >= 6;
    if (won) { document.getElementById('hmMsg').textContent = 'üéâ You got it!'; SFX.win(); }
    else if (lost) { document.getElementById('hmMsg').textContent = 'üíÄ It was: ' + word; SFX.lose(); }
    renderAll();
  }

  function renderAll() {
    drawGallows(wrong);
    // Word display
    const wd = document.getElementById('hmWord'); wd.innerHTML = '';
    word.split('').forEach(c => {
      const d = document.createElement('div');
      d.style.cssText = 'width:26px;height:32px;border-bottom:2px solid var(--gold4);display:flex;align-items:center;justify-content:center;font-family:var(--font-head);font-size:16px;font-weight:700;color:var(--txt)';
      d.textContent = guesses.has(c) ? c : '';
      wd.appendChild(d);
    });
    // Keyboard
    const kb = document.getElementById('hmKeys'); kb.innerHTML = '';
    'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').forEach(l => {
      const b = document.createElement('div');
      const correct = word.includes(l) && guesses.has(l);
      const miss = !word.includes(l) && guesses.has(l);
      b.style.cssText = `width:32px;height:34px;border-radius:7px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:12px;font-weight:700;font-family:var(--font-head);background:${correct?'#38a838':miss?'#1a1a10':'var(--surf2)'};color:${correct?'#fff':miss?'var(--mut)':'var(--txt)'};border:1px solid ${correct?'#38a838':miss?'var(--bord)':'var(--bord2)'};opacity:${guesses.has(l)?'.6':'1'};transition:all .1s`;
      b.textContent = l;
      b.onclick = () => guess(l);
      kb.appendChild(b);
    });
  }

  window._hmN = init;
  init();
  const kH = e => { if (/^[a-zA-Z]$/.test(e.key)) guess(e.key.toUpperCase()); };
  window.addEventListener('keydown', kH);
  CLEANERS.hangman = () => { window.removeEventListener('keydown', kH); delete window._hmN; };
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MATH BLITZ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BUILDERS.mathquiz = function(wrap) {
  wrap.style.cssText = 'flex-direction:column;align-items:center;justify-content:center';
  wrap.innerHTML = `<div class="hud-row"><div class="hb"><div class="hl">Score</div><div class="hv" id="mqS">0</div></div><div class="hb"><div class="hl">Streak</div><div class="hv" id="mqSt">0</div></div><div class="hb"><div class="hl">Time</div><div class="hv" id="mqT">60</div></div></div>
  <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;gap:18px;width:100%;max-width:440px">
    <div id="mqProg" style="width:100%;height:5px;background:var(--bord);border-radius:3px;overflow:hidden"><div id="mqPF" style="height:100%;background:var(--gold);width:100%;transition:width 1s linear"></div></div>
    <div id="mqQ" style="font-family:var(--font-head);font-size:42px;font-weight:800;color:var(--txt);text-align:center;min-height:60px;display:flex;align-items:center;justify-content:center"></div>
    <div id="mqOpts" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;width:100%"></div>
    <div id="mqMsg" style="font-size:15px;font-weight:700;min-height:24px;color:var(--gold);text-align:center"></div>
  </div>`;
  let score=0, streak=0, timeLeft=60, timer, correct, answered;

  function mkQ() {
    answered = false;
    const ops = ['+','-','√ó'];
    const op = ops[Math.floor(Math.random()*ops.length)];
    let a, b, ans;
    if (op==='+') { a=Math.floor(Math.random()*50)+1; b=Math.floor(Math.random()*50)+1; ans=a+b; }
    else if (op==='-') { a=Math.floor(Math.random()*60)+20; b=Math.floor(Math.random()*a)+1; ans=a-b; }
    else { a=Math.floor(Math.random()*12)+1; b=Math.floor(Math.random()*12)+1; ans=a*b; }
    correct = ans;
    const wrongs = new Set([ans]);
    while (wrongs.size < 4) { wrongs.add(ans + Math.floor(Math.random()*20) - 10); }
    const opts = [...wrongs].sort(()=>Math.random()-.5);
    document.getElementById('mqQ').textContent = `${a} ${op} ${b} = ?`;
    const od = document.getElementById('mqOpts'); od.innerHTML = '';
    opts.forEach(o => {
      const b2 = document.createElement('button');
      b2.style.cssText = 'padding:18px;background:var(--surf2);border:2px solid var(--bord2);border-radius:12px;font-family:var(--font-head);font-size:22px;font-weight:800;color:var(--txt);cursor:pointer;transition:all .15s';
      b2.textContent = o;
      b2.onmouseover = () => { if(!answered) b2.style.borderColor='var(--gold4)'; };
      b2.onmouseout  = () => { if(!answered) b2.style.borderColor='var(--bord2)'; };
      b2.onclick = () => {
        if (answered) return; answered = true;
        od.querySelectorAll('button').forEach(btn => btn.onclick = null);
        if (o === correct) {
          score += 10 + streak*2; streak++; SFX.correct2();
          b2.style.borderColor='#38a838'; b2.style.background='rgba(56,168,56,.2)';
          document.getElementById('mqMsg').textContent = '‚úÖ Correct! +' + (10+streak*2);
        } else {
          streak = 0; SFX.wrong2();
          b2.style.borderColor='#e84040'; b2.style.background='rgba(232,64,64,.15)';
          od.querySelectorAll('button').forEach(btn => { if(+btn.textContent===correct){btn.style.borderColor='#38a838';btn.style.background='rgba(56,168,56,.2)';}});
          document.getElementById('mqMsg').textContent = '‚ùå It was ' + correct;
        }
        document.getElementById('mqS').textContent = score;
        document.getElementById('mqSt').textContent = streak;
        setTimeout(() => { document.getElementById('mqMsg').textContent=''; mkQ(); }, 700);
      };
      od.appendChild(b2);
    });
  }

  timer = setInterval(() => {
    timeLeft--;
    document.getElementById('mqT').textContent = timeLeft;
    document.getElementById('mqPF').style.width = (timeLeft/60*100) + '%';
    if (timeLeft <= 0) {
      clearInterval(timer);
      document.getElementById('mqOpts').innerHTML = '';
      document.getElementById('mqQ').style.fontSize = '22px';
      document.getElementById('mqQ').textContent = "Time's Up!";
      document.getElementById('mqMsg').textContent = 'Final Score: ' + score + ' üéâ';
    }
  }, 1000);
  mkQ();
  CLEANERS.mathquiz = () => clearInterval(timer);
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SLIDING TILES (15-puzzle)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BUILDERS.slidingtiles = function(wrap) {
  wrap.style.cssText = 'flex-direction:column;align-items:center;justify-content:center';
  wrap.innerHTML = `<div class="hud-row"><div class="hb"><div class="hl">Moves</div><div class="hv" id="stMv">0</div></div><div class="hb"><div class="hl">Time</div><div class="hv" id="stTm">0</div></div><div class="hb"><div class="hl">Best</div><div class="hv" id="stBt">‚Äî</div></div></div>
  <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;gap:16px">
    <div id="stGrid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:7px;padding:14px;background:var(--surf);border-radius:18px;border:1px solid var(--bord2)"></div>
    <div id="stMsg" style="font-family:var(--font-head);font-size:16px;font-weight:800;color:var(--gold2);min-height:24px;text-align:center"></div>
    <div style="display:flex;gap:10px">
      <button class="btn-gold" onclick="window._stN()">Shuffle</button>
      <button class="btn-out" onclick="window._stSolve()">Hint</button>
    </div>
  </div>`;
  let tiles, moves, timer, elapsed, best=null, solved;

  function shuffle() {
    tiles = Array.from({length:16}, (_,i) => i);
    // Do valid shuffle: perform random valid moves from solved state
    let empty = 15;
    for (let i = 0; i < 200; i++) {
      const r = Math.floor(empty/4), c = empty%4;
      const neighbors = [];
      if (r>0) neighbors.push(empty-4);
      if (r<3) neighbors.push(empty+4);
      if (c>0) neighbors.push(empty-1);
      if (c<3) neighbors.push(empty+1);
      const pick = neighbors[Math.floor(Math.random()*neighbors.length)];
      [tiles[empty], tiles[pick]] = [tiles[pick], tiles[empty]];
      empty = pick;
    }
  }

  function init() {
    shuffle(); moves = 0; elapsed = 0; solved = false;
    document.getElementById('stMv').textContent = '0';
    document.getElementById('stMsg').textContent = '';
    clearInterval(timer);
    timer = setInterval(() => { if (!solved) { elapsed++; document.getElementById('stTm').textContent = elapsed; } }, 1000);
    render();
  }

  function move(i) {
    if (solved) return;
    const empty = tiles.indexOf(0);
    const er = Math.floor(empty/4), ec = empty%4;
    const ir = Math.floor(i/4), ic = i%4;
    if (Math.abs(er-ir)+Math.abs(ec-ic) !== 1) return;
    [tiles[empty], tiles[i]] = [tiles[i], tiles[empty]];
    SFX.blip(); moves++;
    document.getElementById('stMv').textContent = moves;
    render();
    if (tiles.every((t,i) => t === (i+1)%16)) {
      solved = true; clearInterval(timer);
      if (best === null || moves < best) { best = moves; document.getElementById('stBt').textContent = moves; }
      SFX.win(); document.getElementById('stMsg').textContent = `üéâ Solved in ${moves} moves, ${elapsed}s!`;
    }
  }

  function render() {
    const g = document.getElementById('stGrid'); g.innerHTML = '';
    tiles.forEach((t, i) => {
      const d = document.createElement('div');
      const isEmpty = t === 0;
      d.style.cssText = `width:76px;height:76px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-family:var(--font-head);font-size:24px;font-weight:800;cursor:${isEmpty?'default':'pointer'};user-select:none;transition:all .12s;background:${isEmpty?'var(--bg)':t<=5?'#1e2a0a':t<=10?'#0a1428':'#280a1e'};color:${isEmpty?'transparent':t<=5?'#88cc44':t<=10?'#4480e0':'#cc44aa'};border:2px solid ${isEmpty?'var(--bord)':t<=5?'#446622':t<=10?'#224488':'#662288'};box-shadow:${isEmpty?'none':'0 2px 8px rgba(0,0,0,.4)'}`;
      if (!isEmpty) d.textContent = t;
      d.onclick = () => move(i);
      g.appendChild(d);
    });
  }

  window._stN = init;
  window._stSolve = () => {
    const empty = tiles.indexOf(0);
    const r = Math.floor(empty/4), c = empty%4;
    const neighbors = [];
    if (r>0) neighbors.push(empty-4);
    if (r<3) neighbors.push(empty+4);
    if (c>0) neighbors.push(empty-1);
    if (c<3) neighbors.push(empty+1);
    const best = neighbors.reduce((bst, n) => tiles[n] < tiles[bst] ? n : bst, neighbors[0]);
    move(best);
  };

  init();
  CLEANERS.slidingtiles = () => { clearInterval(timer); delete window._stN; delete window._stSolve; };
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ASTEROIDS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BUILDERS.asteroids = function(wrap) {
  const W=540, H=460;
  wrap.style.cssText = 'flex-direction:column;align-items:center;padding-top:4px';
  wrap.innerHTML = `<div class="hud-row"><div class="hb"><div class="hl">Score</div><div class="hv" id="asS">0</div></div><div class="hb"><div class="hl">Lives</div><div class="hv" id="asL">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div></div><div class="hb"><div class="hl">Level</div><div class="hv" id="asLv">1</div></div></div>
  <div style="flex:1;display:flex;align-items:center;justify-content:center;padding:8px;min-height:0;width:100%">
  <canvas id="asCv" width="${W}" height="${H}" style="border-radius:12px;border:1px solid #2a2618;max-height:calc(100vh - 120px)"></canvas></div>
  <p style="color:var(--mut);font-size:11px;padding-bottom:8px">‚Üê ‚Üí Rotate ¬∑ ‚Üë Thrust ¬∑ Space=Fire ¬∑ P=Pause</p>`;
  const cv = document.getElementById('asCv'), ctx = cv.getContext('2d');
  let ship, bullets, rocks, score, lives, level, state='idle', raf, fr, invTimer, cooldown;
  const keys = {};
  const kH = e => { keys[e.key] = e.type==='keydown'; };
  window.addEventListener('keydown', kH); window.addEventListener('keyup', kH);

  function mkRock(x, y, r, speed) {
    const ang = Math.random() * Math.PI * 2, spd = speed || (0.6 + Math.random() * 0.8);
    const pts = Array.from({length:8}, (_, i) => {
      const a = (i/8)*Math.PI*2 + Math.random()*.5;
      return { x: Math.cos(a)*(r*.6+Math.random()*r*.4), y: Math.sin(a)*(r*.6+Math.random()*r*.4) };
    });
    return { x, y, vx: Math.cos(ang)*spd, vy: Math.sin(ang)*spd, r, pts, rot:0, rotSpd:(Math.random()-.5)*.04 };
  }

  function spawnRocks(n, lv) {
    const arr = [];
    for (let i = 0; i < n+lv; i++) {
      // spawn away from center
      const ang = Math.random()*Math.PI*2, dist = 180 + Math.random()*100;
      arr.push(mkRock(W/2+Math.cos(ang)*dist, H/2+Math.sin(ang)*dist, 36+Math.random()*12, 0.5+lv*.15));
    }
    return arr;
  }

  function init() {
    ship = { x:W/2, y:H/2, ang:-Math.PI/2, vx:0, vy:0 };
    score = 0; lives = 3; level = 1; fr = 0; invTimer = 120; cooldown = 0;
    bullets = []; rocks = spawnRocks(4, 1);
    document.getElementById('asS').textContent = '0';
    document.getElementById('asL').textContent = '‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è';
    document.getElementById('asLv').textContent = '1';
  }

  // Stars background (static)
  const stars = Array.from({length:60}, () => ({x:Math.random()*W, y:Math.random()*H, s:Math.random()*1.5+.5}));

  function update() {
    fr++; invTimer = Math.max(0, invTimer-1); cooldown--;
    if (keys['ArrowLeft']) ship.ang -= .065;
    if (keys['ArrowRight']) ship.ang += .065;
    if (keys['ArrowUp']) { ship.vx += Math.cos(ship.ang)*.18; ship.vy += Math.sin(ship.ang)*.18; }
    ship.vx *= .982; ship.vy *= .982;
    ship.x = (ship.x + ship.vx + W) % W;
    ship.y = (ship.y + ship.vy + H) % H;
    if (keys[' '] && cooldown <= 0) {
      cooldown = 14; SFX.shoot();
      bullets.push({ x:ship.x+Math.cos(ship.ang)*16, y:ship.y+Math.sin(ship.ang)*16, vx:Math.cos(ship.ang)*10, vy:Math.sin(ship.ang)*10, life:52 });
    }
    bullets.forEach(b => { b.x=(b.x+b.vx+W)%W; b.y=(b.y+b.vy+H)%H; b.life--; });
    bullets = bullets.filter(b => b.life > 0);
    rocks.forEach(r => { r.x=(r.x+r.vx+W)%W; r.y=(r.y+r.vy+H)%H; r.rot+=r.rotSpd; });

    // Bullet-rock collision
    const newRocks = [];
    bullets.forEach(b => {
      rocks.forEach((r, ri) => {
        if (!r.dead && Math.hypot(b.x-r.x, b.y-r.y) < r.r) {
          b.life = 0; r.dead = true; SFX.explode();
          score += r.r > 28 ? 20 : r.r > 16 ? 50 : 100;
          document.getElementById('asS').textContent = score;
          if (r.r > 20) { newRocks.push(mkRock(r.x, r.y, r.r/2)); newRocks.push(mkRock(r.x, r.y, r.r/2)); }
        }
      });
    });
    rocks = rocks.filter(r => !r.dead).concat(newRocks);
    if (!rocks.length) { level++; document.getElementById('asLv').textContent = level; rocks = spawnRocks(4, level); }

    // Ship-rock collision
    if (!invTimer) {
      rocks.forEach(r => {
        if (Math.hypot(ship.x-r.x, ship.y-r.y) < r.r - 4) {
          lives--; SFX.hit(); document.getElementById('asL').textContent = '‚ù§Ô∏è'.repeat(Math.max(0,lives)) || 'üíÄ';
          invTimer = 150; ship.vx = 0; ship.vy = 0; ship.x = W/2; ship.y = H/2;
          bullets = [];
          if (lives <= 0) { state = 'gameover'; SFX.lose(); }
        }
      });
    }
  }

  function render() {
    ctx.fillStyle = '#040810'; ctx.fillRect(0,0,W,H);
    stars.forEach(s => { ctx.fillStyle = `rgba(255,255,255,${.2+s.s*.2})`; ctx.fillRect(s.x,s.y,s.s,s.s); });

    rocks.forEach(r => {
      ctx.save(); ctx.translate(r.x,r.y); ctx.rotate(r.rot);
      ctx.strokeStyle = '#7070a0'; ctx.lineWidth = 2;
      ctx.beginPath(); r.pts.forEach((p,i) => i===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y)); ctx.closePath(); ctx.stroke();
      ctx.restore();
    });

    ctx.fillStyle = '#e8c46a'; ctx.shadowColor = '#e8c46a'; ctx.shadowBlur = 5;
    bullets.forEach(b => { ctx.beginPath(); ctx.arc(b.x,b.y,2.5,0,Math.PI*2); ctx.fill(); });
    ctx.shadowBlur = 0;

    // Ship (flicker when invincible)
    if (state !== 'idle' && (invTimer === 0 || fr%6 < 4)) {
      ctx.save(); ctx.translate(ship.x, ship.y); ctx.rotate(ship.ang + Math.PI/2);
      ctx.strokeStyle = '#e8c46a'; ctx.lineWidth = 2;
      ctx.beginPath(); ctx.moveTo(0,-14); ctx.lineTo(-9,10); ctx.lineTo(0,6); ctx.lineTo(9,10); ctx.closePath(); ctx.stroke();
      if (keys['ArrowUp']) {
        ctx.strokeStyle = `hsl(${fr*20},100%,60%)`; ctx.lineWidth = 2;
        ctx.beginPath(); ctx.moveTo(-5,10); ctx.lineTo(0,20+Math.random()*6); ctx.lineTo(5,10); ctx.stroke();
      }
      ctx.restore();
    }

    if (state==='idle')     cvBanner(ctx,W,H,'ASTEROIDS','Shoot all the rocks!','SPACE to Start ¬∑ ‚Üë‚Üê ‚Üí  to fly');
    else if (state==='paused')   cvBanner(ctx,W,H,'PAUSED','','P to Resume');
    else if (state==='gameover') cvBanner(ctx,W,H,'GAME OVER','Score: '+score,'SPACE to Try Again');

    raf = requestAnimationFrame(render);
    if (state === 'running') update();
  }
  raf = requestAnimationFrame(render);

  const spH = e => {
    if (e.code==='Space') { e.preventDefault(); if(state!=='running'){init();state='running';}return; }
    if ((e.key==='p'||e.key==='P') && state!=='idle') state = state==='paused'?'running':'paused';
  };
  window.addEventListener('keydown', spH);
  PAUSE_CBS.asteroids = p => { state = p?'paused':'running'; };
  CLEANERS.asteroids = () => { cancelAnimationFrame(raf); window.removeEventListener('keydown',kH); window.removeEventListener('keyup',kH); window.removeEventListener('keydown',spH); };
};


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COLOR FLOOD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BUILDERS.colorflood = function(wrap) {
  const N=14, MAX_MOVES=25;
  wrap.style.cssText='flex-direction:column;align-items:center;justify-content:center';
  wrap.innerHTML=`<div class="hud-row"><div class="hb"><div class="hl">Moves Left</div><div class="hv" id="cfM">${MAX_MOVES}</div></div><div class="hb"><div class="hl">Filled</div><div class="hv" id="cfF">0%</div></div><div class="hb"><div class="hl">Best</div><div class="hv" id="cfB">‚Äî</div></div></div>
  <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:12px;gap:12px">
    <canvas id="cfCv" width="${N*32}" height="${N*32}" style="border-radius:10px;border:1px solid var(--bord2);cursor:pointer"></canvas>
    <div id="cfPalette" style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center"></div>
    <div id="cfMsg" style="font-family:var(--font-head);font-size:16px;font-weight:800;color:var(--gold2);min-height:24px;text-align:center"></div>
    <button class="btn-gold" onclick="window._cfN()" style="padding:9px 24px;font-size:13px">New Game</button>
  </div>`;
  const COLS=['#e84040','#e8c46a','#4080e0','#50c850','#e850c8','#50c8e8'];
  const cv=document.getElementById('cfCv'),ctx=cv.getContext('2d');
  const SZ=32;
  let grid,moves,best=null,over;
  function init(){
    grid=Array.from({length:N},()=>Array.from({length:N},()=>Math.floor(Math.random()*COLS.length)));
    moves=MAX_MOVES;over=false;
    document.getElementById('cfM').textContent=MAX_MOVES;
    document.getElementById('cfF').textContent='0%';
    document.getElementById('cfMsg').textContent='';
    buildPalette();render();
  }
  function flood(newCol){
    if(over||moves<=0)return;
    const cur=grid[0][0];
    if(cur===newCol)return;
    const visited=new Set();
    const stack=[0];
    visited.add(0);
    while(stack.length){
      const idx=stack.pop();
      const r=Math.floor(idx/N),c=idx%N;
      grid[r][c]=newCol;
      [[r-1,c],[r+1,c],[r,c-1],[r,c+1]].forEach(([nr,nc])=>{
        if(nr>=0&&nr<N&&nc>=0&&nc<N&&!visited.has(nr*N+nc)&&grid[nr][nc]===cur){
          visited.add(nr*N+nc);stack.push(nr*N+nc);
        }
      });
    }
    moves--;SFX.pop();
    document.getElementById('cfM').textContent=moves;
    const total=N*N,filled=grid.flat().filter(v=>v===newCol).length;
    const pct=Math.round(filled/total*100);
    document.getElementById('cfF').textContent=pct+'%';
    const allSame=grid.flat().every(v=>v===newCol);
    if(allSame){over=true;SFX.win();const used=MAX_MOVES-moves;if(best===null||used<best){best=used;document.getElementById('cfB').textContent=used;}document.getElementById('cfMsg').textContent=`üèÜ Won in ${used} moves!`;}
    else if(moves<=0){over=true;SFX.lose();document.getElementById('cfMsg').textContent='üíÄ Out of moves!';}
    render();
  }
  function buildPalette(){
    const pal=document.getElementById('cfPalette');pal.innerHTML='';
    COLS.forEach((c,i)=>{
      const b=document.createElement('div');
      b.style.cssText=`width:42px;height:42px;border-radius:10px;background:${c};cursor:pointer;border:3px solid transparent;transition:all .1s;box-shadow:0 2px 8px rgba(0,0,0,.4)`;
      b.onmouseenter=()=>{b.style.transform='scale(1.15)';b.style.borderColor='#fff';};
      b.onmouseleave=()=>{b.style.transform='';b.style.borderColor='transparent';};
      b.onclick=()=>flood(i);
      pal.appendChild(b);
    });
  }
  function render(){
    for(let r=0;r<N;r++)for(let c=0;c<N;c++){
      ctx.fillStyle=COLS[grid[r][c]];ctx.fillRect(c*SZ,r*SZ,SZ,SZ);
    }
    ctx.strokeStyle='rgba(0,0,0,.25)';ctx.lineWidth=1;
    for(let i=0;i<=N;i++){ctx.beginPath();ctx.moveTo(i*SZ,0);ctx.lineTo(i*SZ,N*SZ);ctx.stroke();ctx.beginPath();ctx.moveTo(0,i*SZ);ctx.lineTo(N*SZ,i*SZ);ctx.stroke();}
  }
  window._cfN=init;init();
  CLEANERS.colorflood=()=>{delete window._cfN;};
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BUBBLE SHOOTER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BUILDERS.bubbles = function(wrap) {
  const W=380,H=500,COLS=['#e84040','#e8c46a','#4080e0','#50c850','#e850c8'];
  const ROWS=8,BCOLS=10,BR=19,SPC=BR*2+1;
  wrap.style.cssText='flex-direction:column;align-items:center';
  wrap.innerHTML=`<div class="hud-row"><div class="hb"><div class="hl">Score</div><div class="hv" id="bbS">0</div></div><div class="hb"><div class="hl">Best</div><div class="hv" id="bbB">0</div></div></div>
  <div style="flex:1;display:flex;align-items:center;justify-content:center;padding:8px;position:relative;width:100%">
  <canvas id="bbCv" width="${W}" height="${H}" style="border-radius:12px;border:1px solid #2a2618;cursor:crosshair;max-height:70vh"></canvas></div>
  <p style="color:var(--mut);font-size:12px;padding-bottom:8px">Click or tap to aim & shoot!</p>`;
  const cv=document.getElementById('bbCv'),ctx=cv.getContext('2d');
  let grid,shooter,bullet,score,best=0,raf,state='running',effects=[];
  function randCol(){return Math.floor(Math.random()*COLS.length);}
  function bPos(r,c){const off=r%2===0?0:BR;return{x:off+BR+c*SPC,y:30+r*(BR*1.72)};}
  function initGrid(){
    grid=[];
    for(let r=0;r<ROWS;r++){grid.push([]);for(let c=0;c<BCOLS;c++)grid[r].push(r<5?randCol():-1);}
  }
  function mkShooter(){shooter={x:W/2,y:H-40,angle:-Math.PI/2,next:randCol()};}
  function shoot(angle){
    if(bullet)return;
    const col=shooter.next;shooter.next=randCol();SFX.pop();
    bullet={x:shooter.x,y:shooter.y,vx:Math.cos(angle)*12,vy:Math.sin(angle)*12,col};
  }
  function snapBubble(){
    if(!bullet)return;
    let bestDist=Infinity,bestR=-1,bestC=-1;
    for(let r=0;r<ROWS;r++)for(let c=0;c<BCOLS;c++){
      if(grid[r][c]!==-1)continue;
      const p=bPos(r,c);const d=Math.hypot(bullet.x-p.x,bullet.y-p.y);
      if(d<bestDist&&d<SPC*1.5){bestDist=d;bestR=r;bestC=c;}
    }
    if(bestR===-1){bullet=null;return;}
    grid[bestR][bestC]=bullet.col;bullet=null;
    popGroup(bestR,bestC);
  }
  function popGroup(r0,c0){
    const col=grid[r0][c0];
    const visited=new Set();
    const group=[];
    const stack=[r0*100+c0];
    while(stack.length){
      const k=stack.pop();if(visited.has(k))continue;visited.add(k);
      const r=Math.floor(k/100),c=k%100;
      if(r<0||r>=ROWS||c<0||c>=BCOLS||grid[r][c]!==col)continue;
      group.push({r,c});
      const neighbors=r%2===0?[[r-1,c-1],[r-1,c],[r,c-1],[r,c+1],[r+1,c-1],[r+1,c]]:[[r-1,c],[r-1,c+1],[r,c-1],[r,c+1],[r+1,c],[r+1,c+1]];
      neighbors.forEach(([nr,nc])=>stack.push(nr*100+nc));
    }
    if(group.length>=3){
      group.forEach(({r,c})=>{
        const p=bPos(r,c);effects.push({x:p.x,y:p.y,col:COLS[col],life:20});
        grid[r][c]=-1;
      });
      score+=group.length*10;document.getElementById('bbS').textContent=score;
      if(score>best){best=score;document.getElementById('bbB').textContent=best;}
      SFX.match();
    }
    if(grid.every(row=>row.every(v=>v===-1))){state='win';SFX.win();}
    if(grid[ROWS-1].some(v=>v!==-1)){state='lose';SFX.lose();}
  }
  function update(){
    if(!bullet)return;
    bullet.x+=bullet.vx;bullet.y+=bullet.vy;
    if(bullet.x-BR<0){bullet.x=BR;bullet.vx=Math.abs(bullet.vx);}
    if(bullet.x+BR>W){bullet.x=W-BR;bullet.vx=-Math.abs(bullet.vx);}
    if(bullet.y-BR<20){snapBubble();return;}
    for(let r=0;r<ROWS;r++)for(let c=0;c<BCOLS;c++){
      if(grid[r][c]===-1)continue;
      const p=bPos(r,c);
      if(Math.hypot(bullet.x-p.x,bullet.y-p.y)<BR*1.8){snapBubble();return;}
    }
  }
  function render(){
    ctx.fillStyle='#0c0b08';ctx.fillRect(0,0,W,H);
    for(let r=0;r<ROWS;r++)for(let c=0;c<BCOLS;c++){
      const col=grid[r][c];if(col===-1)continue;
      const p=bPos(r,c);
      ctx.fillStyle=COLS[col];ctx.shadowColor=COLS[col];ctx.shadowBlur=8;
      ctx.beginPath();ctx.arc(p.x,p.y,BR-1,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='rgba(255,255,255,.25)';ctx.beginPath();ctx.arc(p.x-5,p.y-5,7,0,Math.PI*2);ctx.fill();
    }
    ctx.shadowBlur=0;
    if(bullet){
      ctx.fillStyle=COLS[bullet.col];ctx.shadowColor=COLS[bullet.col];ctx.shadowBlur=12;
      ctx.beginPath();ctx.arc(bullet.x,bullet.y,BR-1,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;
    }
    // Shooter
    ctx.fillStyle=COLS[shooter.next];ctx.shadowColor=COLS[shooter.next];ctx.shadowBlur=10;
    ctx.beginPath();ctx.arc(shooter.x,shooter.y,BR-1,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;
    // Aim line
    ctx.strokeStyle='rgba(255,255,255,.15)';ctx.lineWidth=1;ctx.setLineDash([6,6]);
    ctx.beginPath();ctx.moveTo(shooter.x,shooter.y);
    ctx.lineTo(shooter.x+Math.cos(shooter.angle)*120,shooter.y+Math.sin(shooter.angle)*120);
    ctx.stroke();ctx.setLineDash([]);
    effects.forEach(ef=>{
      ctx.fillStyle=ef.col;ctx.globalAlpha=ef.life/20;
      ctx.beginPath();ctx.arc(ef.x,ef.y,BR+5,0,Math.PI*2);ctx.fill();
      ctx.globalAlpha=1;ef.life--;
    });
    effects=effects.filter(e=>e.life>0);
    if(state==='win')cvBanner(ctx,W,H,'YOU WIN!','Score: '+score,'Click to Play Again');
    else if(state==='lose')cvBanner(ctx,W,H,'GAME OVER','Score: '+score,'Click to Play Again');
    if(state==='running')update();
    raf=requestAnimationFrame(render);
  }
  function getAngle(cx,cy,ex,ey){const a=Math.atan2(ey-cy,ex-cx);return Math.max(-Math.PI+0.2,Math.min(-0.2,a));}
  cv.addEventListener('mousemove',e=>{const r=cv.getBoundingClientRect();shooter.angle=getAngle(shooter.x,shooter.y,(e.clientX-r.left)*(W/r.width),(e.clientY-r.top)*(H/r.height));});
  cv.addEventListener('click',e=>{
    if(state!=='running'){score=0;document.getElementById('bbS').textContent='0';initGrid();mkShooter();bullet=null;effects=[];state='running';return;}
    const r=cv.getBoundingClientRect();shooter.angle=getAngle(shooter.x,shooter.y,(e.clientX-r.left)*(W/r.width),(e.clientY-r.top)*(H/r.height));
    shoot(shooter.angle);
  });
  initGrid();mkShooter();raf=requestAnimationFrame(render);
  CLEANERS.bubbles=()=>{cancelAnimationFrame(raf);};
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WORD SCRAMBLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BUILDERS.scramble = function(wrap) {
  wrap.style.cssText='flex-direction:column;align-items:center;justify-content:center';
  wrap.innerHTML=`<div class="hud-row"><div class="hb"><div class="hl">Score</div><div class="hv" id="wsS">0</div></div><div class="hb"><div class="hl">Streak</div><div class="hv" id="wsSt">0üî•</div></div><div class="hb"><div class="hl">Time</div><div class="hv" id="wsT">90</div></div></div>
  <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;gap:16px;width:100%;max-width:480px">
    <div id="wsHint" style="font-size:12px;color:var(--mut);text-align:center"></div>
    <div id="wsScrambled" style="font-family:var(--font-head);font-size:48px;font-weight:800;color:var(--gold2);letter-spacing:8px;text-align:center"></div>
    <input id="wsInput" type="text" autocomplete="off" autocorrect="off" spellcheck="false" style="width:100%;padding:14px 20px;background:var(--surf2);border:2px solid var(--bord2);border-radius:14px;font-family:var(--font-head);font-size:24px;font-weight:800;color:var(--txt);text-align:center;letter-spacing:4px;text-transform:uppercase;outline:none" placeholder="Type answer...">
    <div id="wsMsg" style="font-family:var(--font-head);font-size:16px;font-weight:700;min-height:24px;color:var(--gold);text-align:center"></div>
    <div style="display:flex;gap:10px">
      <button class="btn-out" onclick="window._wsSkip()">Skip ‚è≠</button>
    </div>
  </div>`;
  const WORDS=[
    {w:'PYTHON',h:'A programming language'},
    {w:'CANVAS',h:'HTML drawing element'},
    {w:'GALAXY',h:'Billions of stars'},
    {w:'BRIDGE',h:'Spans over water'},
    {w:'JUNGLE',h:'Dense tropical forest'},
    {w:'MONKEY',h:'Primate animal'},
    {w:'PLANET',h:'Orbits a star'},
    {w:'CASTLE',h:'Medieval fortress'},
    {w:'VIOLIN',h:'String instrument'},
    {w:'WINTER',h:'Coldest season'},
    {w:'GARDEN',h:'Growing flowers'},
    {w:'DRAGON',h:'Mythical fire beast'},
    {w:'LAPTOP',h:'Portable computer'},
    {w:'BUTTER',h:'Spread on toast'},
    {w:'SILVER',h:'Precious metal'},
    {w:'COFFEE',h:'Morning drink'},
    {w:'CHEESE',h:'Dairy product'},
    {w:'HAMMER',h:'Drives nails'},
    {w:'MIRROR',h:'Shows reflection'},
    {w:'PUZZLE',h:'Brain teaser'},
  ];
  let score=0,streak=0,timeLeft=90,timer,current;
  function scramble(w){
    let s=w.split('');
    while(s.join('')===w)s.sort(()=>Math.random()-.5);
    return s.join('');
  }
  function nextWord(){
    current=WORDS[Math.floor(Math.random()*WORDS.length)];
    document.getElementById('wsScrambled').textContent=scramble(current.w);
    document.getElementById('wsHint').textContent='Hint: '+current.h;
    document.getElementById('wsMsg').textContent='';
    document.getElementById('wsInput').value='';
    document.getElementById('wsInput').focus();
    document.getElementById('wsInput').style.borderColor='var(--bord2)';
  }
  timer=setInterval(()=>{
    timeLeft--;document.getElementById('wsT').textContent=timeLeft;
    if(timeLeft<=0){
      clearInterval(timer);
      document.getElementById('wsInput').disabled=true;
      document.getElementById('wsMsg').textContent='‚è∞ Time up! Final score: '+score;
    }
  },1000);
  document.getElementById('wsInput').addEventListener('input',e=>{
    const val=e.target.value.toUpperCase().trim();
    if(val===current.w){
      score+=10+streak*5;streak++;
      document.getElementById('wsS').textContent=score;
      document.getElementById('wsSt').textContent=streak+'üî•';
      document.getElementById('wsMsg').textContent='‚úÖ Correct! +' + (10+streak*5);
      document.getElementById('wsInput').style.borderColor='#38a838';
      SFX.correct2();
      setTimeout(nextWord,500);
    }
  });
  window._wsSkip=()=>{streak=0;document.getElementById('wsSt').textContent='0üî•';SFX.denied();nextWord();};
  nextWord();
  CLEANERS.scramble=()=>{clearInterval(timer);delete window._wsSkip;};
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOWER DEFENSE (Mini)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BUILDERS.towerdef = function(wrap) {
  const W=540,H=420,CELL=36;
  wrap.style.cssText='flex-direction:column;align-items:center';
  wrap.innerHTML=`<div class="hud-row"><div class="hb"><div class="hl">üí∞ Gold</div><div class="hv" id="tdG">100</div></div><div class="hb"><div class="hl">‚ù§Ô∏è Lives</div><div class="hv" id="tdL">20</div></div><div class="hb"><div class="hl">Wave</div><div class="hv" id="tdW">1</div></div><div class="hb"><div class="hl">Score</div><div class="hv" id="tdS">0</div></div></div>
  <div style="flex:1;display:flex;align-items:center;justify-content:center;padding:8px;position:relative;width:100%">
  <canvas id="tdCv" width="${W}" height="${H}" style="border-radius:12px;border:1px solid #2a2618;cursor:pointer;max-width:100%"></canvas></div>
  <p style="color:var(--mut);font-size:11px;padding-bottom:6px">Click empty cell to place tower (costs 25üí∞) ¬∑ Space=send wave</p>`;
  const cv=document.getElementById('tdCv'),ctx=cv.getContext('2d');
  const COLS=Math.floor(W/CELL),ROWS=Math.floor(H/CELL);
  // Path: winding road
  const PATH=[[0,5],[1,5],[2,5],[3,5],[4,5],[4,4],[4,3],[4,2],[5,2],[6,2],[7,2],[8,2],[9,2],[10,2],[10,3],[10,4],[10,5],[10,6],[10,7],[9,7],[8,7],[7,7],[6,7],[5,7],[4,7],[3,7],[2,7],[2,8],[2,9],[2,10],[3,10],[4,10],[5,10],[6,10],[7,10],[8,10],[9,10],[10,10],[11,10],[12,10],[13,10],[14,10],[14,9],[14,8],[14,7],[14,6],[14,5]];
  const pathSet=new Set(PATH.map(([c,r])=>r*COLS+c));
  let towers=[],enemies=[],bullets=[],gold=100,lives=20,wave=1,score=0,waveActive=false,spawnQ=0,spawnTimer=0,raf,state='idle';

  function spawnEnemy(){
    const hp=30+wave*15;
    enemies.push({px:0,py:PATH[0][1]*CELL+CELL/2,pathIdx:0,prog:0,hp,maxHp:hp,spd:0.8+wave*.1});
  }
  function update(){
    if(spawnQ>0){spawnTimer--;if(spawnTimer<=0){spawnEnemy();spawnQ--;spawnTimer=50;}}
    enemies.forEach(e=>{
      e.prog+=e.spd;
      while(e.prog>=CELL&&e.pathIdx<PATH.length-1){e.prog-=CELL;e.pathIdx++;}
      const [tc,tr]=PATH[Math.min(e.pathIdx,PATH.length-1)];
      const [nc,nr]=PATH[Math.min(e.pathIdx+1,PATH.length-1)];
      const t=e.prog/CELL;
      e.px=(tc+t*(nc-tc))*CELL+CELL/2;
      e.py=(tr+t*(nr-tr))*CELL+CELL/2;
      if(e.pathIdx>=PATH.length-1){e.dead=true;lives--;document.getElementById('tdL').textContent=lives;SFX.hit();if(lives<=0){state='gameover';SFX.lose();}}
    });
    enemies=enemies.filter(e=>!e.dead);
    // Towers shoot
    towers.forEach(t=>{
      t.cd=(t.cd||0)-1;
      if(t.cd>0)return;
      const range=t.range||100;
      const target=enemies.find(e=>Math.hypot(e.px-t.px,e.py-t.py)<range);
      if(target){t.cd=30;bullets.push({x:t.px,y:t.py,tx:target,dmg:t.dmg||15,spd:6,col:t.col||'#e8c46a'});}
    });
    bullets.forEach(b=>{
      const dx=b.tx.px-b.x,dy=b.tx.py-b.y,d=Math.hypot(dx,dy);
      if(d<b.spd){b.x=b.tx.px;b.y=b.tx.py;b.hit=true;b.tx.hp-=b.dmg;SFX.blip();
        if(b.tx.hp<=0){b.tx.dead=true;gold+=10;score+=10+wave*5;document.getElementById('tdG').textContent=gold;document.getElementById('tdS').textContent=score;}}
      else{b.x+=dx/d*b.spd;b.y+=dy/d*b.spd;}
    });
    bullets=bullets.filter(b=>!b.hit);
    enemies=enemies.filter(e=>!e.dead);
    if(waveActive&&spawnQ<=0&&!enemies.length){waveActive=false;gold+=20;document.getElementById('tdG').textContent=gold;wave++;document.getElementById('tdW').textContent=wave;}
  }
  function render(){
    ctx.fillStyle='#0c0b08';ctx.fillRect(0,0,W,H);
    for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++){
      const onPath=pathSet.has(r*COLS+c);
      ctx.fillStyle=onPath?'#2a2010':'#101208';
      ctx.fillRect(c*CELL,r*CELL,CELL,CELL);
      if(!onPath){ctx.strokeStyle='#151510';ctx.lineWidth=0.5;ctx.strokeRect(c*CELL,r*CELL,CELL,CELL);}
    }
    // Path arrows
    PATH.forEach(([c,r],i)=>{if(i%3===0){ctx.fillStyle='#3a3210';ctx.beginPath();ctx.arc(c*CELL+CELL/2,r*CELL+CELL/2,3,0,Math.PI*2);ctx.fill();}});
    towers.forEach(t=>{
      ctx.fillStyle=t.col||'#c9a84c';ctx.shadowColor=t.col||'#c9a84c';ctx.shadowBlur=6;
      ctx.beginPath();ctx.roundRect(t.cx*CELL+4,t.cy*CELL+4,CELL-8,CELL-8,5);ctx.fill();ctx.shadowBlur=0;
      ctx.fillStyle='rgba(255,255,255,.6)';ctx.beginPath();ctx.arc(t.px,t.py-4,3,0,Math.PI*2);ctx.fill();
    });
    enemies.forEach(e=>{
      ctx.fillStyle='#e84040';ctx.shadowColor='#e84040';ctx.shadowBlur=8;
      ctx.beginPath();ctx.arc(e.px,e.py,10,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;
      ctx.fillStyle='#ff8080';ctx.beginPath();ctx.arc(e.px-3,e.py-3,3,0,Math.PI*2);ctx.fill();
      // HP bar
      const bw=24,bh=4;ctx.fillStyle='#500';ctx.fillRect(e.px-bw/2,e.py-16,bw,bh);
      ctx.fillStyle='#e84040';ctx.fillRect(e.px-bw/2,e.py-16,bw*(e.hp/e.maxHp),bh);
    });
    bullets.forEach(b=>{
      ctx.fillStyle=b.col;ctx.shadowColor=b.col;ctx.shadowBlur=6;
      ctx.beginPath();ctx.arc(b.x,b.y,3.5,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;
    });
    if(state==='idle')cvBanner(ctx,W,H,'TOWER DEFENSE','Click to place towers ¬∑ Space=send wave','50 waves ¬∑ Survive!');
    else if(state==='gameover')cvBanner(ctx,W,H,'GAME OVER','Score: '+score,'Space to Try Again');
    else if(!waveActive&&state==='running'){
      ctx.fillStyle='rgba(0,0,0,.55)';ctx.fillRect(0,H-36,W,36);
      ctx.textAlign='center';ctx.font='700 13px DM Sans,sans-serif';ctx.fillStyle='#c9a84c';
      ctx.fillText('‚ñ∂ Press SPACE to send Wave '+wave,W/2,H-14);
    }
    if(state==='running')update();
    raf=requestAnimationFrame(render);
  }
  cv.addEventListener('click',e=>{
    if(state!=='running')return;
    const r=cv.getBoundingClientRect();
    const c=Math.floor((e.clientX-r.left)*(W/r.width)/CELL),row=Math.floor((e.clientY-r.top)*(H/r.height)/CELL);
    if(c<0||c>=COLS||row<0||row>=ROWS)return;
    if(pathSet.has(row*COLS+c)||towers.some(t=>t.cx===c&&t.cy===row))return;
    if(gold<25){SFX.denied();return;}
    gold-=25;document.getElementById('tdG').textContent=gold;
    const lvl=Math.floor(Math.random()*3);
    const tCols=['#c9a84c','#50c8e8','#e850c8'];
    towers.push({cx:c,cy:row,px:c*CELL+CELL/2,py:row*CELL+CELL/2,col:tCols[lvl],range:90+lvl*20,dmg:12+lvl*8,cd:0});
    SFX.score();
  });
  const spH3=e=>{
    if(e.code==='Space'){e.preventDefault();
      if(state==='idle'||state==='gameover'){towers=[];enemies=[];bullets=[];gold=100;lives=20;wave=1;score=0;waveActive=false;document.getElementById('tdG').textContent='100';document.getElementById('tdL').textContent='20';document.getElementById('tdW').textContent='1';document.getElementById('tdS').textContent='0';state='running';}
      if(!waveActive&&state==='running'){waveActive=true;spawnQ=5+wave*2;spawnTimer=1;}
    }
  };
  window.addEventListener('keydown',spH3);
  raf=requestAnimationFrame(render);
  PAUSE_CBS.towerdef=p=>{state=p?'paused':'running';};
  CLEANERS.towerdef=()=>{cancelAnimationFrame(raf);window.removeEventListener('keydown',spH3);};
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EMOJI PAIRS (Speed Match)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BUILDERS.pairs = function(wrap) {
  const EMOJIS=['üê∂','üê±','ü¶ä','üêª','üêº','üê®','ü¶Å','üêØ','üê∏','üêô','ü¶ã','üå∫','üçï','üçî','üåà','‚ö°','üé∏','üöÄ','üíé','üèÜ'];
  wrap.style.cssText='flex-direction:column;align-items:center;justify-content:center';
  wrap.innerHTML=`<div class="hud-row"><div class="hb"><div class="hl">Score</div><div class="hv" id="epS">0</div></div><div class="hb"><div class="hl">Streak</div><div class="hv" id="epSt">0</div></div><div class="hb"><div class="hl">Time</div><div class="hv" id="epT">60</div></div><div class="hb"><div class="hl">Best</div><div class="hv" id="epB">0</div></div></div>
  <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:16px;gap:16px;width:100%;max-width:500px">
    <div style="font-size:11px;color:var(--mut);font-weight:600;text-transform:uppercase;letter-spacing:1px">Does the emoji on the right match the one on the left?</div>
    <div style="display:flex;align-items:center;gap:24px">
      <div id="epLeft" style="font-size:80px;transition:all .15s"></div>
      <div style="font-size:24px;color:var(--mut)">vs</div>
      <div id="epRight" style="font-size:80px;transition:all .15s"></div>
    </div>
    <div id="epFeedback" style="font-family:var(--font-head);font-size:22px;font-weight:800;min-height:32px;text-align:center"></div>
    <div style="display:flex;gap:14px">
      <button id="epYes" style="padding:16px 36px;background:#38a838;color:#fff;border:none;border-radius:28px;font-size:18px;font-weight:700;cursor:pointer;font-family:inherit;transition:all .12s" onmouseover="this.style.transform='scale(1.06)'" onmouseout="this.style.transform=''">‚úÖ Yes</button>
      <button id="epNo"  style="padding:16px 36px;background:#e84040;color:#fff;border:none;border-radius:28px;font-size:18px;font-weight:700;cursor:pointer;font-family:inherit;transition:all .12s" onmouseover="this.style.transform='scale(1.06)'" onmouseout="this.style.transform=''">‚ùå No</button>
    </div>
    <div style="font-size:12px;color:var(--mut)">Keyboard: ‚Üê / ‚Üí or Y / N</div>
    <button class="btn-gold" id="epStart" onclick="window._epN()">Start Game</button>
  </div>`;
  let score=0,streak=0,timeLeft=60,timer,best=0,running=false,currentLeft,currentRight,answered;
  function nextPair(){
    answered=false;
    currentLeft=EMOJIS[Math.floor(Math.random()*EMOJIS.length)];
    const isMatch=Math.random()<0.5;
    currentRight=isMatch?currentLeft:EMOJIS[Math.floor(Math.random()*EMOJIS.length)];
    document.getElementById('epLeft').textContent=currentLeft;
    document.getElementById('epRight').textContent=currentRight;
    document.getElementById('epFeedback').textContent='';
  }
  function answer(yes){
    if(!running||answered)return;answered=true;
    const isMatch=currentLeft===currentRight;
    const correct=(yes&&isMatch)||(!yes&&!isMatch);
    if(correct){score+=10+streak*3;streak++;SFX.correct2();document.getElementById('epFeedback').style.color='#50c850';document.getElementById('epFeedback').textContent='‚úÖ Correct! +' +(10+streak*3);}
    else{streak=0;SFX.wrong2();document.getElementById('epFeedback').style.color='#e84040';document.getElementById('epFeedback').textContent='‚ùå Wrong!';}
    document.getElementById('epS').textContent=score;document.getElementById('epSt').textContent=streak;
    setTimeout(nextPair,400);
  }
  function startGame(){
    running=true;score=0;streak=0;timeLeft=60;
    document.getElementById('epS').textContent='0';document.getElementById('epSt').textContent='0';document.getElementById('epT').textContent='60';
    document.getElementById('epStart').style.display='none';
    clearInterval(timer);
    timer=setInterval(()=>{
      timeLeft--;document.getElementById('epT').textContent=timeLeft;
      if(timeLeft<=0){running=false;clearInterval(timer);if(score>best){best=score;document.getElementById('epB').textContent=best;}document.getElementById('epFeedback').textContent='‚è∞ Time! Score: '+score;document.getElementById('epStart').textContent='Play Again';document.getElementById('epStart').style.display='';}
    },1000);
    nextPair();
  }
  document.getElementById('epYes').addEventListener('click',()=>answer(true));
  document.getElementById('epNo').addEventListener('click',()=>answer(false));
  const kH=e=>{
    if(e.key==='ArrowLeft'||e.key.toLowerCase()==='y')answer(true);
    if(e.key==='ArrowRight'||e.key.toLowerCase()==='n')answer(false);
  };
  window.addEventListener('keydown',kH);
  window._epN=startGame;
  CLEANERS.pairs=()=>{clearInterval(timer);window.removeEventListener('keydown',kH);delete window._epN;};
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FROGGER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BUILDERS.frogger = function(wrap) {
  const COLS=13, ROWS=13, SZ=40, W=COLS*SZ, H=ROWS*SZ;
  wrap.style.cssText='flex-direction:column;align-items:center';
  wrap.innerHTML=`<div class="hud-row"><div class="hb"><div class="hl">Score</div><div class="hv" id="frS">0</div></div><div class="hb"><div class="hl">Lives</div><div class="hv" id="frLv">üê∏üê∏üê∏</div></div><div class="hb"><div class="hl">Best</div><div class="hv" id="frB">0</div></div></div>
  <div style="flex:1;display:flex;align-items:center;justify-content:center;padding:10px;position:relative;width:100%"><canvas id="frCv" width="${W}" height="${H}" style="border-radius:12px;border:1px solid #2a2618;max-height:75vh;cursor:pointer"></canvas></div>
  <p style="color:var(--mut);font-size:12px;padding-bottom:8px">Arrow Keys / WASD ¬∑ Space=Start ¬∑ Reach the top!</p>`;
  const cv=document.getElementById('frCv'), ctx=cv.getContext('2d');
  // Lane types: 0=safe, 1=traffic(left), 2=traffic(right), 3=log(left), 4=log(right), 5=water, 6=home
  const LANES=[
    {t:0,col:'#1a3000'},   // row 0 - homes
    {t:4,col:'#002840',spd:1.2,w:3}, // logs
    {t:3,col:'#002840',spd:0.8,w:4},
    {t:4,col:'#002840',spd:1.6,w:2},
    {t:3,col:'#002840',spd:1.0,w:3},
    {t:5,col:'#002840',spd:0,w:0},   // row 5 - median
    {t:0,col:'#1a1a00'},
    {t:1,col:'#1a1a00',spd:2.2},  // traffic
    {t:2,col:'#1a1a00',spd:1.5},
    {t:1,col:'#1a1a00',spd:3.0},
    {t:2,col:'#1a1a00',spd:1.8},
    {t:0,col:'#1a1a00'},
    {t:0,col:'#1a3000'},  // row 12 - start
  ];
  let frog, vehicles, logs, lives, score, best=0, state='idle', raf, fr, homes;
  function mkVehicles() {
    vehicles=[];
    [7,8,9,10].forEach(row=>{
      const lane=LANES[row]; const dir=lane.t===1?1:-1;
      for(let i=0;i<3;i++) vehicles.push({x:(i*(COLS/3)+Math.random()*2)*SZ,y:row*SZ,w:SZ*1.6,h:SZ*0.7,vy:0,vx:lane.spd*dir,row,col:lane.t===1?'#e84040':'#e87030'});
    });
  }
  function mkLogs() {
    logs=[];
    [1,2,3,4].forEach(row=>{
      const lane=LANES[row]; const dir=lane.t===3?-1:1;
      for(let i=0;i<3;i++) logs.push({x:(i*(COLS/3)+Math.random()*2)*SZ,y:row*SZ,w:lane.w*SZ,h:SZ*0.75,vx:lane.spd*dir,row,onLog:false});
    });
  }
  function init() { frog={x:6*SZ+SZ/2,y:12*SZ+SZ/2,alive:true,onLog:false,logVx:0}; lives=3; score=0; fr=0; homes=Array(5).fill(false); mkVehicles(); mkLogs(); document.getElementById('frS').textContent='0'; document.getElementById('frLv').textContent='üê∏üê∏üê∏'; }
  function moveFrog(dx,dy) {
    if(state!=='running'||!frog.alive)return;
    frog.x=Math.max(SZ/2,Math.min(W-SZ/2,frog.x+dx*SZ));
    frog.y=Math.max(0,frog.y+dy*SZ);
    SFX.jump();
    checkLanding();
  }
  function checkLanding() {
    const row=Math.floor(frog.y/SZ);
    if(row<0){loseLife();return;}
    const lane=LANES[Math.min(row,LANES.length-1)];
    // Reached homes row
    if(row===0){
      const slot=Math.floor(frog.x/(W/5));
      if(slot>=0&&slot<5&&!homes[slot]){homes[slot]=true;score+=50;document.getElementById('frS').textContent=score;SFX.score();frog={x:6*SZ+SZ/2,y:12*SZ+SZ/2,alive:true,onLog:false,logVx:0};if(homes.every(v=>v)){score+=200;document.getElementById('frS').textContent=score;homes=Array(5).fill(false);SFX.win();}}else loseLife();
    }
  }
  function loseLife() {
    lives--; SFX.lose();
    document.getElementById('frLv').textContent='üê∏'.repeat(Math.max(0,lives))||'üíÄ';
    if(lives<=0){if(score>best){best=score;document.getElementById('frB').textContent=best;}state='gameover';}
    else frog={x:6*SZ+SZ/2,y:12*SZ+SZ/2,alive:true,onLog:false,logVx:0};
  }
  function update() {
    fr++;
    // Move vehicles
    vehicles.forEach(v=>{v.x+=v.vx;if(v.vx>0&&v.x>W+v.w)v.x=-v.w;if(v.vx<0&&v.x<-v.w)v.x=W+v.w;});
    // Move logs
    logs.forEach(l=>{l.x+=l.vx;if(l.vx>0&&l.x>W+l.w)l.x=-l.w;if(l.vx<0&&l.x<-l.w)l.x=W+l.w;});
    // Frog physics
    const row=Math.floor(frog.y/SZ);
    if(row>=1&&row<=4){
      // Water rows - must be on log
      let onLog=false;
      logs.forEach(l=>{if(l.row===row&&frog.x>l.x&&frog.x<l.x+l.w&&frog.y>l.y&&frog.y<l.y+l.h+SZ*0.25){onLog=true;frog.x+=l.vx;}});
      frog.onLog=onLog;
      if(!onLog)loseLife();
      // Fell off screen horizontally
      if(frog.x<0||frog.x>W)loseLife();
    } else if(row>=7&&row<=10){
      // Traffic rows
      vehicles.forEach(v=>{const fw=SZ*0.45;if(Math.abs(frog.x-(v.x+v.w/2))<fw+v.w/2&&Math.abs(frog.y-(v.y+v.h/2))<fw+v.h/2)loseLife();});
    }
  }
  function render() {
    // Draw background lanes
    LANES.forEach((lane,row)=>{ctx.fillStyle=lane.col;ctx.fillRect(0,row*SZ,W,SZ);});
    // Draw road stripes
    [7,8,9,10].forEach(row=>{ctx.strokeStyle='rgba(255,255,200,.12)';ctx.setLineDash([20,15]);ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(0,row*SZ+SZ/2);ctx.lineTo(W,row*SZ+SZ/2);ctx.stroke();ctx.setLineDash([]);});
    // Draw home slots
    for(let i=0;i<5;i++){const x=i*(W/5);ctx.fillStyle=homes[i]?'#50c850':'#002a10';ctx.beginPath();ctx.roundRect(x+4,4,W/5-8,SZ-8,8);ctx.fill();}
    // Draw logs
    logs.forEach(l=>{ctx.fillStyle='#5a3010';ctx.beginPath();ctx.roundRect(l.x,l.y+SZ*0.12,l.w,l.h,8);ctx.fill();ctx.fillStyle='rgba(255,255,255,.08)';ctx.fillRect(l.x+4,l.y+SZ*.18,l.w-8,4);});
    // Draw vehicles
    vehicles.forEach(v=>{ctx.fillStyle=v.col;ctx.beginPath();ctx.roundRect(v.x,v.y+SZ*0.15,v.w,v.h,5);ctx.fill();ctx.fillStyle='rgba(255,255,255,.3)';ctx.fillRect(v.x+4,v.y+SZ*.2,v.w*0.3,v.h*0.35);});
    // Draw frog
    if(state!=='idle'){ctx.fillStyle='#50c850';ctx.beginPath();ctx.arc(frog.x,frog.y,SZ*0.38,0,Math.PI*2);ctx.fill();ctx.fillStyle='#e8c46a';ctx.beginPath();ctx.arc(frog.x-6,frog.y-10,5,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(frog.x+6,frog.y-10,5,0,Math.PI*2);ctx.fill();}
    if(state==='idle')cvBanner(ctx,W,H,'FROGGER','Hop to the top ‚Äî dodge cars, ride logs!','SPACE to Start');
    else if(state==='paused')cvBanner(ctx,W,H,'PAUSED','','P to Resume');
    else if(state==='gameover')cvBanner(ctx,W,H,'GAME OVER','Score: '+score,'SPACE to Try Again');
    raf=requestAnimationFrame(render);
    if(state==='running')update();
  }
  init(); state='idle';
  raf=requestAnimationFrame(render);
  const kH=e=>{
    if(e.key==='p'||e.key==='P'){if(state==='running')state='paused';else if(state==='paused')state='running';return;}
    if(e.code==='Space'){e.preventDefault();if(state!=='running'){init();state='running';return;}}
    if(state!=='running')return;
    if(e.key==='ArrowUp'||e.key==='w'||e.key==='W'){e.preventDefault();moveFrog(0,-1);}
    if(e.key==='ArrowDown'||e.key==='s'||e.key==='S'){e.preventDefault();moveFrog(0,1);}
    if(e.key==='ArrowLeft'||e.key==='a'||e.key==='A'){e.preventDefault();moveFrog(-1,0);}
    if(e.key==='ArrowRight'||e.key==='d'||e.key==='D'){e.preventDefault();moveFrog(1,0);}
  };
  window.addEventListener('keydown',kH);
  cv.addEventListener('click',e=>{if(state==='idle'||state==='gameover'){init();state='running';}});
  PAUSE_CBS.frogger=p=>{state=p?'paused':'running';};
  CLEANERS.frogger=()=>{cancelAnimationFrame(raf);window.removeEventListener('keydown',kH);};
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NUMBER RUSH (Schulte Table)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BUILDERS.numrush = function(wrap) {
  wrap.style.cssText='flex-direction:column;align-items:center;justify-content:center';
  wrap.innerHTML=`<div class="hud-row"><div class="hb"><div class="hl">Time</div><div class="hv" id="nrT">‚Äî</div></div><div class="hb"><div class="hl">Next</div><div class="hv" id="nrN" style="font-size:24px;color:var(--gold)">‚Äî</div></div><div class="hb"><div class="hl">Best</div><div class="hv" id="nrB">‚Äî</div></div></div>
  <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:16px;gap:14px">
    <div id="nrGrid" style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px"></div>
    <div id="nrMsg" style="font-family:var(--font-head);font-size:15px;font-weight:700;color:var(--gold2);min-height:24px;text-align:center"></div>
    <button class="btn-gold" id="nrStart" onclick="window._nrN()" style="padding:10px 28px">Start Game</button>
  </div>`;
  let nums, next, startTime, timer, best=null, running=false;
  function buildGrid() {
    nums=[...Array(25)].map((_,i)=>i+1).sort(()=>Math.random()-.5);
    const g=document.getElementById('nrGrid'); g.innerHTML='';
    nums.forEach(n=>{
      const d=document.createElement('div');
      d.style.cssText='width:60px;height:60px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-family:var(--font-head);font-size:20px;font-weight:800;cursor:pointer;border:2px solid var(--bord2);background:var(--surf);color:var(--txt);transition:all .1s;user-select:none';
      d.textContent=n; d.dataset.n=n;
      d.addEventListener('click',()=>clickNum(n,d));
      d.onmouseover=()=>{if(!d.dataset.done)d.style.borderColor='var(--gold4)';};
      d.onmouseout=()=>{if(!d.dataset.done)d.style.borderColor='var(--bord2)';};
      g.appendChild(d);
    });
  }
  function clickNum(n,el) {
    if(!running)return;
    if(n===next){
      el.style.background='rgba(80,200,80,.25)'; el.style.borderColor='#50c850'; el.style.color='#50c850'; el.dataset.done='1';
      SFX.blip(); next++;
      document.getElementById('nrN').textContent=next<=25?next:'‚úì';
      if(next>25){
        running=false; clearInterval(timer);
        const elapsed=(Date.now()-startTime)/1000;
        const t=elapsed.toFixed(2)+'s';
        if(best===null||elapsed<best){best=elapsed;document.getElementById('nrB').textContent=t;}
        document.getElementById('nrMsg').textContent=`üèÜ Done in ${t}!`;
        document.getElementById('nrT').textContent=t;
        document.getElementById('nrStart').textContent='Play Again';
        document.getElementById('nrStart').style.display='';
        SFX.win();
      }
    } else {
      el.style.borderColor='#e84040'; el.style.background='rgba(232,64,64,.15)';
      SFX.denied();
      setTimeout(()=>{if(!el.dataset.done){el.style.borderColor='var(--bord2)';el.style.background='var(--surf)';}},300);
    }
  }
  function startGame() {
    running=true; next=1; startTime=Date.now();
    document.getElementById('nrN').textContent='1';
    document.getElementById('nrMsg').textContent='';
    document.getElementById('nrStart').style.display='none';
    clearInterval(timer);
    timer=setInterval(()=>{
      const el=document.getElementById('nrT');
      if(el)el.textContent=((Date.now()-startTime)/1000).toFixed(1)+'s';
    },100);
    buildGrid();
  }
  window._nrN=startGame; startGame();
  CLEANERS.numrush=()=>{clearInterval(timer);delete window._nrN;};
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MISSILE COMMAND
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BUILDERS.missile = function(wrap) {
  const W=560, H=460;
  wrap.style.cssText='flex-direction:column;align-items:center';
  wrap.innerHTML=`<div class="hud-row"><div class="hb"><div class="hl">Score</div><div class="hv" id="mcS">0</div></div><div class="hb"><div class="hl">Cities</div><div class="hv" id="mcC">üèôÔ∏èüèôÔ∏èüèôÔ∏èüèôÔ∏èüèôÔ∏èüèôÔ∏è</div></div><div class="hb"><div class="hl">Wave</div><div class="hv" id="mcW">1</div></div></div>
  <div style="flex:1;display:flex;align-items:center;justify-content:center;padding:10px;position:relative;width:100%"><canvas id="mcCv" width="${W}" height="${H}" style="border-radius:12px;border:1px solid #2a2618;max-height:74vh;cursor:crosshair"></canvas></div>
  <p style="color:var(--mut);font-size:12px;padding-bottom:8px">Click to fire interceptors ¬∑ Space=Start ¬∑ P=Pause</p>`;
  const cv=document.getElementById('mcCv'), ctx=cv.getContext('2d');
  const CITY_XS=[60,140,220,340,420,500];
  let missiles, interceptors, explosions, cities, score, wave, state='idle', raf, fr, spawnTimer;
  function init() {
    missiles=[]; interceptors=[]; explosions=[]; score=0; wave=1; fr=0; spawnTimer=0;
    cities=Array(6).fill(true);
    document.getElementById('mcS').textContent='0';
    document.getElementById('mcW').textContent='1';
    document.getElementById('mcC').textContent='üèôÔ∏è'.repeat(6);
  }
  function spawnMissile() {
    const tx=CITY_XS[Math.floor(Math.random()*CITY_XS.length)];
    const speed=0.5+wave*0.2+Math.random()*0.5;
    missiles.push({x:Math.random()*W,y:0,tx,ty:H-32,vx:0,vy:0,speed,trail:[]});
    const m=missiles[missiles.length-1];
    const dist=Math.hypot(m.tx-m.x,m.ty-m.y);
    m.vx=(m.tx-m.x)/dist*speed; m.vy=(m.ty-m.y)/dist*speed;
  }
  function fireAt(mx,my) {
    const sx=W/2,sy=H-16;
    const dist=Math.hypot(mx-sx,my-sy);
    if(dist<5)return;
    const spd=8;
    interceptors.push({x:sx,y:sy,tx:mx,ty:my,vx:(mx-sx)/dist*spd,vy:(my-sy)/dist*spd});
    SFX.shoot();
  }
  function explode(x,y,r,col) { explosions.push({x,y,r,maxR:r,cr:0,col:col||'#e8c46a',life:30}); }
  function update() {
    fr++; spawnTimer--;
    if(spawnTimer<=0){spawnMissile();spawnTimer=Math.max(20,80-wave*8);}
    // Move missiles
    missiles.forEach(m=>{
      m.trail.push({x:m.x,y:m.y});
      if(m.trail.length>20)m.trail.shift();
      m.x+=m.vx; m.y+=m.vy;
    });
    // Move interceptors - check if reached target
    interceptors.forEach(i=>{
      i.x+=i.vx; i.y+=i.vy;
      if(Math.hypot(i.x-i.tx,i.y-i.ty)<10){i.dead=true;explode(i.tx,i.ty,50,'#e8c46a');}
    });
    interceptors=interceptors.filter(i=>!i.dead);
    // Explosions grow
    explosions.forEach(e=>{e.cr=Math.min(e.cr+e.maxR/8,e.maxR);e.life--;});
    // Check missile vs explosion
    missiles.forEach(m=>{
      explosions.forEach(e=>{if(Math.hypot(m.x-e.x,m.y-e.y)<e.cr){m.dead=true;score+=100;document.getElementById('mcS').textContent=score;SFX.explode();}});
    });
    // Missiles hitting ground
    missiles.forEach(m=>{
      if(m.y>=H-32){
        const nearest=CITY_XS.reduce((a,b)=>Math.abs(b-m.x)<Math.abs(a-m.x)?b:a);
        const idx=CITY_XS.indexOf(nearest);
        if(idx>=0&&Math.abs(m.x-nearest)<40&&cities[idx]){cities[idx]=false;document.getElementById('mcC').textContent='üèôÔ∏è'.repeat(cities.filter(Boolean).length)+'üí•'.repeat(cities.filter(v=>!v).length);SFX.hit();}
        explode(m.x,H-32,30,'#e84040');
        m.dead=true;
      }
    });
    missiles=missiles.filter(m=>!m.dead);
    explosions=explosions.filter(e=>e.life>0);
    if(!cities.some(Boolean)){state='gameover';SFX.lose();return;}
    // Wave clear
    if(fr>300&&!missiles.length&&spawnTimer<=0){wave++;document.getElementById('mcW').textContent=wave;score+=wave*200;document.getElementById('mcS').textContent=score;fr=0;spawnTimer=60;SFX.win();}
  }
  function render() {
    ctx.fillStyle='#050810'; ctx.fillRect(0,0,W,H);
    // Stars
    if(fr%3===0){}
    ctx.fillStyle='rgba(255,255,255,.3)';
    for(let i=0;i<40;i++){const sx=(i*137.5)%W,sy=(i*91.3)%H;if(sy<H-60)ctx.fillRect(sx,sy,1,1);}
    // Ground
    ctx.fillStyle='#1a1a08'; ctx.fillRect(0,H-32,W,32);
    // Cities
    CITY_XS.forEach((cx,i)=>{
      if(cities[i]){ctx.fillStyle='#4080e0';ctx.fillRect(cx-16,H-62,32,30);ctx.fillRect(cx-22,H-50,10,18);ctx.fillRect(cx+12,H-50,10,18);ctx.fillStyle='rgba(255,255,100,.6)';for(let wy=0;wy<2;wy++)for(let wx=0;wx<3;wx++)ctx.fillRect(cx-10+wx*8,H-56+wy*10,5,5);}
      else{ctx.fillStyle='#3a1a00';ctx.fillRect(cx-16,H-62,32,30);}
    });
    // Missile base
    ctx.fillStyle='#c9a84c'; ctx.beginPath(); ctx.arc(W/2,H-16,16,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#e8c46a'; ctx.beginPath(); ctx.arc(W/2,H-16,10,0,Math.PI*2); ctx.fill();
    // Missile trails
    missiles.forEach(m=>{
      if(m.trail.length>1){ctx.strokeStyle='rgba(232,64,64,.6)';ctx.lineWidth=1.5;ctx.beginPath();m.trail.forEach((p,i)=>i?ctx.lineTo(p.x,p.y):ctx.moveTo(p.x,p.y));ctx.stroke();}
      ctx.fillStyle='#e84040'; ctx.beginPath(); ctx.arc(m.x,m.y,4,0,Math.PI*2); ctx.fill();
    });
    // Interceptor trails
    interceptors.forEach(i=>{ctx.strokeStyle='rgba(201,168,76,.5)';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(W/2,H-16);ctx.lineTo(i.x,i.y);ctx.stroke();ctx.fillStyle='#e8c46a';ctx.beginPath();ctx.arc(i.x,i.y,3,0,Math.PI*2);ctx.fill();});
    // Explosions
    explosions.forEach(e=>{
      const a=Math.min(0.7,e.life/15);
      const grad=ctx.createRadialGradient(e.x,e.y,0,e.x,e.y,Math.max(0.1,e.cr));
      const r2=parseInt(e.col.slice(1,3),16),g2=parseInt(e.col.slice(3,5),16),b2=parseInt(e.col.slice(5,7),16);
      grad.addColorStop(0,`rgba(${r2},${g2},${b2},${a})`);
      grad.addColorStop(1,`rgba(${r2},${g2},${b2},0)`);
      ctx.fillStyle=grad;
      ctx.beginPath();ctx.arc(e.x,e.y,Math.max(0.1,e.cr),0,Math.PI*2);ctx.fill();
    });
    if(state==='idle')cvBanner(ctx,W,H,'MISSILE COMMAND','Click to fire interceptors ‚Äî protect your cities!','SPACE to Start');
    else if(state==='paused')cvBanner(ctx,W,H,'PAUSED','','P to Resume');
    else if(state==='gameover')cvBanner(ctx,W,H,'GAME OVER','Score: '+score+' ¬∑ Wave: '+wave,'SPACE to Try Again');
    raf=requestAnimationFrame(render);
    if(state==='running')update();
  }
  init(); state='idle';
  raf=requestAnimationFrame(render);
  cv.addEventListener('click',e=>{
    if(state==='idle'||state==='gameover'){init();state='running';return;}
    if(state!=='running')return;
    const r=cv.getBoundingClientRect();
    fireAt((e.clientX-r.left)*(W/r.width),(e.clientY-r.top)*(H/r.height));
  });
  const kH=e=>{
    if(e.code==='Space'){e.preventDefault();if(state!=='running'){init();state='running';}}
    if(e.key==='p'||e.key==='P'){if(state==='running')state='paused';else if(state==='paused')state='running';}
  };
  window.addEventListener('keydown',kH);
  PAUSE_CBS.missile=p=>{state=p?'paused':'running';};
  CLEANERS.missile=()=>{cancelAnimationFrame(raf);window.removeEventListener('keydown',kH);};
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LIGHT CYCLES (Tron)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BUILDERS.lightcycle = function(wrap) {
  const COLS=40, ROWS=30, SZ=14, W=COLS*SZ, H=ROWS*SZ;
  wrap.style.cssText='flex-direction:column;align-items:center';
  wrap.innerHTML=`<div class="hud-row"><div class="hb"><div class="hl">P1 Wins</div><div class="hv" id="lcW1">0</div></div><div class="hb"><div class="hl">Round</div><div class="hv" id="lcR">1</div></div><div class="hb"><div class="hl">P2 Wins</div><div class="hv" id="lcW2">0</div></div></div>
  <div style="flex:1;display:flex;align-items:center;justify-content:center;padding:10px;position:relative;width:100%"><canvas id="lcCv" width="${W}" height="${H}" style="border-radius:12px;border:1px solid #2a2618;max-height:72vh"></canvas></div>
  <p style="color:var(--mut);font-size:12px;padding-bottom:8px">P1: WASD ¬∑ P2: Arrows ¬∑ Space=Start ¬∑ First to 5!</p>`;
  const cv=document.getElementById('lcCv'), ctx=cv.getContext('2d');
  let p1,p2,grid,w1=0,w2=0,round=1,state='idle',raf,fr,speed,moveTimer;
  const keys={};
  const kH=e=>{keys[e.key]=e.type==='keydown';};
  window.addEventListener('keydown',kH); window.addEventListener('keyup',kH);
  function mkGrid(){return Array.from({length:ROWS},()=>Array(COLS).fill(0));}
  function init(){
    grid=mkGrid(); fr=0; speed=6; moveTimer=0;
    p1={x:10,y:Math.floor(ROWS/2),dx:1,dy:0,col:'#4080e0',trail:'#2040a0',alive:true};
    p2={x:COLS-11,y:Math.floor(ROWS/2),dx:-1,dy:0,col:'#e84040',trail:'#a02020',alive:true};
    grid[p1.y][p1.x]=1; grid[p2.y][p2.x]=2;
  }
  function movePlayers(){
    // P1 direction
    if(keys['w']||keys['W']){if(p1.dy!==1){p1.dx=0;p1.dy=-1;}}
    else if(keys['s']||keys['S']){if(p1.dy!==-1){p1.dx=0;p1.dy=1;}}
    else if(keys['a']||keys['A']){if(p1.dx!==1){p1.dx=-1;p1.dy=0;}}
    else if(keys['d']||keys['D']){if(p1.dx!==-1){p1.dx=1;p1.dy=0;}}
    // P2 direction
    if(keys['ArrowUp']){if(p2.dy!==1){p2.dx=0;p2.dy=-1;}}
    else if(keys['ArrowDown']){if(p2.dy!==-1){p2.dx=0;p2.dy=1;}}
    else if(keys['ArrowLeft']){if(p2.dx!==1){p2.dx=-1;p2.dy=0;}}
    else if(keys['ArrowRight']){if(p2.dx!==-1){p2.dx=1;p2.dy=0;}}
    // Move p1
    if(p1.alive){
      const nx=p1.x+p1.dx, ny=p1.y+p1.dy;
      if(nx<0||nx>=COLS||ny<0||ny>=ROWS||grid[ny][nx]!==0)p1.alive=false;
      else{p1.x=nx;p1.y=ny;grid[ny][nx]=1;}
    }
    // Move p2
    if(p2.alive){
      const nx=p2.x+p2.dx, ny=p2.y+p2.dy;
      if(nx<0||nx>=COLS||ny<0||ny>=ROWS||grid[ny][nx]!==0)p2.alive=false;
      else{p2.x=nx;p2.y=ny;grid[ny][nx]=2;}
    }
  }
  function update(){
    fr++; moveTimer++;
    if(moveTimer>=speed){moveTimer=0;movePlayers();}
    if(!p1.alive||!p2.alive){
      if(!p1.alive&&!p2.alive){}
      else if(!p1.alive)w2++;
      else w1++;
      document.getElementById('lcW1').textContent=w1;
      document.getElementById('lcW2').textContent=w2;
      round++; document.getElementById('lcR').textContent=round;
      if(w1>=5||w2>=5){state='gameover';}
      else{state='roundover';setTimeout(()=>{init();state='running';},1800);}
    }
  }
  function render(){
    ctx.fillStyle='#050810'; ctx.fillRect(0,0,W,H);
    // Draw grid trails
    for(let y=0;y<ROWS;y++)for(let x=0;x<COLS;x++){
      if(grid[y][x]===1){ctx.fillStyle='#2040a0';ctx.fillRect(x*SZ+1,y*SZ+1,SZ-2,SZ-2);}
      else if(grid[y][x]===2){ctx.fillStyle='#a02020';ctx.fillRect(x*SZ+1,y*SZ+1,SZ-2,SZ-2);}
    }
    // Draw heads
    if(p1.alive){ctx.fillStyle='#4080e0';ctx.shadowColor='#4080e0';ctx.shadowBlur=12;ctx.fillRect(p1.x*SZ,p1.y*SZ,SZ,SZ);ctx.shadowBlur=0;}
    if(p2.alive){ctx.fillStyle='#e84040';ctx.shadowColor='#e84040';ctx.shadowBlur=12;ctx.fillRect(p2.x*SZ,p2.y*SZ,SZ,SZ);ctx.shadowBlur=0;}
    if(state==='idle')cvBanner(ctx,W,H,'LIGHT CYCLES','Tron ‚Äî trap your opponent!','SPACE to Start ¬∑ WASD vs Arrows');
    else if(state==='paused')cvBanner(ctx,W,H,'PAUSED','','P to Resume');
    else if(state==='gameover'){const w=w1>=5?'üîµ Player 1':'üî¥ Player 2';cvBanner(ctx,W,H,w+' Wins!',w1+' ‚Äî '+w2,'SPACE to Play Again');}
    else if(state==='roundover'){const msg=!p1.alive&&!p2.alive?'Tie!':!p1.alive?'P2 Scores!':'P1 Scores!';cvBanner(ctx,W,H,msg,'',w1+' ‚Äî '+w2);}
    raf=requestAnimationFrame(render);
    if(state==='running')update();
  }
  init(); state='idle';
  raf=requestAnimationFrame(render);
  const spH=e=>{
    if(e.code==='Space'){e.preventDefault();if(state==='idle'||state==='gameover'){init();w1=0;w2=0;round=1;document.getElementById('lcW1').textContent='0';document.getElementById('lcW2').textContent='0';document.getElementById('lcR').textContent='1';state='running';}}
    if(e.key==='p'||e.key==='P'){if(state==='running')state='paused';else if(state==='paused')state='running';}
  };
  window.addEventListener('keydown',spH);
  PAUSE_CBS.lightcycle=p=>{state=p?'paused':'running';};
  CLEANERS.lightcycle=()=>{cancelAnimationFrame(raf);window.removeEventListener('keydown',kH);window.removeEventListener('keyup',kH);window.removeEventListener('keydown',spH);};
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LIGHTS OUT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BUILDERS.pipes = function(wrap) {
  const N=5;
  wrap.style.cssText='flex-direction:column;align-items:center;justify-content:center';
  wrap.innerHTML=`<div class="hud-row"><div class="hb"><div class="hl">Moves</div><div class="hv" id="loM">0</div></div><div class="hb"><div class="hl">Lights On</div><div class="hv" id="loL">${N*N}</div></div><div class="hb"><div class="hl">Best</div><div class="hv" id="loB">‚Äî</div></div></div>
  <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:16px;gap:16px">
    <div id="loGrid" style="display:grid;grid-template-columns:repeat(${N},1fr);gap:8px"></div>
    <div id="loMsg" style="font-family:var(--font-head);font-size:15px;font-weight:700;color:var(--gold2);min-height:24px;text-align:center"></div>
    <div style="display:flex;gap:10px">
      <button class="btn-gold" onclick="window._loN()">New Puzzle</button>
      <button class="btn-out" onclick="window._loR()">Reset</button>
    </div>
  </div>
  <p style="color:var(--mut);font-size:12px;padding-bottom:8px">Click a cell to toggle it and its neighbors ¬∑ Turn all lights OFF!</p>`;

  let grid, initGrid, moves, best=null, solved;

  function toggle(r, c) {
    [[0,0],[1,0],[-1,0],[0,1],[0,-1]].forEach(([dr,dc])=>{
      const nr=r+dr, nc=c+dc;
      if(nr>=0&&nr<N&&nc>=0&&nc<N) grid[nr][nc]^=1;
    });
  }

  function countOn() { return grid.flat().reduce((s,v)=>s+v,0); }

  function render() {
    const g=document.getElementById('loGrid'); g.innerHTML='';
    for(let r=0;r<N;r++)for(let c=0;c<N;c++){
      const btn=document.createElement('button');
      const on=grid[r][c];
      btn.style.cssText=`width:64px;height:64px;border-radius:12px;border:2px solid ${on?'var(--gold)':'var(--bord)'};background:${on?'rgba(232,196,74,.35)':'var(--surf)'};cursor:pointer;transition:all .12s;font-size:28px;`;
      btn.textContent=on?'üí°':'‚¨õ';
      btn.onclick=()=>{
        if(solved)return;
        toggle(r,c); moves++;
        document.getElementById('loM').textContent=moves;
        document.getElementById('loL').textContent=countOn();
        SFX.blip();
        render();
        if(countOn()===0&&!solved){
          solved=true;
          if(best===null||moves<best){best=moves;document.getElementById('loB').textContent=moves;}
          document.getElementById('loMsg').textContent='üèÜ All off in '+moves+' moves!';
          SFX.win();
        }
      };
      g.appendChild(btn);
    }
    document.getElementById('loL').textContent=countOn();
  }

  // Generate solvable puzzle: start from all-off and do random clicks
  function newPuzzle() {
    solved=false; moves=0;
    document.getElementById('loM').textContent='0';
    document.getElementById('loMsg').textContent='';
    grid=Array.from({length:N},()=>Array(N).fill(0));
    // Do 12-20 random clicks from solved state to ensure solvability
    const clicks=12+Math.floor(Math.random()*9);
    for(let i=0;i<clicks;i++){
      toggle(Math.floor(Math.random()*N), Math.floor(Math.random()*N));
    }
    // Make sure there's at least one light on
    if(countOn()===0) toggle(Math.floor(N/2),Math.floor(N/2));
    initGrid=grid.map(r=>[...r]);
    render();
  }

  window._loN=newPuzzle;
  window._loR=()=>{grid=initGrid.map(r=>[...r]);moves=0;solved=false;document.getElementById('loM').textContent='0';document.getElementById('loMsg').textContent='';render();};
  newPuzzle();
  CLEANERS.pipes=()=>{delete window._loN;delete window._loR;};
};

</script>
</body>
</html>
